
<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>TFT Helper Adventure Creator</title>
    </head>

    <body onLoad="initializeApp()" onClick="hideAll();" style = " font-family: Arial, Helvetica, sans-serif; overflow: hidden; background-color: var(--bgColor)" onbeforeunload="saveLocal()">

      <script src="badWords.js"></script>
      <script src="scrambler.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true, "theme":"forest"});</script>



    <script>


    // How to spell check finished HTML
    // document.body.contentEditable = true;
    // document.designMode = 'on';



    //        Establish Variables

    destinationTrue="";
    destinationFalse="";
    rememberedLocation="";
    lastLocation="";

    zeroVarDestination='';

    nodeAlphabetizement = false;

    branchesVisited = 0;

    currentScroll = -1;

    userInputCols = 80;

    variableArray = [];

    buttonDivRegEx = /^N\d+B\d+$/;

    targetTextArea = '';

    eventHolder='';
    activeElementHolder='';

    lastNodeContainerEvent = '';
    lastNodeContainerKey = '';
    lastNodeContainerModifier='';
    cursorPosition = 99999;

    postDestinationScroll = 0;

    currentlyActiveItem='';

    const CL = console.log.bind(document)

            function initializeApp() {

                document.getElementById("tab1").className += " active";
                testMode = 0;

                // document.getElementById('darkMode').checked = true;
                // switchDarkMode();

                if (typeof localStorage.colorMode == 'undefined') {
                  localStorage.colorMode = 'light';
                  document.querySelector('input[name="colorMode"][value="light"]').checked = true;
                } else {
                  document.querySelector('input[name="colorMode"][value= ' + localStorage.colorMode + ' ]').checked = true;
                }

                switchColorMode( localStorage.colorMode );

                if ( typeof localStorage.showWarnings == 'undefined' ) {

                  localStorage.showWarnings = 0;

                } else {

                  document.querySelector("#showWarnings").checked = ( localStorage.showWarnings > 0 ? true : false );

                }

                if ( typeof localStorage.showJSON == 'undefined' ) {

                  localStorage.showJSON = 0;
                  document.getElementById('jsonSection').style.display = 'none';

                } else {

                  document.querySelector("#showJSON").checked = ( localStorage.showJSON > 0 ? true : false );

                  document.getElementById('jsonSection').style.display = ( localStorage.showJSON > 0 ? 'block' : 'none' );

                }


                window.addEventListener('resize', resizeUserInputTextArea );

                setCurrentTime();

                currentLocationEdited = -1;

                variableArray = [];

                setInterval( setCurrentTime, 60000 );

                if ( localStorage.allowCookies == 1 ) {

                  document.getElementById('cookieStatus').innerText = 'localStorage is currently enabled.';

                } else {

                  document.getElementById('cookieStatus').innerText = 'localStorage is not currently enabled.';

                }

                adventureArray = [];

                deletedNodes = [];

                comparators = [
                  "< =",
                  "<=",
                  "=<",
                  ">=",
                  "=>",
                  "=",
                  "==",
                  "===",
                  "<",
                  ">",
                  "vs"
                ];

                charStrValue = 12;
                charAdjDexValue = 11;
                charDexValue = 12;
                charIntValue = 8;
                charMAValue = 10;
                charArmor = 0;
                charInjuryValue = 0;
                charFatigueValue = 0;
                charRace = 0;
                charType = 1;

                variableArray = [];

                variableArray.push( { 'varName':"ST", 'varValue':charStrValue, 'varType':'A' }  );
                variableArray.push( { 'varName':"DX", 'varValue':charDexValue, 'varType':'A' }  );
                variableArray.push( { 'varName':"AdjDX", 'varValue':charAdjDexValue, 'varType':'A' }  );
                variableArray.push( { 'varName':"IQ", 'varValue':charIntValue, 'varType':'A' }  );
                variableArray.push( { 'varName':"MA", 'varValue':charMAValue, 'varType':'A' }  );
                variableArray.push( { 'varName':"Armor", 'varValue':charArmor, 'varType':'A' }  );
                variableArray.push( { 'varName':"Injury", 'varValue':charInjuryValue, 'varType':'A' }  );
                variableArray.push( { 'varName':"Fatigue", 'varValue':charFatigueValue, 'varType':'A' }  );
                variableArray.push( { 'varName':"lastAction", 'varValue':0, 'varType':'A' }  );
                variableArray.push( { 'varName':"CharRace", 'varValue':charRace, 'varType':'A' }  );
                variableArray.push( { 'varName':"CharType", 'varValue':charType, 'varType':'A' }  );
                variableArray.push( { 'varName':"XPEarned", 'varValue':0, 'varType':'A' }  );

                raceArray = [ "Human", "Elf", "Dwarf", "Halfling", "Orc", "Goblin" ];

                armorTypes = [
                  "none",
                  "cloth",
                  "leather",
                  "chainmail",
                  "half plate",
                  "plate armor",
                  "fine plate",
                ];

                illegalVariableNames = [
                  "ST",
                  "DX",
                  "ADJDX",
                  "IQ",
                  "MA",
                  "ARMOR",
                  "INJURY",
                  "FATIGUE",
                  "CHARRACE",
                  "REMAININGST",
                  "XPEarned"
                ];

                weaponsArrayItems = 7;
                                // name, damage, minStr, skill, category, # hands, throwable (2=mandatory)
                weaponsArray = [    "bare hands","",0,0,0,0, 0,
                                    "Dagger", "1d-1", 1, 3, 1,  1, 1,
                                    "Main-Gauche","1d-1", 1, 3, 1, 1, 0,
                                    "Rapier","1d", 9, 4, 1, 1, 0,
                                    "Saber","2d-2", 10, 4, 1, 1, 0,
                                    "Shortsword","2d-1", 11, 4, 1, 1, 0,
                                    "Broadsword","2d", 12, 4, 1, 1, 0,
                                    "Bastard Sword","2d+1", 13, 4, 1, 1, 0,
                                    "2-handed Sword","3d-1", 14, 4, 1, 2, 0,
                                    "Club", "by ST", 1, 5, 2, 1, 1,
                                    "Hatchet", "1d", 9, 5, 2, 1, 1,   //  #10
                                    "Hammer", "1d+1", 10, 5, 2, 1, 1,
                                    "Mace", "2d-1", 11, 5, 2, 1, 1,
                                    "Small Axe", "1d+2", 11, 5, 2, 1, 1,
                                    "War Axe", "2d", 12, 5, 2, 1, 0,
                                    "Morningstar", "2d+1", 13, 5, 2, 1, 0,
                                    "Great Hammer", "2d+2",14, 5, 2, 2, 0,
                                    "Battleaxe", "3d", 15, 5, 2, 2, 0,
                                    "Javelin", "1d-1", 9, 6, 3, 1, 1,
                                    "Trident", "1d", 10, 6, 3, 1, 1,
                                    "Spear", "1d+1", 11, 6, 3, 2, 1,   //#20
                                    "Halberd", "2d", 13, 6, 3, 2, 0,
                                    "Pike Axe", "2d+2", 15, 6, 3, 2, 0,
                                    "Sling", "1d-2", 1, 7, 4, 1, 0,
                                    "Small Bow", "1d-1", 9, 7, 4, 2, 0,
                                    "Horse Bow", "1d", 10, 7, 4, 2, 0,
                                    "Long Bow", "1d+2", 11, 7, 4, 2, 0,
                                    "Light Crossbow", "2d", 12, 8, 4, 2, 0,
                                    "Heavy Crossbow", "3d", 15, 8, 4, 2, 0,
                                    "Small Shield", "-1 hit", 1, 9, 5, 1, 0,
                                    "Spiked Shield", "-1 hit", 1, 9, 5, 1, 0,  // #30
                                    "Large Shield", "-2 hits", 1, 9, 5, 1, 0,
                                    "Tower Shield", "-3 hits", 1, 9, 5, 1, 0,
                                    "Quarterstaff", "1d+2", 11, 31, 6, 2, 0,
                                    "Net", "1d-3", 10, 29, 6, 1, 1,
                                    "Cestus", "By ST", 1, 27, 6, 1, 0,
                                    "Whip", "1d-1", 8, 34, 6, 1, 0,
                                    "Lasso","1d+2", 8, 28, 6, 1, 1,
                                    "Boomerang", "2d-1", 11, 26, 6, 1, 2,
                                    "Nunchuks", "1d+1", 9, 30, 6, 1, 0,
                                    "Sha-ken", "1d-2", 7, 32, 6, 1, 2,   //#40
                                    "Bola", "1d+2", 9, 25, 6, 1, 2,
                                    "Spear Thrower", "1d-2", 8, 33, 6, 1, 0,
                                    "Wizard's Staff", "1d", 0, 0, 0, 1, 0
                               ]
                shieldsStartAt = 29;


                talentArrayItems = 5;

                talentArray = [ "uselessness", 7, 0, 0, 0,
                                "Brawling", 7, 1, 0, 10,
                                "Carousing", 7, 1, 0, 9,
                                "Knife", 7, 1, 0, 2,
                                "Sword", 7, 2, 0, 2,
                                "Ax/Mace", 7, 2, 0, 2,
                                "Pole Weapons", 7, 2, 0, 2,
                                "Bow", 7, 2, 0, 2,
                                "Crossbow", 7, 1, 0, 2,
                                "Shield", 7, 1, 0, 2,
                                "Area Knowledge", 8, 1, 0, 1, // #10
                                "Boating", 8, 1, 0, 6,
                                "Guns", 8, 2, 0, 3,
                                "Horsemanship", 8, 1, 0, 8,
                                "Literacy", 8, 1, 0, 1,
                                "A Trade", 8, 1, 0, 11,
                                "A Career", 8, 1, 0, 11,
                                "A Profession", 8, 1, 0, 11,
                                "Quick-Draw", 8, 1, 0, 4,
                                "Running", 8, 2, 0, 1,
                                "Seamanship", 8, 1, 0, 6, // #20
                                "Sex Appeal", 8, 1, 0, 9,
                                "Swimming", 8, 1, 0, 1,
                                "Thrown Weapons", 8, 2, 0, 4,
                                "Blowgun", 8, 1, 0, 3,
                                "Bola", 8, 1, 0, 3,
                                "Boomerang", 8, 1, 0, 3,
                                "Cestus", 8, 1, 0, 3,
                                "Lasso", 8, 1, 0, 3,
                                "Net and Trident", 8, 1, 0, 3,
                                "Nunchuks", 8, 1, 0, 3, // #30
                                "Quarterstaff", 8, 1, 0, 3,
                                "Sha-ken", 8, 1, 0, 3,
                                "Spear Thrower", 8, 1, 6, 3, // alternate Pre-req is 23
                                "Whip", 8, 1, 0, 3,
                                "Acute Hearing", 9, 2, 0, 5,
                                "Alertness", 9, 2, 0, 5,
                                "Animal Handler", 9, 2, 0, 8,
                                "Bard", 9, 2, 0, 9,
                                "Charisma", 9, 2, 0, 9,
                                "Climbing", 9, 1, 0, 1, // #40
                                "Detect Traps", 9, 2, 0, 5, //costs only 1 if you have 36
                                "Diving", 9, 1, 22, 1,
                                "Driver", 9, 1, 0, 8,
                                "Missile Weapons 1", 9, 1, 0, 4,
                                "Missile Weapons 2", 9, 1, 44, 4,
                                "Missile Weapons 3", 9, 1, 45, 4,
                                "Pickpocket", 9, 1, 0, 5,
                                "Priest", 9, 1, 0, 6,
                                "Recognize Value", 9, 1, 0, 11,
                                "Silent Movement", 9, 2, 0, 5,   //  #50
                                "Streetwise", 9, 1, 0, 9,
                                "Toughness 1", 9, 2, 0, 10,  // Str=12+
                                "Toughness 2", 9, 2, 52, 10, // Str=14+
                                "Acrobatics", 10, 2, 0, 6,  // Dex=12+
                                "Armourer", 10, 1, 0, 6,
                                "Business Sense", 10, 2, 0, 11,
                                "Diplomacy", 10, 1, 0, 9,
                                "Mimic", 10, 1, 0, 9,
                                "Naturalist", 10, 2, 0, 8,
                                "Poet", 10, 1, 0, 7,         //  #60
                                "Remove Trap", 10, 1, 41, 5,
                                "Shield Expertise", 10, 2, 9, 4,
                                "Tracking", 10, 1, 0, 8,
                                "Unarmed Combat I", 10, 1, 0, 10,
                                "Architect/Builder", 11, 1, 0, 6,
                                "Courtly Graces", 11, 1, 0, 9,
                                "Detect Lies", 11, 2, 0, 9,
                                "Expert Horsemanship", 11, 2, 13, 8,
                                "Fencer", 11, 3, 4, 4, // also Dex=12+
                                "Goldsmith", 11, 2, 49, 11,               // #70
                                "Locksmith", 11, 1, 0, 5,
                                "Master Pickpocket", 11, 1, 47, 5,
                                "Mechanician", 11, 2, 0, 11, // costs only 1 if you have 61
                                "Physicker", 11, 2, 0, 7,
                                "Shipbuilder", 11, 2, 20, 6,
                                "Tactics", 11, 1, 0, 7,
                                "Two Weapons", 11, 2, 0, 4, //also Dex=11+
                                "Unarmed Combat II", 11, 1, 64, 10, // also Dex=11+
                                "Vet", 11, 2, 0, 8,  // cost is half if you have 74
                                "Weapon Expertise", 11, 3, 0, 4, // Dex=12+           // #80
                                "Woodsman", 11, 1, 59, 8,
                                "Writing", 11, 1, 14, 1,
                                "Assess Value", 12, 1, 49, 11,
                                "Captain", 12, 2, 20, 6,
                                "Expert Naturalist", 12, 2, 59, 8,
                                "Master Armourer", 12, 2, 55, 6,
                                "Master Locksmith", 12, 1, 71, 5,    // also Dex=13+
                                "Stealth", 12, 2, 50, 5,
                                "Unarmed Combat III", 12, 2, 78,10,
                                "Ventriloquist", 12, 1, 0, 9,            //    #90
                                "Chemist", 13, 3, 0, 7,
                                "Master Fencer", 13, 3, 69, 4, // also Dex=14+
                                "Master Mechanician", 13, 2, 73, 11,
                                "Mathematician", 13, 2, 14, 7,
                                "Scholar", 13, 3, 14, 7,
                                "Strategist", 13, 2, 76, 7,
                                "Unarmed Combat IV", 13, 3, 89, 10,  // also Dex=13+, Str=11+
                                "Weapon Mastery", 13, 3, 80, 4,
                                "Alchemy", 14, 3, 0, 7,
                                "Disguise", 14, 2, 0, 9,       // #100
                                "Master Bard", 14, 2, 38, 9,
                                "Master Physicker", 14, 2, 74, 7,
                                "Theologian", 14, 2, 48, 6,
                                "Unarmed Combat V", 14, 4, 97, 10, // also Str=12+, Dex=14+
                                "Engineer",10,2,0,11


                ];

                spellArray = [  "Summon Cthulhu", "S, 1+2", 1, 0,
                                "Blur","T, 1+1", 8, 12,
                                "Detect Magic", "T, 1", 8, 9,
                                "Drop Weapon", "T, 1", 8, 5,
                                "Image", "C, 1", 8, 7,
                                "Light", "T, 1", 8, 1,
                                "Magic Fist", "M, 1 per 1d-2", 8, 3,
                                "Slow Movement", "T, 2", 8, 5,
                                "Staff", "S, 5", 8, 13,
                                "Aid", "T, 1", 9, 4,
                                "Avert", "T, 2+1", 9, 2,   ///  #10
                                "Clumsiness", "T, 1 per -2", 9, 5,
                                "Confusion", "T, 1 per -2", 9, 5,
                                "Dark Vision", "T, 3", 9, 4,
                                "Darkness", "S, 3", 9, 1,
                                "Detect Life", "S, 2", 9, 9,
                                "Fire", "C, 1", 9, 7,
                                "Look Your Best", "T, 1", 9, 10,
                                "Reveal Magic", "S, 1+1", 9, 9,
                                "Summon Scout", "C, 1+1", 9, 6,
                                "Summon Wolf", "C, 2+1", 9, 6,   //   #20
                                "Turn Missiles", "T, 1+1", 9, 12,
                                "Adhesion", "S, 1", 10, 8,
                                "Clearheadedness", "T, 1", 10, 4,
                                "Close Vision", "T, 1", 10, 4,
                                "Dazzle", "S, 3", 10, 5,
                                "Detect Enemies", "S, 3", 10, 9,
                                "Dispel Missiles", "T, 1+1", 10, 12,
                                "Far Vision", "T, 1", 10, 4,
                                "Lock/Knock", "T, 2", 10, 1,
                                "Meal", "C, 2 per", 10, 1,      //# 30
                                "Minor Medicament", "T, 2", 10, 1,
                                "Shadow", "C, 1", 10, 2,
                                "Shock Shield", "T, 2+1", 10, 2,
                                "Speed Movement", "T, 2", 10, 4,
                                "Staff to Snake", "T, 1", 10, 13,
                                "Stalwart","T, 3", 10, 4,
                                "Summon Myrmidon", "C, 2+1", 10, 6,
                                "Trail Twister", "S, 4", 10, 9,
                                "Trip", "T, 2", 10, 5,
                                "Ward", "S, 2", 10, 2,    //  #40
                                "Whisper", "T, 2", 10, 10,
                                "Acid Touch", "T, 1+1", 11, 4,
                                "Control Animal", "T, 2+1", 11, 8,
                                "Create Wall", "C, 2", 11, 7,
                                "Delete Writing", "T, 1", 11, 1,
                                "Destroy Creation", "T, 1", 11, 8,
                                "Ferment", "T, 2/6", 11, 10,
                                "Great Voice", "T, 1", 11, 10,
                                "Illusion", "C, 2", 11, 7,
                                "Persuasiveness", "T, 2+1", 11, 10,   //   #50
                                "Reveal/Conceal", "T, 2", 11, 9,
                                "Reverse Missiles", "T, 2+1", 11, 12,
                                "Rope", "C, 2", 11, 3,
                                "Scour", "T, 1", 11, 1,
                                "Silent Movement", "T, 1+1", 11, 1,
                                "Sleep", "T, 3", 11, 3,
                                "Staff II/Manastaff", "S, 5", 11, 13,
                                "Summon Bear", "C, 4+1", 11, 6,
                                "3-Hex Fire", "C, 2", 12, 7,
                                "3-Hex Shadow", "C, 2", 12, 7,   //    #60
                                "Analyze Magic", "T, 4", 12, 9,
                                "Blast", "S, 2", 12, 3,
                                "Break Weapon", "T, 3", 12, 5,
                                "Breathe Fire", "T, 1/3+1", 12, 3,
                                "Cleanse Poison", "T, 4", 12, 1,
                                "Drain Strength", "S, 0", 12, 8,
                                "Eyes-Behind", "T, 3+1", 12, 4,
                                "Fireball", "M, 1 per 1d-1", 12, 3,
                                "Freeze", "T, 4", 12, 3,
                                "Friendship", "S, 2/4", 12, 10,  //  #70
                                "Invisibility", "T, 3+1", 12, 2,
                                "Mage Sight", "T, 2+1", 12, 9,
                                "Magic Rainstorm", "C, 4", 12, 7,
                                "Pathfinder", "S, 3", 12, 9,
                                "Repair", "T, 6", 12, 8,
                                "Soothe", "T, 1", 12, 10,
                                "3-Hex Wall", "C, 4", 13, 7,
                                "4-Hex Image", "C, 2", 13, 7,
                                "Control Elemental", "T, 3+1", 13, 6,
                                "Control Person", "T, 3+1", 13, 10,   // #80
                                "Curse", "T, 2 per 1", 13, 5,
                                "Fireproofing", "T, 3+1", 13, 12,
                                "Flying", "T, 3+1", 13, 4,
                                "Open Tunnel", "T, 10", 13, 8,
                                "Scrying", "S, special", 13, 9,
                                "Slippery Floor", "T, 3", 13, 2,
                                "Staff III/Staff of Striking", "S, 5", 13, 13,
                                "Sticky Floor", "T, 3", 13, 2,
                                "Stone Flesh", "T, 2+1", 13, 12,
                                "Stop", "T, 3", 13, 5,    // #90
                                "Summon Gargoyle", "C, 4+1", 13, 6,
                                "Telekinesis", "T, 2", 13, 1,
                                "4-Hex Illusion", "C, 3", 14, 7,
                                "Dispel Illusions", "S, 5", 14, 8,
                                "Duplicate Writing", "T, 2", 14, 1,
                                "Explosive Gem", "S, 5/die", 14, 11,
                                "Fresh Air", "T, 2+1", 14, 11,
                                "Glamor", "T, 10", 14, 10,
                                "Lightning", "M, 1/1d", 14, 3,
                                "Remove Thrown Spell", "T, 2", 14, 8,   //  #100
                                "Restore Device", "T, 12/24", 14, 8,
                                "Spell Shield", "T, 3+1", 14, 12,
                                "Summon Giant", "C, 4+1", 14, 6,
                                "Summon Lesser Demon", "C, 20", 14, 6,
                                "Telepathy", "T, 4+1", 14, 10,
                                "Weapon/Armor<br>Enchantment", "T, special", 14, 11,
                                "7-Hex Image", "C, 4", 15, 7,
                                "7-Hex Shadow", "C, 3", 15, 7,
                                "Astral Projection", "S, 10", 15, 8,
                                "Calling", "S, 5", 15, 6,                // #110
                                "Create Gate", "C, 50+50", 15, 11,
                                "Giant Rope", "C, 5", 15, 3,
                                "Hammertouch", "T, 1/1d", 15, 4,
                                "Iron Flesh", "T, 3+1", 15, 12,
                                "Megahex Avert", "T, 3+1", 15, 2,
                                "Pentagram", "C, 5+1", 15, 13,
                                "Regeneration", "T, 30", 15, 4,
                                "Staff IV/Staff of Power", "S, 5", 15, 13,
                                "Teleport", "S, 1/megahex", 15, 1,
                                "Unnoticeability", "T, 3+1", 15, 4,   //  #120
                                "7-Hex Fire", "C, 4", 16, 7,
                                "7-Hex Illusion", "C, 5", 16, 7,
                                "7-Hex Wall", "C, 6", 16, 7,
                                "Create/Destroy<br>Elemental", "S, 5+1/Str or 10", 16, 6,
                                "Death Spell", "T, special", 16, 3,
                                "Long Distance Telepathy", "S, 12", 16, 10,
                                "Megahex Sleep", "T, 8", 16, 3,
                                "Summon Dragon", "C, 5+2", 16, 6,
                                "Trance", "S, 10", 16, 9,
                                "Write Scroll", "S, days", 16, 13,    //#130
                                "Blast Trap", "S, 6/12/24", 17, 2,
                                "Cleansing", "T, 20/hex", 17, 1,
                                "Diamond Flesh", "T, 4+1", 17, 12,
                                "Dissolve<br>Enchantment", "T, 50/100", 17, 11,
                                "Expunge", "S, 125/day", 17, 11,
                                "Geas", "S, 10", 17, 10,
                                "Insubstantiality", "T, 4+2", 17, 4,
                                "Remove Cursed Object", "T, 20", 17, 8,
                                "Staff V/Staff of Mastery", "S, 5", 17, 13,
                                "Spellsniffer", "T, 2+1", 17, 9,                //  #140
                                "Summon Demon", "C, 30", 17, 6,
                                "Little Death", "T, 4/10", 17, 8,
                                "Control Gate", "C, 10", 18, 11,
                                "Lesser Magic Item Creation", "S, special", 18, 11,
                                "Megahex Freeze", "T, 12", 18, 3,
                                "Shapeshifting", "T, 10/20", 18, 8,
                                "Wizard's Wrath", "M, 1 per 1d+1", 18, 3,
                                "Long Distance Teleport", "S, 20", 19, 1,
                                "Revival", "T, 50", 19, 13,
                                "Zombie", "T, 5+", 19, 11,   //  #150
                                "Greater Magical<br>Item Creation", "S, special", 20, 11,
                                "Possession", "S, 20", 20, 8,
                                "Word Of Command", "S, 3", 20, 10
                ];

                if ( typeof(localStorage.allowCookies) != 'undefined' ) {

                  document.getElementById('cookieBox').style.display='none';

                }

                for ( let i=0; i < talentArray.length; i+=5 ) {

                  nextTalent = talentArray[i].replace(/\s+/g,'');

                  illegalVariableNames.push( nextTalent );

                  variableArray.push( { 'varName':nextTalent, 'varValue':0, 'varType':'T' }  );

                }

                for ( let i=0; i < spellArray.length; i+=4 ) {

                  nextSpell = spellArray[i].replace(/\s+/g,'');

                  illegalVariableNames.push( nextSpell );

                  variableArray.push( { 'varName':nextSpell, 'varValue':0, 'varType':'S' }  );

                }

                nitty = 0;
                nittyParagraphs = document.getElementsByClassName('nitty');

                // var destinationTrue="";
                // var destinationFalse="";

                if( localStorage.allowCookies == 1 ) {

                  document.getElementById("userInputTextArea").value = localStorage.getItem( "userAdventure" );

                }

                document.getElementById("userInputTextArea").addEventListener( 'scroll', () => {

                  document.getElementById("lineNumbers").scrollTop = document.getElementById("userInputTextArea").scrollTop;

                });


                setHero( 0 );

//                reviewUserInput();

                textUpdate();


                document.getElementById('fileInput').addEventListener('change', handleFileChange);
                document.getElementById('fileInput').addEventListener('click', handleFileChange);


                if ( typeof localStorage.importedChar != "undefined" ) {

                    document.getElementById("otherCharTextArea").value = localStorage.importedChar;

                }

                showLoc();

            }


            function handleFileChange(event) {
                console.log('handleFileChange()');
                const file = event.target.files[0]; // Get the selected file
                if (!file) {
                    console.log("no file was selected");
                    return; // If no file is selected, do nothing
                }

                console.log( file );

                const reader = new FileReader(); // Create a FileReader object
                reader.onload = handleFileLoad;

                // Read the file as text
                reader.readAsText(file);
            }

            function handleFileLoad(e) {

              console.log( 'handleFileLoad()' );

                const content = e.target.result; // Get the file content

                document.getElementById('userInputTextArea').value = content; // Load content into the textarea

                console.log( content.split('\n')[0] );

                reviewUserInput();
                convertArrayToVisual();
            }



            function toggleNitty() {

              if ( nitty ) {
                nitty = 0;
    //            for ( i in nittyParagraphs ) nittyParagraphs[i].style.display='none';
                  for ( i=0; i<nittyParagraphs.length; i++ ) {
                  nittyParagraphs[i].style.display='none';
                }
                document.getElementById("nittyButton").innerHTML = "Show Nitty Gritty";
              } else {
                nitty = 1;

                // for ( i in nittyParagraphs ) { console.log(i); nittyParagraphs[i].style.display='block'; }

                for ( i=0; i<nittyParagraphs.length; i++ ) {
                  nittyParagraphs[i].style.display='block';
                }

                document.getElementById("nittyButton").innerHTML = "Hide Nitty Gritty";

              }


            }

            function showHelp(){

                document.getElementById("helpDiv").style.display="block";

            }
            // function hideHelp(){
            //
            //     document.getElementById("helpDiv").style.display="none";
            //
            //}
            function showSaveAdvice(){

                document.getElementById("saveAdviceDiv").style.display="block";

            }
            // function hideSaveAdvice(){
            //
            //     document.getElementById("saveAdviceDiv").style.display="none";
            //
            // }
            function showTestModeAdvice(){

                document.getElementById("testModeAdviceDiv").style.display="block";

            }
            // function hideTestModeAdvice(){
            //
            //     document.getElementById("testModeAdviceDiv").style.display="none";
            //
            // }
            function showSpecials(){

                document.getElementById("specialsHelpDiv").style.display="block";

            }
            // function hideSpecials(){
            //
            //     document.getElementById("specialsHelpDiv").style.display="none";
            //
            // }
            function showTypes(){

                document.getElementById("typesHelpDiv").style.display="block";

            }
            // function hideTypes(){
            //
            //     document.getElementById("typesHelpDiv").style.display="none";
            //
            // }
            function showComparisons(){

                document.getElementById("comparisonsHelpDiv").style.display="block";

            }
            // function hideComparisons(){
            //
            //     document.getElementById("comparisonsHelpDiv").style.display="none";
            //
            // }

            function showEgg( eggName ) {
              hideAll();
              document.getElementById( eggName ).style.display="block";
            }

            function gimmeFnord() {

              document.getElementById( 'illuminatiDiv' ).innerHTML = fnord();

            }

            function hideAll() {
              // hideHelp();
              // hideSaveAdvice();
              // hideTestModeAdvice();
              // hideTypes();
              // hideComparisons();
              // hideSpecials();

              itemsToHide = document.getElementsByClassName("hideMe");
              for ( i=0; i < itemsToHide.length; i++ ) {

                itemsToHide[i].style.display="none";

              }


            }


            function enterTemplate() {
//console.log('hi');
                document.getElementById("userInputTextArea").value = document.getElementById("basicTemplate").innerText;
            }

            function toadGodTemple() {

                document.getElementById("userInputTextArea").value = document.getElementById("toadGodTemple").innerText;
            }

            function ordinaryDungeon() {

                document.getElementById("userInputTextArea").value = document.getElementById("ordinaryDungeon").innerText;
            }


            function resizeUserInputTextArea() {

              if ( $('userInputTextArea').getBoundingClientRect().width > 0 ) {

                let spaceForCols = document.getElementsByClassName('TEinput')[0].getBoundingClientRect().width - $('lineNumbers').getBoundingClientRect().width * 2

                let pixelsPerCol = $('userInputTextArea').getBoundingClientRect().width /$('userInputTextArea').cols;

                userInputCols = parseInt( spaceForCols / pixelsPerCol );

                $('userInputTextArea').cols = userInputCols;

                reviewUserInput();

              }

            }


            function showPage( pageToShow ) {

              if ( document.getElementById( "page3" ).style.display == "block"  && pageToShow != 3 ) {

                saveLocal();

              } else if (document.getElementById( "page8" ).style.display == "block"  && pageToShow != 8) {

                visualEditorUpdate();
                saveLocal();

              }

              closeDialogBoxes();

                for ( i=1; i<11; i++ ) {

                    document.getElementById( "page" + i ).style.display="none";

                }


                if ( pageToShow == 1 ) {

                  document.getElementById( "page" + pageToShow ).style.display="flex";

                } else {

                  document.getElementById( "page" + pageToShow ).style.display="block";

                }

                if ( pageToShow == 3 ) {

                  resizeUserInputTextArea();

                }

                if ( pageToShow == 5 ) {
                  $('exportableTextArea').select();
                }

                if ( pageToShow == 10 ) {
                  generateFlowChart();
                }


                  // tablinks = document.getElementsByClassName("tabButton");
                  // for (i = 0; i < tablinks.length; i++) {
                  //   tablinks[i].className = tablinks[i].className.replace(" active", "");
                  // }
                  // event.currentTarget.className += " active";

                  tablinks = document.getElementsByClassName("tabButton");
                  for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].style.backgroundColor = 'grey';
                  }
//                  $('tab'+pageToShow).style.backgroundColor = $('page1').style.backgroundColor;
                  $('tab'+pageToShow).style.backgroundColor = 'var(--pageColor)';


            }

            function closeDialogBoxes() {

              $('addNewFoeDiv').style.display = 'none';
              $('createFirstLaterDiv').style.display = 'none';
              $('confirmationBox').style.display = 'none';
              $('undeleteNodeBox').style.display = 'none';


            }

            function setHero( heroChoice ) {

              for ( let i = 0; i < variableArray.length; i++ ) {

                if ( variableArray[ i ].varType == 'S' || variableArray[ i ].varType == 'T' ) {
                  variableArray[ i ].varValue = 0;
                }

              }

              switch ( heroChoice ) {
                case 0:
                  document.getElementById( 'simCharName' ).innerHTML = 'Test Fighter';
                  document.getElementById( 'simCharRaceType' ).innerHTML = "Human Hero";
                  charStrValue = 12;
                  charAdjDexValue = 9;
                  charDexValue = 12;
                  charIntValue = 8;
                  charMAValue = 6;
                  charArmor = 3;
                  charInjuryValue = 0;
                  charFatigueValue = 0;
                  charRace = 0;
                  charType = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SWORD' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'KNIFE' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'POLEWEAPONS' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SHIELD' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'LITERACY' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'NATURALIST' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'ALERTNESS' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'ARCHITECT/BUILDER' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SEAMANSHIP' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'CHARISMA' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'TRACKING' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SUMMONSCOUT' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'LIGHT' ).varValue = 0;
                  break;
                case 1:
                  document.getElementById( 'simCharName' ).innerHTML = 'Test Wizard';
                  document.getElementById( 'simCharRaceType' ).innerHTML = "Human Wizard" ;
                  charStrValue = 9;
                  charAdjDexValue = 12;
                  charDexValue = 12;
                  charIntValue = 11;
                  charMAValue = 12;
                  charArmor = 0;
                  charInjuryValue = 0;
                  charFatigueValue = 0;
                  charRace = 0;
                  charType = 2;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SWORD' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'KNIFE' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'POLEWEAPONS' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SHIELD' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'LITERACY' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'NATURALIST' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'ALERTNESS' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'ARCHITECT/BUILDER' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SEAMANSHIP' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'CHARISMA' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'TRACKING' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SUMMONSCOUT' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'LIGHT' ).varValue = 1;
                  break;
                case 2:

                  importHcobbCharacter();

                  localStorage.importedChar = document.getElementById("otherCharTextArea").value;

                  break;

                case 99:
                document.getElementById( 'simCharName' ).innerHTML = 'Not sure how you got here';
                  charStrValue = 10;
                  charAdjDexValue = 10;
                  charDexValue = 12;
                  charIntValue = 10;
                  charMAValue = 8;
                  charArmor = 2;
                  charInjuryValue = 0;
                  charFatigueValue = 0;
                  charRace = 2;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SWORD' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'KNIFE' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'POLEWEAPONS' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SHIELD' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'LITERACY' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'NATURALIST' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'ALERTNESS' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'ARCHITECT/BUILDER' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SEAMANSHIP' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'CHARISMA' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'TRACKING' ).varValue = 1;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'SUMMONSCOUT' ).varValue = 0;
                  variableArray.find( whatever => whatever.varName.toUpperCase() === 'LIGHT' ).varValue = 0;
                  break;
                default:
                  setHero(0);
                  break;
              }

            }

            //  how it works
            //  how it all works

            //  reviewUserInput()
            //  works its way through document.getElementById("userInputTextArea").value
            //  checks for bad words
            //  rebuilds adventureArray from scratch
            //  prepares report with line numbers for text editor tabButton
            //  pepares report with links for the visual editor tab
            //  prepares the simulator if adventuer is runnable
            //  calls generateExportable() if adventure is runnable

            //  when userInputTextArea is updated it calls textUpdate()
            //  which calls reviewUserInput() then calls convertArrayToVisual()

            //  when the Visual Editor updates it calls convertVisualEditorToString()
            //  which converts the VisEd to text, puts it into userInputTextArea
            //  then calls reviewUserInput

            function importHcobbCharacter() {

                console.log("starting importHcobbCharacter()");

                warn=0;
                probs=0;

                candidateCharArray = document.getElementById("otherCharTextArea").value.split("\n");

                // Name
                if ( candidateCharArray[0].length == 0 ) {

                    candidateCharArray[0] = "Name";
                    warn++;
                }

                candidateName = candidateCharArray[0].substring( 0 , Math.min( 18, candidateCharArray[0].length ) );

                // race
                candidateRace = "";
                switch ( candidateCharArray[1].substring(0,2).toLowerCase() ) {
                    case "hu":
                        candidateRace = 0;
                        break;
                    case "el":
                        candidateRace = 1;
                        break;
                    case "dw":
                        candidateRace = 2;
                        break;
                    case "ha":
                        candidateRace = 3;
                        break;
                    case "or":
                        candidateRace = 4;
                        break;
                    case "go":
                        candidateRace = 5;
                        break;
                    default:
                        probs++;
                }

                if ( candidateCharArray[1].search( "izard" ) > 0 ) {
                    candidateType = 2;
                } else {
                    candidateType = 1;
                }

                if ( candidateCharArray[2].length < 21 ) {
                    probs++;
                } else {

                    candidateStatArray = candidateCharArray[2].split(",");

                    if ( candidateStatArray.length !=4 ) {
                        probs++;
                    } else {

                        candidateStr = parseInt( candidateStatArray[0].substring(3,candidateStatArray[0].length) );
                        candidateDex = parseInt( candidateStatArray[1].substring(3,candidateStatArray[1].length) );
                        candidateInt = parseInt( candidateStatArray[2].substring(3,candidateStatArray[2].length) );

                    }
                }

                candidateTalentArray = [];
                listOfTalents = candidateCharArray[3].substring( 8, candidateCharArray[3].length );
                if ( listOfTalents.length > 0 ) {

                    importedTalentArray = listOfTalents.split(",");

                    for ( i=0; i < importedTalentArray.length; i++ ) {
                        for ( j = 0; j < talentArray.length; j += talentArrayItems ) {

                            if ( importedTalentArray[ i ].trim().toUpperCase() == talentArray[ j ].toUpperCase() ) {

                                candidateTalentArray.push( j / talentArrayItems );

                            }
                        }
                    }
                }

                candidateSpellArray = [];
                listOfSpells = candidateCharArray[4].substring( 7, candidateCharArray[4].length );
                if ( listOfSpells.trim().length > 0 ) {

                    importedSpellArray = listOfSpells.split(",");

                    for ( i=0; i < importedSpellArray.length; i++ ) {

                      importedSpellArray[i] = importedSpellArray[i].trim().toLowerCase();

                        for ( j = 4; j < spellArray.length; j += 4 ) {

//                          console.log( importedSpellArray[ i ] +"_"+ spellArray[ j ].toLowerCase() );

                            if ( importedSpellArray[ i ] == spellArray[ j ].toLowerCase() ) {

                                candidateSpellArray.push( j / 4 );

                            }
                        }
                    }
                }


                if ( candidateCharArray[5].indexOf(",") > 0 ) { // that means there are two weapons

//                    console.log( candidateCharArray[5].substring ( 9 , candidateCharArray[5].indexOf( " (" )  ) + "X" );
                    candidateWeapon1 = findWeapon( candidateCharArray[5].substring ( 9 , candidateCharArray[5].indexOf( " (" )  ) );

                    secondHalf = candidateCharArray[5].substring ( candidateCharArray[5].search(",") + 2, candidateCharArray[5].length );

//                    console.log( secondHalf.substring( 0, secondHalf.indexOf( " (" ) ) + "X" );
                    candidateWeapon2 = findWeapon( secondHalf.substring( 0, secondHalf.indexOf( " (" ) ) );

                } else if ( candidateCharArray[5].indexOf("(") > 0 ) { // that means there is one weapon

                    candidateWeapon1 = findWeapon( candidateCharArray[5].substring ( 9 , candidateCharArray[5].indexOf(" (")  ) );

                    candidateWeapon2 = 0;

                } else { // there are no weapons

                    candidateWeapon1=0;
                    candidateWeapon2=0;

                }


                candidateArmor = 0;
                switch ( candidateCharArray[7].substring(7,9).toUpperCase() ) {
                    case "CL":
                        candidateArmor = 1;
                        break;
                    case "LE":
                        candidateArmor = 2;
                        break;
                    case "CH":
                        candidateArmor = 3;
                        break;
                    case "HA":
                        candidateArmor = 4;
                        break;
                    case "PL":
                        candidateArmor = 5;
                        break;
                    case "FI":
                        candidateArmor = 6;
                        break;
                    default:
                }

                // new 3/12/21
                if ( candidateCharArray[8].substring(0,10) == "Equipment:" ) {

                    candidateEquip = candidateCharArray[8];

                } else {

                    warn++;
                    candidateEquip = "Equipment: " + candidateCharArray[8];

                }
                if ( candidateCharArray[9].substring(0,13) == "Special Note:" ) {

                    candidateNotes = candidateCharArray[9];

                } else {

                    warn++;
                    candidateNotes = "Notes: " + candidateCharArray[9];

                }
                // end new material

                if ( probs == 0 ) {

                    if ( warn > 0 ) {
                        magicMessage("There were "+warn+" anomalies in the string. Please check this character carefully. Expect unexpected results.")
                    }

                    charRace = candidateRace;

                    charType = candidateType;

                    charStrValue = candidateStr;

                    charDexValue = candidateDex;

                    charIntValue = candidateInt;

                    charTalentArray = candidateTalentArray;


                    lowerCaseImportedTalentArray = importedTalentArray.map(name => name.trim().toLowerCase() );

                    variableArray.forEach( x => { if ( x.varType == 'T' ) { x.varValue = 0 } } );

                    variableArray.forEach( x => {

                      if ( lowerCaseImportedTalentArray.includes( x.varName.toLowerCase() ) ) {

                        x.varValue = 1;

                      }


                    });

                    charSpellArray = candidateSpellArray;

                    variableArray.forEach( x => { if ( x.varType == 'S' ) { x.varValue = 0 } } );

                    variableArray.forEach( x => {

                      if ( importedSpellArray.includes( x.varName.toLowerCase() ) ) {

                        x.varValue = 1;

                      }


                    });

                    document.getElementById( 'simCharName' ).innerHTML = candidateName;
                    document.getElementById( 'simCharRaceType' ).innerHTML = raceArray[ charRace ] + " " + ( charType == 2 ? "Wizard" : "Hero" );


                    charSpellArray = candidateSpellArray;

                    charWeapon1 = candidateWeapon1;
                    charWeapon2 = candidateWeapon2;
                    charArmor= candidateArmor;

                    // end new material

                } else {
                    magicMessage("That's not a valid character export, it can't be imported.");
                }
            }

            function findWeapon( weaponNameToSearchFor ) {

                for ( i = 0; i < weaponsArray.length; i += weaponsArrayItems ) {
                    if ( weaponNameToSearchFor == weaponsArray[ i ] ) {
                        return ( i/weaponsArrayItems );
                    }
                }

                return( 0 );

            }


            function reviewUserInput() {

//              console.log( "Start of reviewUserInput()" );
//              console.log( 'userInputTextArea is ' + $('userInputTextArea').value.split('\n').length + " lines long.");
              // console.time('rui');
              // console.time('pre userLines loop');

              // console.log('======================');
              // console.log(document.getElementById("userInputTextArea").value);
              // console.log('======================');

              // if ( typeof ( adventureArray[0].toDo ) != 'undefined' ) {
              //   console.log( adventureArray[0].toDo );
              // }

              adventureArray = [];
              missingLocations = [];

              varsUsedInText = [];
              varsUsedInBranches = [];

              warnings = [];

              variableArray.find( whatever => whatever.varName.toUpperCase() === 'ST' ).varValue = charStrValue;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'DX' ).varValue = charDexValue;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'ADJDX' ).varValue = charAdjDexValue;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'IQ' ).varValue = charIntValue;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'MA' ).varValue = charMAValue;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'ARMOR' ).varValue = charArmor;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'INJURY' ).varValue = charInjuryValue;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'FATIGUE' ).varValue = charFatigueValue;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'LASTACTION' ).varValue = 0;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'CHARRACE' ).varValue = charRace;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'CHARTYPE' ).varValue = charType;
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'XPEARNED' ).varValue = 0;

    //console.log( "variableArray.length = " + variableArray.length ) ;

              // for ( let i = 0; i<variableArray.length; i++ ) {
              //   if (variableArray[i].varType == "U" ) {
              //     variableArray.splice( i, 1 );
              //   }
              // }

              variableArray = variableArray.filter( whatever => whatever.varType!='U' );

    //console.log( "variableArray.length = " + variableArray.length ) ;

              document.getElementById("locationsDiv").innerHTML = "";
              document.getElementById("editorNodeListDiv").innerHTML = "<a href='#editorBasicInfoDiv' style='text-decoration: none; color: black; background-color: lightblue'>Basic Info</a><br>";

              $('locDiv').innerHTML = '<span onclick="uiteTop()">(top)</span><br>';

              userLines = document.getElementById("userInputTextArea").value.split("\n");

              // line numbers!
              document.getElementById('lineNumbers').value = '';
              for ( let i = 0; i < userLines.length; i++ ) {
                document.getElementById('lineNumbers').value += (i+1);

                for ( let j = 0; j <= Math.floor( userLines[i].length / userInputCols ); j++ ) {
                  document.getElementById('lineNumbers').value += '\n';
                }

                // while we're doing a preliminary loop
                // we kill html by sticking a space after any '<'
                // and get rid of extra spaces that could cause trouble
//                userLines[i] = userLines[i].replace(/</g,"< ").trim();
                  userLines[i] = userLines[i].replace(/<(?!\s)/g, "< ").trim();
              }

              // //first, we kill html 2/26/22
              // // and get rid of trailing spaces (5/14/22)
              // for ( let i = 0; i < userLines.length; i++ ) {
              //   userLines[i] = userLines[i].replace(/</g,"< ").trim();
              // }

              reviewResults = "";
              problemsFound = 0;

              editorReportStr = "";

              titleStr="";
              multTitleWarn = 0;

              creatorStr="";
              multCreatorWarn = 0;

              descriptionStr="";
              multDescriptionWarn = 0;

              testMode = 0;
              multTestWarn = 0;

              maxAttr = 0;
              multMaxAttrWarn = 0;

              atLeastOneLocation = 0;

              firstLocation = "";

              placesWeTryToGo = [];
              placesWeCanGo = [ 'return', 'lastlocation' ];

              foesThatExist = [];
              foesWeTryToRemove = [];
              foesWeHaveRemoved = [];
              whatTypeOfTermIsRemoved = [];

              prefixString = 'something went wrong';

              // console.time('building links for editor and checking for bad words loop');

              for ( currentLine=0; currentLine < userLines.length; currentLine++ ) {

                  //we need a link with the node name for the editor report
                  switch ( userLines[currentLine].substr(0,3) ) {

                    case '@lo':
                      nodeNameLink = "<a href='#editorNode" + userLines[currentLine].substring(10,99).trim().toLowerCase() + "'>" + userLines[currentLine].substring(10,99).trim().toLowerCase() + "</a>";
                      break;

                    case '@br':
                      nodeNameLink = "<a href='#editorNode" + userLines[currentLine].substring(8,99).trim().toLowerCase() + "'>" + userLines[currentLine].substring(8,99).trim().toLowerCase() + "</a>";
                      break;

                    case '@fo':
                      nodeNameLink = "<a href='#editorNode" + userLines[currentLine].substring(5,99).trim().toLowerCase() + "'>" + userLines[currentLine].substring(5,99).trim().toLowerCase() + "</a>";
                      break;

                  }

                switch ( userLines[currentLine].substr(0,3) ) {

                  case '@lo':
                    prefixString = "The location " + nodeNameLink + " contains the word ";
                    break;

                  case '@br':
                    prefixString = "The branch " + nodeNameLink + " contains the word ";
                    break;

                  case '@fo':
                    prefixString = "The foe " + nodeNameLink + " contains the word ";
                    break;

                }

//                badWordReport = 'okay';
                badWordReport = includesBadWords( userLines[currentLine] );

                if ( badWordReport != "okay" ) {

//                  console.log( currentLine + " " + badWordReport );
                  reviewResults += "Line " + (currentLine+1) + " includes the word " + badWordReport + " which some may find offensive. You'll need to reword this line to generate an exportable.<br>";

                  editorReportStr += prefixString + badWordReport + " which some may find offensive. You'll need to reword this line to generate an exportable.<br>";

                  problemsFound++;

                }
              }

//              console.timeEnd('building links for editor and checking for bad words loop');

//              console.timeEnd('pre userLines loop');

              // console.time("looping through userLines");


              for ( currentLine=0; currentLine < userLines.length; currentLine++ ) {

                figuredThisLineOut = 0;
    //            console.log( "adventureArray.length = " + adventureArray.length );

                  //we need a link with the node name for the editor report
                  switch ( userLines[currentLine].substr(0,3) ) {

                    case '@lo':
                      nodeNameLink = "<a href='#editorNode" + userLines[currentLine].substring(10,99).trim().toLowerCase() + "'>" + userLines[currentLine].substring(10,99).trim().toLowerCase() + "</a>";
                      break;

                    case '@br':
                      nodeNameLink = "<a href='#editorNode" + userLines[currentLine].substring(8,99).trim().toLowerCase() + "'>" + userLines[currentLine].substring(8,99).trim().toLowerCase() + "</a>";
                      break;

                    case '@fo':
                      nodeNameLink = "<a href='#editorNode" + userLines[currentLine].substring(5,99).trim().toLowerCase() + "'>" + userLines[currentLine].substring(5,99).trim().toLowerCase() + "</a>";
                      break;

                  }
                // for ( currentLine=0; currentLine < userLines.length; currentLine++ ) {

                  switch ( userLines[currentLine].substr(0,3) ) {

                    case '@lo':
                      prefixString = "The location " + nodeNameLink + "  ";
                      break;

                    case '@br':
                      prefixString = "The branch " + nodeNameLink + "  ";
                      break;

                    case '@fo':
                      prefixString = "The foe " + nodeNameLink + "  ";
                      break;

                  }


                // TITLE check
                if ( userLines[currentLine].substr(0,6).toLowerCase() == "@title" ) {

                  figuredThisLineOut = 1;

                  if ( titleStr == "" ) {

                    titleStr = userLines[currentLine].substring( 7, userLines[currentLine].length );

                    if ( titleStr.length > 32 ) {

                      titleStr = titleStr.substr( 0, 32 );

                      reviewResults += "The title is " + titleStr.length + " characters long, and will be truncated to \"" + titleStr + "\" (32 characters).<br>";
                      editorReportStr += "The title is " + titleStr.length + " characters long, and will be truncated to \"" + titleStr + "\" (32 characters).<br>";
                    }
                  } else {
                    if ( multTitleWarn == 0 ) {
                      multTitleWarn = 1;
                      reviewResults += "There is more than one @title line, only the first will be used.<br>";
                      editorReportStr += "There is more than one @title line, only the first will be used.<br>";
                    }
                  }
                } // end of @title

                // CREATOR check
                if ( userLines[currentLine].substr(0,8).toLowerCase() == "@creator" ) {

                  figuredThisLineOut = 1;

                  if ( creatorStr == "" ) {

                    creatorStr = userLines[currentLine].substring( 9, userLines[currentLine].length );

                    if ( creatorStr.length > 30 ) {

                      creatorStr = creatorStr.substr( 0, 30 );

                      reviewResults += "The creator line is " + creatorStr.length + " characters long, and will be truncated to \"" + creatorStr + "\" (30 characters).<br>";
                    }
                  } else {
                    if ( multCreatorWarn == 0 ) {
                      multCreatorWarn = 1;
                      reviewResults += "There is more than one @creator line, only the first will be used.<br>";
                      editorReportStr += "There is more than one @creator line, only the first will be used.<br>";
                    }
                  }
                } // end of @creator

                // DESCRIPTION check
                if ( userLines[currentLine].substr(0,12).toLowerCase() == "@description" ) {

                  figuredThisLineOut = 1;

                  if ( descriptionStr == "" ) {

                    descriptionStr = userLines[currentLine].substring( 13, userLines[currentLine].length );

                    if ( descriptionStr.length > 51 ) {

                      descriptionStr = descriptionStr.substr( 0, 51 );

                      reviewResults += "The description line is " + descriptionStr.length + " characters long, and will be truncated to \"" + descriptionStr + "\" (51 characters).<br>";
                      editorReportStr += "The description line is " + descriptionStr.length + " characters long, and will be truncated to \"" + descriptionStr + "\" (51 characters).<br>";
                    }
                  } else {
                    if ( multDescriptionWarn == 0 ) {
                      multDescriptionWarn = 1;
                      reviewResults += "There is more than one @description, only the first will be used.<br>";
                      editorReportStr += "There is more than one @description, only the first will be used.<br>";
                    }
                  }
                } // end of @description

                // TEST MODE check
                if ( userLines[currentLine].substr(0,9).toLowerCase() == "@testmode" ) {

                  figuredThisLineOut = 1;

                  if ( testMode == 0 ) {

                    testMode = 1;

                  } else {
                    if ( multTestWarn == 0 ) {
                      multTestWarn = 1;
                      reviewResults += "Test mode is activated more than once, be sure to remove them all when the time comes to share your creation.<br>";
                      editorReportStr += "Test mode is activated more than once, be sure to remove them all when the time comes to share your creation.<br>";
                    }
                  }
                } // end of @title

                // MAX LEVEL check
                if ( userLines[currentLine].substr(0,14).toLowerCase() == "@maxattributes" ) {

                  figuredThisLineOut = 1;

                  if ( maxAttr == 0 ) {

                    maxAttr = parseInt( userLines[currentLine].substring( 14, userLines[currentLine].length ) );

                    if ( maxAttr < 30 ) {
                      reviewResults += "Basic characters in The Fantasy Trip start with 32 attribute points, except for Halflings who start with 30. Your max attributes is lower than this. You should consider designing your adventure for characters between 32 and 38 attribute points.<br>";
                      editorReportStr += "Basic characters in The Fantasy Trip start with 32 attribute points, except for Halflings who start with 30. Your max attributes is lower than this. You should consider designing your adventure for characters between 32 and 38 attribute points.<br>";
                    } else if ( maxAttr > 40 ) {
                      reviewResults += "Characters with over 40 attribute points are very powerful and will probably require more rules than are implemented in TFT Helper. You should consider designing your adventure for characters between 32 and 38 attribute points.<br>";
                      editorReportStr += "Characters with over 40 attribute points are very powerful and will probably require more rules than are implemented in TFT Helper. You should consider designing your adventure for characters between 32 and 38 attribute points.<br>";
                    }

                  } else {
                    if ( multMaxAttrWarn == 0 ) {
                      multMaxAttrWarn = 1;
                      reviewResults += "Max attributes is set more than once. Only the first entry will be used.<br>";
                      editorReportStr += "Max attributes is set more than once. Only the first entry will be used.<br>";
                    }
                  }
                } // end of @maxLevel

                //Initializing a variable
                if ( userLines[currentLine].substr(0,1) == "^" && atLeastOneLocation == 0 ) {
    //console.log("initializng var: " + userLines[currentLine] );

                  figuredThisLineOut = 1;
                  newVarSuccess = 1;


                  let newVarLine = userLines[currentLine].substr(1,999).split(" ").join("");

                  // newVarName = newVarLine.substr(0,newVarLine.indexOf('=')).substr(0,20).replace(/[^a-zA-Z0-9]/g, '');

                  newVarZeroDestination = newVarLine.split('->')[1];
                  if ( newVarZeroDestination === undefined ) {
                    newVarZeroDestination = '';
                  }

                  newVarZeroDestination = newVarZeroDestination.trim();

                  newVarLine = newVarLine.split('->')[0];

                  newVarName = newVarLine.substr(0,newVarLine.indexOf('=')).replace(/[^a-zA-Z0-9]/g, '');
                  newVarValue = newVarLine.substr(newVarLine.indexOf('=')+1,999);

                  if ( newVarLine.indexOf("=") == -1 || newVarName.length == 0  || newVarValue.length == 0 ) {

                    reviewResults += "Line " + (currentLine+1) + ": looks like an incomplete variable declaration '.<br>";
                    editorReportStr += prefixString + ": looks like an incomplete variable declaration '.<br>";
                    newVarSuccess = 0;

                  } else {

    // console.log("New Var! "+newVarName+" -> "+newVarValue);

                    //check if var name is legit

                    for ( let i=0; i<illegalVariableNames.length; i++ ) {

                      if ( newVarName == illegalVariableNames[i] ) {

                        reviewResults += "Line " + (currentLine+1) + ": you can't name a variable '"+newVarName+"'.<br>";
                        editorReportStr += "You can't name a variable '"+newVarName+"'.<br>";
                        newVarSuccess = 0;

                      }

                    }

                    if ( "ABCDEFGHIJKLMONPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".indexOf(newVarName.substr(0,1)) < 0 ) {

                      reviewResults += "Line " + (currentLine+1) + ": variable names must start with a letter.<br>";
                      editorReportStr += "Variable names must start with a letter.<br>";
                      newVarSuccess = 0;

                    }

                    for (varNamePos=1;varNamePos<newVarName.length;varNamePos++){

                      if ( "ABCDEFGHIJKLMONPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".indexOf(newVarName.substr(varNamePos,1)) < 0 ) {
                        reviewResults += "Line " + (currentLine+1) + ": variable names may only use letters and numbers.<br>";
                        editorReportStr += "Variable names may only use letters and numbers.<br>";
                        newVarSuccess = 0;
    //   ?                 break;
                      }


                    }

                    //check if var name is repeated

                    if ( typeof variableArray.find( whatever => whatever.varName.toUpperCase() === newVarName.toUpperCase() ) != 'undefined' ) {

                      reviewResults += "Line " + (currentLine+1) + ": variable named " + newVarName + " already exists.<br>";
                      editorReportStr += "A variable named " + newVarName + " already exists.<br>";
                      newVarSuccess = 0;
    //    ?              break;

                    }


                    // early code that only works for numbers
                    // if ( isNaN(newVarValue) ) {
                    //
                    //   reviewResults += "Line " + (currentLine+1) + ": the right side of the = is not a number .<br>";
                    //   newVarSuccess = 0;
                    //
                    // }

                    if ( securityCheck( newVarValue) ) {

                      rawVariableInitiator =  newVarValue;
                      newVarValue = evaluateString( newVarValue );

                    } else {
                      newVarSuccess = 0;
                    }

                    if ( newVarSuccess == 1 && isNaN(newVarValue) ) {

                      reviewResults += "Line " + (currentLine+1) + ": can't understand assigned value for variable named " + newVarName + ".<br>";
                      editorReportStr += "Can't understand assigned value for variable named " + newVarName + ".<br>";
                      newVarSuccess = 0;
                      break;

                    }


                    // if nothing is wrong we push the new variable onto the array
                    if ( newVarSuccess > 0 ) {
    //                  console.log( "Line " + currentLine + " - created variable " + newVarName + " with value " + newVarValue + ".<br>");

                      // add varname and value to array

                      if ( newVarZeroDestination != '' && rawVariableInitiator <= 0 ) {

                        reviewResults += "Line " + (currentLine+1) + " declares a zero destination variable named " + newVarName + " but it is initialized to zero or less, which means that it will be triggered immediately. That will work, but it's probably not what you want.<br>";
                        editorReportStr += "You declared a zero destination variable named " + newVarName + " but it is initialized to zero or less, which means that it will be triggered immediately. That will work, but it's probably not what you want.<br>";


                      }

                      variableArray.push( { 'varName':newVarName, 'varValue':newVarValue, 'varType':'U', 'varInitiator':rawVariableInitiator, 'varZeroDestination': newVarZeroDestination }  );

                      if ( newVarZeroDestination !== '' ) {

//                        console.log(newVarZeroDestination);

                        placesWeTryToGo.push( 'z^' + newVarName + '^' + newVarZeroDestination );

                      }

                      // fetch with variableArray.find( whatever => whatever.varName==='FOODREMAINING').varValue

                      // sort array so "cats" won't be read for "cat"
                      variableArray = variableArray.sort( (a,b) => b.varName.length - a.varName.length)

                    } else {
                      console.log( "Line " + currentLine + " - failed to create variable " + newVarName + " with value " + newVarValue + ".");
                    }

                  }
                }  // end of new variable

                // Are we starting a location? We build a new entry for the adventureArray
                if ( userLines[currentLine].substr(0,9).toLowerCase() == "@location" ) {

                  atLeastOneLocation = 1;

                  figuredThisLineOut = 1;

                  locationNameString = userLines[currentLine].substr(10,userLines[currentLine].length).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

                  if ( locationNameString == 'return' ) {

                    reviewResults += "Line " + (currentLine+1) + ": you can't name a location 'return'. <br>";
                    editorReportStr += "You can't name a location 'return'. <br>";
                    problemsFound++;


                  } else if ( locationNameString == 'lastlocation' ) {

                    reviewResults += "Line " + (currentLine+1) + ": you can't name a location 'lastlocation'. <br>";
                    editorReportStr += "You can't name a location 'lastlocation'. <br>";
                    problemsFound++;


                  } else if ( placesWeCanGo.indexOf(locationNameString) > -1 ) {
                    reviewResults += "Line " + (currentLine+1) + ": There is more than one location, branch, or foe named '" + locationNameString + "'.<br>";
                    editorReportStr += "There is more than one location, branch, or foe named '" + locationNameString + "'.<br>";
                    problemsFound++;
                  } else {
                      placesWeCanGo.push( locationNameString );
                  }

                  if ( firstLocation == "" ) {
                    firstLocation = locationNameString;
                  }

    //              console.log( locationNameString );

                  thisLocation = {
                    type: "l",
                    name: locationNameString,
                    toDo: [],
                    html: "",
                    writing: ""
                  };


                  newLocationButton  = "<span onclick='adventureGo(";
                  newLocationButton += '\"' + locationNameString + '\"';
                  newLocationButton += ")''>(L) " + locationNameString + "</span><br>";

                  document.getElementById("locationsDiv").innerHTML += newLocationButton;

                  newEditorShortCut = "<a href='#editorNode" + locationNameString + "' style='text-decoration: none; color: black; background-color: #cec'>";

                  newEditorShortCut += "(L)&nbsp;" + locationNameString + "</a><br>";

                  $('editorNodeListDiv').innerHTML += newEditorShortCut;

                  newTELocButton = "<span onclick='scrollTE(\"" + locationNameString + "\")'>";
                  newTELocButton += '(L) ' + locationNameString + "</span><br>";
                  $('locDiv').innerHTML += newTELocButton;

                  while ( currentLine < userLines.length - 1
                    && userLines[currentLine + 1].substr(0,9).toLowerCase() != "@location"
                    && userLines[currentLine + 1].substr(0,7).toLowerCase() != "@branch"
                    && userLines[currentLine + 1].substr(0,4).toLowerCase() != "@foe" ) {

                      if ( userLines[currentLine + 1].substr(0,7).toLowerCase() == "@button" ) {

                        buttonDestination = userLines[currentLine + 1].substring( 8, userLines[ currentLine + 1 ].length).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

                        if ( userLines.length > currentLine + 2 ) {

                          buttonText = userLines[ currentLine + 2 ].substr(0,35);
                          if ( userLines[ currentLine + 2 ].length > 35 ) {
                            reviewResults += "Button text on line " + (currentLine + 1) + " is over 35 characters and will be truncated to '" + buttonText + "'.<br>";
                            editorReportStr += prefixString + "has a button with a label over 35 characters which will be truncated to '" + buttonText + "'.<br>";
                          } else if ( buttonText.trim().length == 0 ) {
                            reviewResults += "Button text on line " + (currentLine + 1) + " has no label. That will work but it's going to be confusing.<br>";
                            editorReportStr += prefixString + "has a button with no label. That will work but it's going to be confusing.<br>";
                          }
                        }

                        buttonText = breakHTML( buttonText );

                        placesWeTryToGo.push( "l^" + thisLocation.name + "^" + buttonDestination );

                        buttonString = "<div class='adventureButton' onclick = 'adventureGo(";
                        buttonString += '"' + buttonDestination + '"';
                        buttonString += ")'>" + buttonText;
                        // buttonString += "</div><br>";
                        buttonString += "</div>";

                        thisLocation.html += buttonString;

                        currentLine += 1;

                      } else if ( userLines[currentLine + 1].substr(0,8).toUpperCase() == "@WRITING" ) {

                        thisLocation.writing = userLines[currentLine + 1].substr(9,9999);
                        thisLocation.toDo.push('@writing');

                      } else if ( userLines[currentLine + 1].substr(0,7).toUpperCase() == "@DAMAGE" ) {

                        parsed = userLines[currentLine + 1].split(' ');

//                      new version 2/23/23 that allows formulas with spaces for damage
//                      first, parsed[parsed.length] should be a valid location name
//                                 or give error message
//                      second, string of parsed[ 1 to length-1 ] should be a valid expression
//                      third, add to array, push to placesWeTryToGo

                        if ( parsed.length < 3 ) {

                          reviewResults += "Line " + (currentLine + 2) + " doesn't make sense. An @DAMAGE line should have an amount of damage and a location to go to if this damage finishes off the character.<br>";
                          editorReportStr += prefixString + "has a @DAMAGE line that doesn't make sense. An @DAMAGE line should have an amount of damage and a location to go to if this damage finishes off the character.<br>";
                          problemsFound++;

                        } else {

                          // console.log(userLines[currentLine + 1]);
                          damageString = userLines[currentLine + 1].substring( 8, userLines[currentLine + 1 ].lastIndexOf(' ') );

                          // new 9/16/23
                          damageString = damageString.replace(/ +/g, "");

                          if ( evaluateString( damageString ) == -2323 ) {

                            reviewResults += "The amount of damage on line " + (currentLine + 2) + " doesn't make sense.<br>";
                            editorReportStr += prefixString + "has a @DAMAGE with an amount that doesn't make sense. <br>";
                            problemsFound++;

                          }

                        }

//                        console.log( removeNonAlphaNumericFromLastWord(userLines[currentLine + 1])  );
//                        thisLocation.toDo.push( removeNonAlphaNumericFromLastWord(userLines[currentLine + 1]) );
                        //new 9/16/23 (replacing the above)
//                        console.log( "@damage " + damageString + " " + parsed[ parsed.length - 1 ] );
                        thisLocation.toDo.push( "@damage " + damageString + " " + parsed[ parsed.length - 1 ] );

                        if ( parseInt( damageString) == 0 ) {
                          warnings.push( "The @damage action on line " + (currentLine + 2) + " seems to do no damage.")
                        }

                        placesWeTryToGo.push( "d^" + thisLocation.name + "^"
                          + userLines[currentLine + 1].substring( userLines[currentLine + 1 ].lastIndexOf(' ') + 1, 9999 ) );

                      } else if ( userLines[currentLine + 1].substr(0,5).toUpperCase() == "@HEAL" ) {

                        if ( evaluateString( userLines[currentLine + 1].substr(6,9999) ) == -2323 ) {

                          reviewResults += "The amount of healing on line " + (currentLine + 1) + " doesn't make sense.<br>";
                          editorReportStr += prefixString + "has an amount of healing that doesn't make sense.<br>";

                        } else {

                          thisLocation.toDo.push( userLines[currentLine + 1] );

                          if ( parseInt( userLines[currentLine + 1].substr(6,9999) ) == 0 ) {
                            warnings.push( "The @@heal action on line " + (currentLine + 2) + " seems to do nothing.")
                          }

                        }

                      } else if ( userLines[currentLine + 1].substr(0,9).toUpperCase() == "@REMEMBER" ) {

                        let words = userLines[currentLine + 1].split(' ');

                        if ( words.length > 1 ) {

                          let locToRemember = words[1].toLowerCase();

                          if ( words.length > 2 ) {

                            reviewResults += "The @Remember statement on line " + (currentLine + 1) + " has some text after the target location; this text will be ignored.<br>";
                            editorReportStr += prefixString + "has @Remember statement with extraneous text.<br>";

                          }

//                          placesWeTryToGo.push( 'r^' + thisLocation.name + '^' + words[ words.length - 1 ] );
                          placesWeTryToGo.push( 'r^' + thisLocation.name + '^' + locToRemember );

//                          if ( words[ words.length - 1 ].toLowerCase() == 'return' ) {
                          if ( locToRemember == 'return' ) {

                            reviewResults += "The @Remember statement on line " + (currentLine + 1) + " tries to remember 'return', which is not allowed.<br>";
                            editorReportStr += prefixString + "has @Remember statement that tries to remember 'return', which is not allowed.<br>";
                            problemsFound++;

                          }

                        } else {

                          reviewResults += "The @Remember statement on line " + (currentLine + 1) + " doesn't include a location to remember.<br>";
                          editorReportStr += prefixString + "has @Remember that doesn't include a location to remember.<br>";
                          problemsFound++;

                        }

                        thisLocation.toDo.push( userLines[currentLine + 1] );


                      } else if ( userLines[currentLine + 1].substr(0,5).toUpperCase() == "@REST" ) {


//                        console.log("adding @rest to node " + adventureArray.length + " at text line " + (currentLine + 1) );

                        if ( evaluateString( userLines[currentLine + 1].substr(5,9999) ) == -2323 ) {

                          reviewResults += "The amount of the REST on line " + (currentLine + 2) + " doesn't make sense.<br>";
                          editorReportStr += prefixString + "has an amount of Rest that doesn't make sense.<br>";

                        } else {

                          thisLocation.toDo.push( userLines[currentLine + 1] );

                          if ( parseInt( evaluateString( userLines[currentLine + 1].substr(5,9999) ) ) == 0 ) {
                            warnings.push( "The @rest action on line " + (currentLine + 2) + " seems to do nothing.")
                          }

                        }

                      } else if ( userLines[currentLine + 1].substr(0,3).toUpperCase() == "@XP" ) {

                        if ( isNaN( evaluateString( userLines[currentLine + 1].substr(3,9999) ) ) ) {

                          reviewResults += "The amount of XP on line " + (currentLine + 1) + " doesn't make sense.<br>";
                          editorReportStr += prefixString + "has an amount of XP that doesn't make sense.<br>";

                        } else {

                          thisLocation.toDo.push( userLines[currentLine + 1] );

                          if ( parseInt( userLines[currentLine + 1].substr(3,9999) ) == 0 ) {
                            warnings.push( "The @xp action on line " + (currentLine + 2) + " seems to do nothing.")
                          }

                        }

                      } else if ( userLines[currentLine + 1].substr(0,10).toUpperCase() == "@REMOVEFOE" ) {

//                        console.log("adding @REMOVEFOE to node " + adventureArray.length + " at text line " + (currentLine + 1) );

//                        console.log(userLines[currentLine + 1]);
                        thisLocation.toDo.push( userLines[currentLine + 1].toLowerCase() );
                        foesWeTryToRemove.push(userLines[currentLine + 1].substr(11,999).toLowerCase() );

                      } else if ( userLines[currentLine + 1].substr(0,1) == "^" && userLines[currentLine + 1].indexOf("=") > -1 ) {

                        //looks like variable reassignment, let's check it's a real var and for Security
                        theVar = userLines[currentLine + 1].substr( 1, userLines[currentLine + 1].indexOf('=') - 1 ).replace(/ +/g, "");

                        theExpr = userLines[currentLine + 1].substr( userLines[currentLine + 1].indexOf('=') + 1, 9999 ).replace(/ +/g, "");

                        // first, is there a new varZeroDestination and if so is it a legit destination
                        if ( theExpr.split('->').length > 1 && theExpr.split('->')[1].trim().length > 0 ) {

                          newZeroDestination = theExpr.split('->')[1];

//                          console.log("*"+newZeroDestination+"*");

                          placesWeTryToGo.push( "z^" + thisLocation.name + "^"
                            + newZeroDestination );


                        }

                        theExpr = theExpr.split('->')[0];
                        goodVar=1;

                        for ( let i=0; i < illegalVariableNames.length; i++ ) {

                          if ( theVar.toUpperCase == illegalVariableNames[i] ) {
                            reviewResults += "Line " + (currentLine + 1) + ": you can't reassign " + illegalVariableNames[i] +"." ;
                            goodVar = 0;
                          }

                        }
    // console.log(theVar);
    // console.log( variableArray.find( whatever => whatever.varName===theVar.toUpperCase() ) );
    // console.log( variableArray.find( whatever => whatever.varName==="treasurePile".toUpperCase() ) );
    // console.log( theVar.toUpperCase() == "treasurePile".toUpperCase()  );
    // console.log( theVar.toUpperCase()+"*" );
    // console.log( "treasurePile".toUpperCase() );

                        if ( typeof variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ) ==='undefined' ) {
                          reviewResults += "Line " + (currentLine + 2) + ":  " + theVar +" is not a variable defined before the first location.<br>";
                          editorReportStr += "The variable " + theVar + " doesn't exist.<br>";
                          problemsFound++;
                          goodVar = 0;
                        }

                        if ( evaluateString( theExpr ) != -2323 ) {
                          goodExpr = 1;
                        } else {
                          goodExpr = 0;
                          reviewResults += "Line " + (currentLine + 2) + ":  " + theExpr +" is not an expression that makes sense.<br>";
                          editorReportStr += "The expression " + theExpr + " doesn't make sense.<br>";
                          problemsFound++;


                        }

                        //security checks
                        secure = securityCheck( theExpr );

                        // variable change becomes a "toDo"
                        if ( goodVar > 0 && secure > 0 && goodExpr > 0){
                          thisLocation.toDo.push( userLines[currentLine + 1] );
                        }

                      } else if ( userLines[currentLine + 1].indexOf("^") > -1 ) {
                        // uppercase the variable name for later substitution
                        fixedLine = userLines[currentLine + 1];
                        fixedLineWords = fixedLine.split(" ");
                        for ( wordCounter = 0; wordCounter < fixedLineWords.length; wordCounter++ ) {
                          if ( fixedLineWords[wordCounter].substr(0,1) == "^" ) {
                            varsUsedInText.push( fixedLineWords[ wordCounter ].substring(1,9999) );
                            fixedLine = fixedLine.replace( fixedLineWords[wordCounter], fixedLineWords[wordCounter].toUpperCase() );
                            thisLocation.html += breakHTML( fixedLine ) + "<br>";
                            break;
                          }
                        }


                      } else {
                        thisLocation.html += breakHTML( userLines[currentLine + 1] ) + "<br>";

                        // if there's an @if in there we need to check the eval string...


                          if ( userLines[currentLine + 1].substring(0,3) == '@if' ) {

                            theExpr = userLines[currentLine + 1].substring(4);

                            if ( evaluateString( theExpr ) == -2323 ) {

                              //reviewResults += "Line " + (currentLine + 1) + ":  " + theExpr +" is not an expression that makes sense.<br>";
                              editorReportStr += "The expression " + theExpr + " in node '" + thisLocation.name + "' doesn't make sense.<br>";
                              problemsFound++;

                            }

                          }
//                        }
                        // end of @if check

                      }


                      currentLine += 1;

    //                  console.log('End of While loop: ' + currentLine + userLines[currentLine].substr(0,10) );

                  } //end of for loop WITHIN LOCATION

                  lengthOfDescription = thisLocation.html.indexOf('<div');
                  if ( lengthOfDescription < 0 ) {
                    lengthOfDescription = thisLocation.html.length;
                  }

                  preButtonDescription = thisLocation.html.substring(0,lengthOfDescription);
                  preButtonDescription = preButtonDescription.replace(/<br>/g,'');
    //              console.log(lengthOfDescription, preButtonDescription);

                  if ( preButtonDescription.trim() == "" ) {
    //                console.log((currentLine+1) + preButtonDescription );
                    reviewResults += "Line " + (currentLine+1) + ": The location " + locationNameString + " has no description.<br>";
                    editorReportStr += prefixString + "has no description.<br>";
                    problemsFound++;
                  }

                  if ( thisLocation.html.indexOf('adventureGo') == -1 ) {
                    warnings.push( "Reminder: <a href='#editorNode" + thisLocation.name + "'>" + thisLocation.name + '</a> does not have any buttons.');
                  }

                  adventureArray.push( thisLocation );

                }  // end of parsing LOCATION



                // Are we starting a branch? We build a new entry for the adventureArray (parse branch)
                if ( userLines[currentLine].substr(0,7).toLowerCase() == "@branch" ) {

                  figuredThisLineOut = 1;

                  locationNameString = userLines[currentLine].substr(8,userLines[currentLine].length).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

                  if ( placesWeCanGo.indexOf(locationNameString) > -1 ) {
                    reviewResults += "Line " + (currentLine+1) + ": There is more than one location or branch named '" + locationNameString + "'.<br>";
                    editorReportStr += "There is more than one location or branch named '" + locationNameString + "'.<br>";
                    problemsFound++;
                  } else {
                      placesWeCanGo.push( locationNameString );
                  }


                  thisLocation = {
                    type: "b",
                    name: locationNameString,
                    toDo: [],
                    // bonuses removed 8/28/24
//                    bonuses: [],
    //                description: "",
                    // firstExpression: "",
                    // secondExpression: "",
                    // comparator: "",
                    comparisonExpression: "",
                    destinationTrue: "",
                    destinationFalse: "",
                  };


                  newLocationButton  = "<span onclick='adventureGo(";
                  newLocationButton += '\"' + locationNameString + '\"';
                  newLocationButton += ")''>(B) " + locationNameString + "</span><br>";

                  document.getElementById("locationsDiv").innerHTML += newLocationButton;

                  newEditorShortCut = "<a href='#editorNode" + locationNameString + "' style='text-decoration: none; color: black; background-color: #dbddff'>";

                  newEditorShortCut += "(B)&nbsp;" + locationNameString + "</a><br>";

                  $('editorNodeListDiv').innerHTML += newEditorShortCut;

                  newTELocButton = "<span onclick='scrollTE(\"" + locationNameString + "\")'>";
                  newTELocButton += '(B) ' + locationNameString + "</span><br>";
                  $('locDiv').innerHTML += newTELocButton;


                  while ( currentLine < userLines.length - 1
                    && userLines[currentLine + 1].substr(0,9).toLowerCase() != "@location"
                    && userLines[currentLine + 1].substr(0,7).toLowerCase() != "@branch"
                    && userLines[currentLine + 1].substr(0,4).toLowerCase() != "@foe" ) {

                      // console.log(userLines[currentLine + 1].substr(0,16).toLowerCase().trim());

                      if ( userLines[currentLine + 1].substr(0,16).toLowerCase().trim() == "@destinationtrue" ) {

                        if ( thisLocation.destinationTrue == "" ) {

                          thisLocation.destinationTrue = userLines[currentLine + 1].substr(16,999).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

                          placesWeTryToGo.push( "b^" + thisLocation.name + "^" + thisLocation.destinationTrue );

                        } else {
                          reviewResults += "Line " + (currentLine+1) + ": The branch named " + locationNameString + " has more than one destinationTrue; only the first will be used.<br>";

                        }

                      } else if ( userLines[currentLine + 1].substr(0,17).toLowerCase().trim() == "@destinationfalse" ) {

                          if ( thisLocation.destinationFalse == "" ) {

                            thisLocation.destinationFalse = userLines[currentLine + 1].substr(17,999).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

                            placesWeTryToGo.push( "b^" + thisLocation.name + "^" + thisLocation.destinationFalse );

                          } else {
                            reviewResults += "Line " + (currentLine+1) + ": The branch named " + locationNameString + " has more than one destinationFalse; only the first will be used.<br>";
                          }

                      } else if ( userLines[currentLine + 1].trim() == '' ) {

                        // that's  a blank line let's ignore it

                      } else { // must be the comparison line or description

//                        if ( thisLocation.firstExpression + thisLocation.secondExpression + thisLocation.comparator == "" ) {
                        if ( thisLocation.comparisonExpression.trim() == "" ) {

                          // for better or worse we put it into the array and thereby the editor
                          thisLocation.comparisonExpression = userLines[currentLine + 1];

                          // console.log( userLines[currentLine + 1] );
                          // console.log( thisLocation.name + ":" + thisLocation.comparisonExpression );


                          //then we spit out an error if evaluateString() doesn't like it.

                          if ( evaluateString( userLines[currentLine + 1] ) == -2323 ) {

                            problemsFound++;
                            reviewResults += "Line " + (currentLine+1) + ": In the branch named " + locationNameString
                              + " the comparison expression doesn't seem to make sense.<br>";
                            editorReportStr += prefixString + "has a  comparison term expression doesn't make sense.<br>";

                          }

                        } else if ( userLines[currentLine + 1].trim().length > 0 ) {

                            reviewResults += "Line " + (currentLine+1) + ": The branch named " + locationNameString + " has an extraneous line (\"" + userLines[currentLine + 1] + "\").<br>";

                        }


                      }

                      currentLine += 1;

                    }  // end of while-loop for branch contents


    //                console.log ( thisLocation );

                    if ( thisLocation.destinationTrue == "" ) {
                      reviewResults += "Line " + (currentLine+1) + ": The branch named " + locationNameString + " has no @destinationTrue.<br>";
                      editorReportStr += prefixString + " has no @destinationTrue.<br>";
                      problemsFound++;
                    }
                    if ( thisLocation.destinationFalse == "" ) {

                      reviewResults += "Line " + (currentLine+1) + ": The branch named " + locationNameString + " has no @destinationFalse.<br>";
                      editorReportStr += prefixString + " has no @destinationFalse.<br>";
                      problemsFound++;
                    }
                    if ( thisLocation.destinationFalse == thisLocation.destinationTrue ) {
                      reviewResults += "Line " + (currentLine+1) + ": The branch named " + locationNameString + " has the same destination for true and false; this will work, but is probably not what you want.<br>";
                      editorReportStr += prefixString + " has the same destination for true and false; this will work, but is probably not what you want.<br>";
                      problemsFound++;
                    }

                    if ( thisLocation.firstExpression + thisLocation.secondExpression + thisLocation.comparator == "" ) {
                      reviewResults += "Line " + (currentLine+1) + ": The branch named " + locationNameString + " doesn't have a comparison line.<br>";
                      editorReportStr += prefixString + " doesn't have a comparison line.<br>";
                      problemsFound++;
                    }

                    if ( thisLocation.firstExpression == "" ||  thisLocation.secondExpression == "" ||  thisLocation.comparator == "" ) {
                      reviewResults += "Line " + (currentLine+1) + ": The branch named " + locationNameString + " has an unreadable comparison line.<br>";
                      editorReportStr += "The branch named " + nodeNameLink + " has an unreadable comparison line.<br>";
                      problemsFound++;
                    }


                    adventureArray.push( thisLocation );

                }  // end of if-its-a-branch  parsing branch
    //***
    // Parsing Foe
    if ( userLines[currentLine].substr(0,4).toLowerCase() == "@foe" ) {

      figuredThisLineOut = 1;

      locationNameString = userLines[currentLine].substr(5,userLines[currentLine].length).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

      if ( placesWeCanGo.indexOf(locationNameString) > -1 ) {
        reviewResults += "Line " + (currentLine+1) + ": There is more than one location, branch, or foe named '" + locationNameString + "'.<br>";
        editorReportStr += "There is more than one location, branch, or foe named '" + locationNameString + "'.<br>";
        problemsFound++;
      } else {
          placesWeCanGo.push( locationNameString );
      }

    foesThatExist.push(locationNameString.toLowerCase());

      thisLocation = {
        type: "f",
        name: locationNameString,
        foeName: "",
        combatIntro: "",
        toDo: [],
        st: 0,
        dx: 0,
        iq: 0,
        ma: 0,
        armor: 0,
        range: 0,
        damage: "",
        damage2: "",
        foeType: 0,
        winDestination: "",
        loseDestination: "",
        noFoe: ""
      };


      newLocationButton  = "<span onclick='adventureGo(";
      newLocationButton += '\"' + locationNameString + '\"';
      newLocationButton += ")''>(F) " + locationNameString + "</span><br>";

      document.getElementById("locationsDiv").innerHTML += newLocationButton;

      newEditorShortCut = "<a href='#editorNode" + locationNameString + "' style='text-decoration: none; color: black; background-color: lightsalmon'>";

      newEditorShortCut += "(F)&nbsp;" + locationNameString + "</a><br>";

      $('editorNodeListDiv').innerHTML += newEditorShortCut;

      newTELocButton = "<span onclick='scrollTE(\"" + locationNameString + "\")'>";
      newTELocButton += '(F) ' + locationNameString + "</span><br>";
      $('locDiv').innerHTML += newTELocButton;

      while ( currentLine < userLines.length - 1
        && userLines[currentLine + 1].substr(0,9).toLowerCase() != "@location"
        && userLines[currentLine + 1].substr(0,7).toLowerCase() != "@branch"
        && userLines[currentLine + 1].substr(0,4).toLowerCase() != "@foe" ) {

          if ( userLines[currentLine + 1].substr(0,15).toLowerCase() == "@windestination" ) {

            if ( thisLocation.winDestination == "" ) {

              thisLocation.winDestination = userLines[currentLine + 1].substr(16,999).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

              placesWeTryToGo.push( "f^" + thisLocation.name + "^" + thisLocation.winDestination );

            } else {
              reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " has more than one winDestination; only the first will be used.<br>";
            }

          } else if ( userLines[currentLine + 1].substr(0,16).toLowerCase() == "@losedestination" ) {

              if ( thisLocation.loseDestination == "" ) {

                thisLocation.loseDestination = userLines[currentLine + 1].substr(17,999).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

                placesWeTryToGo.push( "b^" + thisLocation.name + "^" + thisLocation.loseDestination );

              } else {
                reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " has more than one loseDestination; only the first will be used.<br>";
              }

          } else if ( userLines[currentLine + 1].substr(0,6).toLowerCase() == "@nofoe" ) {

              if ( thisLocation.noFoe == "" ) {

                thisLocation.noFoe = userLines[currentLine + 1].substr(7,999).toLowerCase().replace(/[^a-zA-Z0-9]/g, '');

                placesWeTryToGo.push( "b^" + thisLocation.name + "^" + thisLocation.noFoe );

              } else {
                reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " has more than one @nofoe; only the first will be used.<br>";
              }

          } else if ( userLines[currentLine + 1].substr(0,5).toLowerCase() == "@type" ) {

              if ( thisLocation.foeType == 0 ) {

                thisLocation.foeType = parseInt( userLines[currentLine + 1].substr(6,8) );

                thisLocation.foeName = userLines[currentLine + 2].substr( 0, 30 );

                currentLine++;

              } else {
                reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " has more than one foeType; only the first will be used.<br>";
              }

          } else if ( thisLocation.st == 0 && userLines[currentLine + 1].substr(0,2).toLowerCase() == "st" && userLines[currentLine + 1].toLowerCase().indexOf(", dx") > 0 ) {

            statArray = userLines[currentLine + 1].split(",");
            thisLocation.st = parseInt( statArray[0].substr(3,99) );
            thisLocation.dx = parseInt( statArray[1].substr(3,99) );
            thisLocation.iq = parseInt( statArray[2].substr(3,99) );
            thisLocation.ma = parseInt( statArray[3].substr(3,99) );

            if ( thisLocation.st < 1 || thisLocation.st > 19 ) {
              reviewResults += "Line " + (currentLine+2) + ": The foe named " + locationNameString + " has an unexpected value for ST. Consider using 1-19.<br>";
              editorReportStr += "The foe named " + nodeNameLink + " has an unexpected value for ST. Consider using 1-19.<br>";
              if ( thisLocation.st < 0 ) {
                thisLocation.st = 0;
              }
            }

            if ( thisLocation.dx < 1 || thisLocation.dx > 19 ) {
              reviewResults += "Line " + (currentLine+2) + ": The foe named " + locationNameString + " has an unexpected value for DX. Consider using 1-19.<br>";
              editorReportStr += "The foe named " + nodeNameLink + " has an unexpected value for DX. Consider using 1-19.<br>";
              if ( thisLocation.dx < 0 ) {
                thisLocation.dx = 0;
              }
            }

            if ( thisLocation.iq < 1 || thisLocation.iq > 19 ) {
              reviewResults += "Line " + (currentLine+2) + ": The foe named " + locationNameString + " has an unexpected value for IQ. Consider using 1-19.<br>";
              editorReportStr += "The foe named " + nodeNameLink + " has an unexpected value for IQ. Consider using 1-19.<br>";
              if ( thisLocation.iq < 0 ) {
                thisLocation.iq = 0;
              }
            }

            if ( thisLocation.ma < 1 || thisLocation.ma > 19 ) {
              reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " has an unexpected value for MA. Consider using 1-19.<br>";
              editorReportStr += "The foe named " + nodeNameLink + " has an unexpected value for MA. Consider using 1-19.<br>";
              if ( thisLocation.ma < 0 ) {
                thisLocation.ma = 0;
              }
            }

          } else if ( userLines[currentLine + 1].substr(0,6).toLowerCase() == "armor:" ) {

            thisArmor = userLines[currentLine + 1].substr( 7, 99 ).toLowerCase();

            if ( thisArmor.trim().length == 0 ) {

              thisLocation.armor = 0;

            } else {

              armorFound = armorTypes.indexOf( thisArmor );
              armorValue = parseInt( thisArmor );

              if ( armorFound > -1 ) {

                thisLocation.armor = armorFound;


              } else if ( isNaN( armorValue ) ) {

                reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " has unreadable armor ('" + thisArmor + "').<br>";

                problemsFound++;

              } else {
    //console.log('hi'+armorValue);
                thisLocation.armor = armorValue;
    //console.log(thisLocation.armor);
                if ( armorValue < 0 || armorValue > 10 ) {
                  reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " has an unexpected value for Amor. Consider using 0-10.<br>";
                  if ( armorValue < 0 ) {
                    thisLocation.armor = 0;
                  }
                }
              }
            }

          } else if ( userLines[currentLine + 1].substr(0,6).toLowerCase() == "@range" ) {

            thisRange = Number(userLines[currentLine + 1].substr( 6, 99 ));

            if ( thisRange < 1 ) {

              thisRange = 1;

              reviewResults += "Line " + (currentLine+1) + ": The range for the foe named " + locationNameString + " is less than one. Setting the range to 1 yard.<br>";
              editorReportStr += "The range for the foe named " + nodeNameLink + " is less than one. Setting the range to 1 yard.<br>";

            } else if ( thisRange == NaN ) {

              thisRange = 1;

              reviewResults += "Line " + (currentLine+1) + ": The range for the foe named " + locationNameString + " makes no sense. Setting the range to 1 yard.<br>";
              editorReportStr += "The range for the foe named " + nodeNameLink + " makes no sense. Setting the range to 1 yard.<br>";

            } else if ( thisRange >30 ) {

              reviewResults += "Line " + (currentLine+1) + ": The range for the foe named " + locationNameString + " seems very high. The combatants will spend many turns approaching each other. Consider lowering the range.<br>";
              editorReportStr += "The range for the foe named " + nodeNameLink + " seems very high. The combatants will spend many turns approaching each other. Consider lowering the range.<br>";

            }

            thisLocation.range = thisRange;

          } else if ( userLines[currentLine + 1].substr(0,3).toLowerCase() == "@xp" ) {

            thisXP = Number(userLines[currentLine + 1].substr( 3, 99 ));

            if ( thisXP < 0 ) {

              reviewResults += "Line " + (currentLine+1) + ": The XP for the foe named " + locationNameString + " is negative. That's weird, but if that's what you want...<br>";
              editorReportStr += "The XP for the foe named " + locationNameString + " is negative. That's weird, but if that's what you want...<br>";

            } else if ( thisXP == NaN ) {

              thisXP = 1;

              reviewResults += "Line " + (currentLine+1) + ": The XP for the foe named " + locationNameString + " makes no sense. Setting the XP to 1 point.<br>";
              editorReportStr += "The XP for the foe named " + nodeNameLink + " makes no sense. Setting the XP to 1 point.<br>";

            } else if ( thisXP > 30 ) {

              reviewResults += "Line " + (currentLine+1) + ": The XP awarded for the foe named " + locationNameString + " seems very high. Consider lowering this value.<br>";
              editorReportStr += "The XP awarded for the foe named " + nodeNameLink + " seems very high.  Consider lowering this value.<br>";

            }


            thisLocation.xp = thisXP;

          } else if ( userLines[currentLine + 1].substr(0,8).toLowerCase() == "weapons:" ) {

            if ( thisLocation.damage != "" ) {

              reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " seems to have an extra Weapons line('"+userLines[currentLine + 1]+"').<br>";

            } else {

              weaponsDamageMaybe = userLines[currentLine + 1].split("(");
              if ( weaponsDamageMaybe.length > 1 ) {

                  thisLocation.damage = weaponsDamageMaybe[1].split(")")[0]

                if ( weaponsDamageMaybe.length > 2) {

                  thisLocation.damage2 = weaponsDamageMaybe[2].split(")")[0]

                }
              }

              // TODO sanity check those strings

            }

          } else if ( userLines[currentLine + 1].substr(0,19).toLowerCase() == "attacks and damage:" ) {

            if ( thisLocation.damage != "" ) {

              // we'll ignore this because we found at least one weapon

            } else {

              weaponsDamageMaybe = userLines[currentLine + 1].split("(");
              if ( weaponsDamageMaybe.length > 1 ) {

                  thisLocation.damage = weaponsDamageMaybe[1].split(")")[0]

                if ( weaponsDamageMaybe.length > 2) {

                  thisLocation.damage2 = weaponsDamageMaybe[2].split(")")[0]

                }
              } else {
                reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " doesn't seem to have any weapons or attacks (remember damage should be in parenthesis, eg \"(1d+1)\").<br>";
                editorReportStr += "The foe named " + nodeNameLink + " doesn't seem to have any weapons or attacks (remember damage should be in parenthesis, eg \"(1d+1)\").<br>";
              }

              // TODO sanity check those strings

            }

          } else if ( userLines[currentLine + 1].indexOf( ", age" ) > -1
              || userLines[currentLine + 1].substr(0,8).toLowerCase() == "talents:"
              || userLines[currentLine + 1].substr(0,7).toLowerCase() == "spells:"
              || userLines[currentLine + 1].substr(0,10).toLowerCase() == "equipment:"
              || userLines[currentLine + 1].substr(0,13).toLowerCase() == "special note:" ) {
              // || userLines[currentLine + 2].toLowerCase().indexOf(', age') > -1 ) {

            // this is the race and age, we ignore it
            // and these others

          } else if ( userLines[currentLine].substr(0,4).toLowerCase() == "@foe" ) {

            // if it makes no other sense and it's the second line, it's the combat intro
            thisLocation.combatIntro = userLines[currentLine + 1];

          }  else if ( userLines[currentLine + 1].trim().length > 0 ) {
              reviewResults += "Line " + (currentLine+1) + ": The foe named " + locationNameString + " has an extraneous line('"+userLines[currentLine + 1]+"').<br>";

          }

          currentLine += 1;

        } // end of while loop within foe

    //      currentLine += 1;

          adventureArray.push( thisLocation );

      }  // end of foe parser




                if ( figuredThisLineOut == 0 && userLines[currentLine].trim().length > 0 ) {
                  reviewResults += "Line number " + (currentLine+1) + " doesn't seem to make sense. Possibly a key word is misspelled or another line is out of place. (" + userLines[currentLine] + ")<br>";

                }


              }  // end of userLines[currentLine] for loop
              // console.timeEnd("looping through userLines");
              // console.time("post userLines loop");

//              console.log(adventureArray[6].comparisonExpression);


              // We're done with the user input lines, time to look for problems

              //check if no title
              if ( titleStr == "" ) {
                reviewResults += "Problem: You need a @title line for your adventure.<br>";
                editorReportStr += "Problem: You need a @title line for your adventure.<br>";
                problemsFound++;
              }

              //check if no creator
              if ( creatorStr == "" ) {
                reviewResults += "Problem: You need a @creator line for your adventure.<br>";
                editorReportStr += "Problem: You need a @creator line for your adventure.<br>";
                problemsFound++;
              }

              //check if no description
              if ( descriptionStr == "" ) {
                reviewResults += "Problem: You need a @description line for your adventure.<br>";
                editorReportStr += "Problem: You need a @description line for your adventure.<br>";
                problemsFound++;
              }

              //check if no max level
              if ( maxAttr == 0 ) {
                warnings.push( "You didn't specify a @maxattributes for this adventure, so we'll assume the adventure is for starting characters (32 attribute points)." );
                // reviewResults += "You didn't specify a @maxattributes for this adventure, so we'll assume the adventure is for starting characters (32 attribute points).<br>";
                // editorReportStr += "You didn't specify a @maxattributes for this adventure, so we'll assume the adventure is for starting characters (32 attribute points).<br>";
                maxAttr = 32;
              }

              nodeNames=[];

              // console.log(foesThatExist);
              // console.log(foesWeTryToRemove);

              for ( let i = 0; i < foesWeTryToRemove.length; i++ ) {

                if ( foesThatExist.indexOf( foesWeTryToRemove[i] ) == -1 ) {

                  reviewResults += "There is a @removeFoe line for a foe called " + foesWeTryToRemove[i]  + " but no such foe can be found.<br>";
                  editorReportStr += "There is a @removeFoe line for a foe called " + foesWeTryToRemove[i]  + " but no such foe can be found.<br>";
                  problemsFound++;

                }
              }

              for ( i = 0; i < placesWeTryToGo.length; i++ ) {

                destinationArray = placesWeTryToGo[i].split("^");

                nodeNames.push(destinationArray[2]);

                if ( placesWeCanGo.indexOf( destinationArray[2] ) < 0 ){
                  reviewResults += "Problem: There is a ";
                  editorReportStr += "Problem: There is a ";

                  switch ( destinationArray[0] ) {
                    case "l":
                    reviewResults += "button in the location";
                    editorReportStr += "button in the location";
                      break;
                    case "b":
                    reviewResults += "branch";
                    editorReportStr += "branch";
                      break;
                    case "f":
                    reviewResults += "foe";
                    editorReportStr += "foe";
                      break;
                    case "d":
                    reviewResults += "@damage in the location";
                    editorReportStr += "@damage in the location";
                      break;
                    case "z":
                    reviewResults += "zero limit variable";
                    editorReportStr += "zero limit variable";
                      break;
                    case "r":
                    reviewResults += "@remember action in the location ";
                    editorReportStr += "@remember action in the location ";
                      break;
                  }

                  reviewResults += " named '" + destinationArray[1];

//                  console.log("--->" + nodeNameLink );

//works                  editorReportStr += " named '" + destinationArray[1];
                  editorReportStr += " named '<a href='#editorNode" + destinationArray[1] + "'>" + destinationArray[1] + '</a>';
//NO                  editorReportStr += " named '" + nodeNameLink;

                  reviewResults += "' that should lead to '";
                  editorReportStr += "' that should lead to '";
                  reviewResults += destinationArray[2];
                  editorReportStr += destinationArray[2];
                  reviewResults += "' but there is no location with that name.<br>";
                  editorReportStr += "' but there is no location with that name. <span class='inlineButton' onclick='visAddLocation(" + '"'+ destinationArray[2] + '"' + ")'>Create&nbsp;This&nbsp;Location</span><span class='inlineButton' onclick='visAddBranch(" + '"'+ destinationArray[2] + '"' + ")'>Create&nbsp;This&nbsp;Branch</span><span class='inlineButton' onclick='addMissingFoe(" + '"'+ destinationArray[2] + '"' + ")'>Create&nbsp;This&nbsp;Foe</span><br>";
                  problemsFound++;

                  if ( missingLocations.find( z => z.missingLoc == destinationArray[2] ) == undefined ) {
                    missingLocations.push( {missingLoc: destinationArray[2], source:[destinationArray[1] ] } );
                  } else {
                    missingLocations.find( z => z.missingLoc == destinationArray[2] ).source.push(destinationArray[1]);
                  }


                }

              }

              for ( i = 1; i < placesWeCanGo.length; i++ ) {

//                if ( nodeNames.indexOf(placesWeCanGo[i]) < 0 && placesWeCanGo[i] != firstLocation ) {
                if ( nodeNames.indexOf(placesWeCanGo[i]) < 0 && ![firstLocation,'lastlocation'].includes(placesWeCanGo[i]) ) {

                  let nodeLink = "<a href='#editorNode" + placesWeCanGo[i] + "'>" + placesWeCanGo[i] + "</a>";

                  reviewResults +="There is a location or branch called ''" + placesWeCanGo[i] + "'' but nothing leads to that location.<br>";
                  editorReportStr +="There is a location or branch called ''" + nodeLink + "'' but nothing leads to that location.<br>";
                }

              }

              document.getElementById("feedbackTextArea").innerHTML = reviewResults;
              document.getElementById("problemCountDiv").innerHTML = "Problems found: " + problemsFound + "<br>";

              if ( problemsFound > 0 ) {
    //            document.getElementById("problemCountDiv").innerHTML += "While there are problems you will not be able to use the simulator or export your adventure.";
                document.getElementById("feedbackTextArea").innerHTML += "While there are problems you will not be able to use the simulator or export your adventure.";
              } else {
                document.getElementById("problemCountDiv").innerHTML += "<br>";
                document.getElementById("feedbackTextArea").innerHTML += "No problems found.<br>";
              }

    //          console.log(testMode);

              if ( testMode == 1 ) {
                document.getElementById("testModeWarningDiv").style.display = "block";
              } else {
                document.getElementById("testModeWarningDiv").style.display = "none";
              }

              if ( problemsFound == 0 ) {

                newLoc = { name: firstLocation };
                adventureGo( firstLocation );

                displayVariables();

                document.getElementById("exportableTextArea").innerHTML = generateExportable();

                document.getElementById("JSONTextArea").value = JSON.stringify( jsonExportable );

                document.getElementById('historyDiv').innerHTML = "(" + newLoc.type.toUpperCase() + ") " + firstLocation;

              } else {

                document.getElementById("exportableTextArea").innerHTML = "You'll need to address the problems before an exportable can be generated."

                document.getElementById("simulatedScreen").innerHTML = "You need to fix the problems listed at the bottom of the 'Edit & Review' tab before the simulator will work.";

              }


//              console.log( "End of reviewUserInput(): adventureArray.length = " + adventureArray.length );
//              console.timeEnd("post userLines loop");

//              console.timeEnd('rui');

//              console.log( missingLocations );

              $('editorReport').innerHTML = editorReportStr;

//              console.log( adventureArray[0].toDo );

              normalNodeShortcuts = $('editorNodeListDiv').innerHTML;
              alphaNodeShortcuts = $('editorNodeListDiv').innerHTML.split('<br>').sort().join('<br>').substring(4);
              if ( nodeAlphabetizement ) {
                $('editorNodeListDiv').innerHTML = alphaNodeShortcuts;
              }

              $('editorNodeListDiv').innerHTML += '&nbsp;\n&nbsp;\n&nbsp;\n';

              if ( $('editorReport').innerHTML.trim().length == 0 ) {
                $('editorReport').innerHTML += "No problems found.<br>";
              }

              if ( document.querySelector("#showWarnings").checked ) {

                warnings.forEach(warning => {
                  $('feedbackTextArea').innerHTML += warning + "<br>";
                  $('editorReport').innerHTML += warning + "<br>";
                });

                let userVarNames = userVarArray.map(str => str.split(' ')[0].toUpperCase() );

                unusedVars = userVarNames.filter( x => !varsUsedInText.includes( x ) && !varsUsedInBranches.includes( x )  );

                if ( unusedVars.length > 0 ) {

                  unusedWarning = 'The variable' + ( unusedVars.length == 1 ? '' : 's' ) + ' ' + formatWithOxfordComma( unusedVars ) + ( unusedVars.length == 1 ? ' is' : ' are' ) + ' not used in any text or branch expressions.<br>';

                  $('feedbackTextArea').innerHTML += unusedWarning + "<br>";
                  $('editorReport').innerHTML += unusedWarning + "<br>";

                }

              }


              rememberedLocation = firstLocation;
              lastLocation = firstLocation;

              document.getElementById('destinationList').innerHTML='';

              placesWeCanGo.forEach(place => {
                const option = document.createElement('option');
                option.value = place;
                document.getElementById('destinationList').appendChild(option);
              });


//              generateTextEditorShortcuts();

//              console.log( 'userInputTextArea is ' + $('userInputTextArea').value.split('\n').length + " lines long.");

            }  //end of reviewUserInput()

            // actionMenuString = "<option value='^'>Reassign Variable</option>";
            // actionMenuString += "<option value='h'>Heal</option>";
            // actionMenuString += "<option value='d'>Damage</option>";
            // actionMenuString += "<option value='x'>Grant XP</option>";
            // actionMenuString += "<option value='r'>Remove Foe</option>";
            // actionMenuString += "</select>";

            function removeNonAlphaNumericFromLastWord(str) {
              // Get the last word in the string
              const lastWord = str.split(' ').pop();
              // Remove non-alphanumeric characters from the last word
              const alphanumericOnly = lastWord.replace(/[^a-zA-Z0-9]/g, '');
              // Replace the last word in the string with the alphanumeric-only version
              return str.replace(lastWord, alphanumericOnly);
            }


            function formatWithOxfordComma(arr) {
                if (arr.length === 0) return '';         // Handle empty array
                if (arr.length === 1) return arr[0];     // Single item, no comma needed
                if (arr.length === 2) return arr.join(' and ');  // Two items, no comma needed

                // Three or more items: use Oxford comma
                return arr.slice(0, -1).join(', ') + ', and ' + arr[arr.length - 1];
            }


            function scrollTE( locName ) {

//              console.log( locName );

              uite = $('userInputTextArea');

              text = uite.value.toLowerCase();
              lines = text.split('\n');
              lines.map(line=>line.trim());
              text = lines.join('\n');

              // Find the position of the string locName
               index = text.indexOf("@location " + locName.toLowerCase() +'\n' );
                if ( index == -1 ) {
                   index = text.indexOf("@branch " + locName.toLowerCase() +'\n' );
                }
                if ( index == -1 ) {
                   index = text.indexOf("@foe " + locName.toLowerCase() +'\n' );
                }


              if (index !== -1) {
                  // Split the text up to the found index to count lines
                  beforeText = text.substring(0, index);
                  beforeText = beforeText.replace(/<br\s*\/?>/gi, '\n');
//                  console.log(beforeText);

                  // Create a temporary element to measure the height of the text before the word
                 var tempElement = document.createElement('textarea');
//                 tempElement.style.visibility = 'hidden';
                 tempElement.cols = uite.cols;
                 tempElement.style.whiteSpace = 'pre-wrap'; // Make sure it wraps like a textarea
                 tempElement.style.font = window.getComputedStyle($('userInputTextArea')).font; // Match the font style
                 tempElement.value = beforeText;

                 document.body.appendChild(tempElement);

                 tempElement.style.height = 'auto';
                 tempElement.style.height = ( tempElement.scrollHeight - 50 ) + 'px';

                 // Calculate the scroll position
                 var scrollPosition = tempElement.offsetHeight;

                 // Clean up
//                 document.body.removeChild(tempElement);

                  uite.scrollTop = scrollPosition;

                  tempElement.remove();

              } else {
                  console.warn('String not found in the text area');
              }


            }

            function uiteTop() {

              $('userInputTextArea').scrollTop = 0;

            }





            function nodeShortcutsAlpha() {

              nodeAlphabetizement = true;
              $('editorNodeListDiv').innerHTML = alphaNodeShortcuts;

            }

            function nodeShortcutsNormal() {

              nodeAlphabetizement = false;
              $('editorNodeListDiv').innerHTML = normalNodeShortcuts;

            }

            function confirmDialog( messageStr, thingToDo ) {

              $("confirmationMessageBox").innerHTML = messageStr;

              $("confirmationBox").style.display = 'block';

              $('confirmYesButton').setAttribute("onclick","$('confirmationBox').style.display = 'none';" + thingToDo );

            }

            reviewAdventureTimer = 0;

            function queueTextUpdate() {

//              clearTimeout( reviewAdventureTimer );

//              console.log(reviewAdventureTimer);
              reviewAdventureTimer = setTimeout( textUpdate, 1000 );
//              console.log(reviewAdventureTimer);

            }


            function normalizeBlankLines() {
                // Get the textarea element
                const textarea = document.getElementById('userInputTextArea');

                // Get the current text from the textarea
                let text = textarea.value;

                // Use a regular expression to replace sequences of two or more blank lines with a single blank line
                text = text.replace(/(\r?\n){2,}/g, '\n\n');

                // Set the modified text back to the textarea
                textarea.value = text;
            }

            function ncKeydown( theEvent ) {

//              console.log( 'ncKeydown()' );

              currentlyActiveItem = theEvent.target;

              if ( theEvent.key != 'Tab' ) {
                return;
              }

              changeableElements = $('nodeContainerDiv').querySelectorAll('textarea, select');
              currentIndex = Array.from(changeableElements).indexOf(currentlyActiveItem);

//              console.log( currentIndex );

              visualEditorUpdate();

              //console.log('modifying index');
              // if ( theEvent.shiftKey ) {
              //   currentIndex--;
              // } else {
              //   currentIndex++;
              // }

              changeableElements = $('nodeContainerDiv').querySelectorAll('textarea, select');
              changeableElements[ currentIndex ].focus();
              document.querySelector(clickedElement).selectionStart = 999999;
              document.querySelector(clickedElement).selectionEnd = 999999;

            }

            function ncClick( theEvent ) {

//              console.log( "ncClick()" );
//              console.log( theEvent );

              // clickX = theEvent.clientX;
              // clickY = theEvent.clientY;

              if ( theEvent.target == currentlyActiveItem ) {

                return;

              }

//              console.log( getDomPath( theEvent.target ) );

              if ( currentlyActiveItem.tagName == 'TEXTAREA') {

                cursorPosition = theEvent.target.selectionStart;
//                console.log(cursorPosition);

              }

              clickedElement = getDomPath( theEvent.target );

              visualEditorUpdate();

              document.querySelector(clickedElement).focus();

              currentlyActiveItem = document.querySelector(clickedElement);

              if ( currentlyActiveItem.tagName == 'TEXTAREA') {

                currentlyActiveItem.selectionStart = cursorPosition;
//                console.log(cursorPosition);

              }


              // newClickEvent = new MouseEvent( 'click', {
              //   clientX: clickX,
              //   clientY: clickY
              // });
              //
              // currentlyActiveItem.dispatchEvent(newClickEvent);

            }


            function visualEditorUpdate(  ) {

//              console.log('visualEditorUpdate');
//              console.log( theEvent );
//              eventHolder = theEvent;
//              console.log( document.activeElement );
//              activeElementHolder = document.activeElement;


//              console.log( currentIndex );

              convertVisualEditorToString();

              reviewUserInput();

              convertArrayToVisual();


            }

            function queueVisualEditorUpdate() {

              clearTimeout( reviewAdventureTimer );

              reviewAdventureTimer = setTimeout( visualEditorUpdate, 1000 );

            }

            function changeAction( theNode, theAction, theNewValue ) {
//              console.log( "changeAction(" + theNode + "," + theAction + "," + theNewValue + ")" );
              currentScroll = $('nodeContainerDiv').scrollTop;

//              console.log( 'first operand = ' + adventureArray[theNode].toDo[theAction].split(' ')[1] );

              let actionSelectNodes = [4];
              let nodeIndex = 5;

              while ( nodeIndex < 999 && getEditorNode( theNode ).children[ nodeIndex ].innerHTML != 'Add an Action' ) {

                // if ( getEditorNode( theNode )[ theNode ].children[ nodeIndex ].type  == 'select-one' ) {
                //   actionSelectNodes.push( nodeIndex );

                if ( getEditorNode( theNode ).children[ nodeIndex ].type  == 'select-one' ) {
                  actionSelectNodes.push( nodeIndex );
                }

                nodeIndex++;

              }

//              console.log( actionSelectNodes );

//              console.log( 'new value = ' + $('nodeContainer').getElementsByTagName('div')[ theNode ].children[ actionSelectNodes[ theAction ] ].value + "("+theNode+":"+theAction+")");

              let newOperand=0;
              if ( adventureArray[theNode].toDo[theAction].split(' ').length > 1 ){
                if ( isNaN( Number(adventureArray[theNode].toDo[theAction].split(' ')[1] ) ) ) {
                  newOperand = 0;
                } else {
                  newOperand = Number(adventureArray[theNode].toDo[theAction].split(' ')[1] );
                }
              }

              let newToDo='';

//              console.log('%c'+$('nodeContainer').getElementsByTagName('div')[ theNode ].children[ actionSelectNodes[ theAction ] ].value,'background-color:lightblue');

              // switch ( $('nodeContainer').getElementsByTagName('div')[ theNode ].children[ actionSelectNodes[ theAction ] ].value ) {
              switch ( theNewValue ) {

                case 'h':
                  newToDo = '@heal ' + newOperand;
                  break;

                case 'e':
                  newToDo = '@rest ' + newOperand;
//                  console.log('e');
                  break;

                case 'd':
                  newToDo = '@damage ' + newOperand + ' loseLocation';
                  break;

                case 'w':
                  newToDo = '@writing text';
                  break;

                case 'x':
                  newToDo = '@xp ' + newOperand;
                  break;

                case 'r':
                  if ( foesThatExist.length > 0 ) {
                    newToDo = '@removeFoe ' + foesThatExist[0];
                  } else {
                                        newToDo = '@removeFoe (foe name here)';
                  }
//                  console.log('r');
                  break;

                case 'm':
                  newToDo = '@remember ' + newOperand;
                  console.log('m');
                  break;

                case '^':
                  if ( userVarArray.length == 0 ) {
                    newToDo = '^newVariable = 0';
                  } else {
                    newToDo = '^' + userVarArray[0] + '0';
                  }

              }

//              console.log( "newToDo: " + newToDo );
//              console.log( 'before:' + adventureArray[theNode].toDo[theAction] );

              adventureArray[theNode].toDo[theAction] = newToDo;

//              console.log( 'after:' + adventureArray[theNode].toDo[theAction] );

//              console.log( 'AAA = ' + $('nodeContainer').getElementsByTagName('div')[ theNode ].children[ actionSelectNodes[ theAction ] ].value + "("+theNode+":"+theAction+")");
//              console.log("array A" + adventureArray[0].toDo[0]);

              convertArrayToVisual();

//              console.log("array B" + adventureArray[0].toDo[0]);
//              console.log( 'BBB = ' + $('nodeContainer').getElementsByTagName('div')[ theNode ].children[ actionSelectNodes[ theAction ] ].value + "("+theNode+":"+theAction+")");

//              console.log( 'array says: ' + adventureArray[theNode].toDo[theAction] );
//              console.log( $('nodeContainer').getElementsByTagName('div')[ theNode ].children[ 4 ] );
              convertVisualEditorToString();
//              console.log( 'all done:' + adventureArray[theNode].toDo[theAction] );

              $('nodeContainerDiv').scrollTop = currentScroll;

              reviewUserInput();

            }

            function visAddLocation( newLocName ) {
//              console.log("visAddLocation(" + newLocName + ")");

              visualEditorUpdate();

              if ( typeof newLocName == 'undefined' ) {
                newLocName = 'newLocation';
              }

              newNodeStr = '<div class="locationNode" id="editorNodenewLocation"><span style="vertical-align: middle;" onchange="visualEditorUpdate()">Location: </span><textarea rows="1" cols="30" style="vertical-align: middle;">' + newLocName + '</textarea><span style="float: right;">';
              newNodeStr += $('nodeContainer').children.length;
              newNodeStr += '</span><br><br><span class="niftyButton">Add an Action</span><br><br>Adventure Text: <br><textarea rows="8" cols="80" class="adventureText">description</textarea><br><br>Button Text:&nbsp;<textarea rows="1" cols="20" style="vertical-align: middle;"></textarea>Button Destination:&nbsp;<input list="destinationList" style="vertical-align: middle;" onchange="visualEditorUpdate()"></input> View that node:&nbsp;<a href="#editorNodebottomnorope" style="text-decoration: none; color: black;"><button type="button" class="adventureButtonE"></button></a><button type="button" class="niftyButton" onclick="visDeleteButton(' + $("nodeContainer").children.length + '\"Go To Locaion\")">Delete This Button</button><br><br><span class="niftyButton">Add Button</span><span class="niftyButton">Add Text</span><br><br><span class="niftyButton" style="float: right; position: relative; top: -4vh" onclick="deleteEditorNode(';
              newNodeStr += $('nodeContainer').children.length;
              newNodeStr += ')">Delete This Location</span></div>';

              $('nodeContainer').innerHTML += newNodeStr;

              $('nodeContainerDiv').scrollTop=999999;

              document.querySelector("#editorNodenewLocation").children[1].focus();
              document.querySelector("#editorNodenewLocation").children[1].select();

              convertVisualEditorToString();

              reviewUserInput();

              convertArrayToVisual();

            }

            function visAddButtonCondition( theNode, theButtonNumber ) {

//              console.log( theNode + ", " + theButtonNumber );

              visualEditorUpdate();

              $( 'N' + theNode + 'B' + theButtonNumber ).innerHTML = getStringBeforeThirdButton( $( 'N' + theNode + 'B' + theButtonNumber ).innerHTML );

              $( 'N' + theNode + 'B' + theButtonNumber ).innerHTML = 'This button appears only if: <textarea rows="1" cols="50" class="buttonCondition"> 1 > 0 </textarea>' + $( 'N' + theNode + 'B' + theButtonNumber ).innerHTML


              // currentLocationEdited = buttonNode;
              visualEditorUpdate();


            }


            function getStringBeforeThirdButton(inputString) {
                // Find the index of the first occurrence of "</button>"
                const firstOccurrence = inputString.indexOf("</button>");

                // Find the index of the second occurrence of "</button>"
                const secondOccurrence = inputString.indexOf("</button>", firstOccurrence + 9); // 9 is the length of "</button>"

                // If the second occurrence is found, return the substring up to it
                if (secondOccurrence !== -1) {
                    return inputString.substring(0, secondOccurrence + 9);
                }

                // If there is no second occurrence, return the original string
                return inputString;
            }


            function findNthOccurrence(str, substr, n) {
                let count = 0;
                let index = -1;

                while (n > 0) {
                    index = str.indexOf(substr, index + 1);
                    if (index === -1) {
                        return -1; // Return -1 if the nth occurrence is not found
                    }
                    n--;
                }

                return index;
            }

            function visDeleteButton( buttonNode, buttonIndex ) {

//              console.log( "visDeleteButton(" + buttonNode + ", " + buttonIndex + ")");

              document.getElementById( "N" + buttonNode + "B" + buttonIndex ).remove();

              visualEditorUpdate();


            }



            function addAction( whichNode ) {
//              console.log('addAction('+whichNode+')');

              visualEditorUpdate();

              adventureArray[whichNode].toDo.push('@heal 0');

              convertArrayToVisual();

              convertVisualEditorToString();

              reviewUserInput();

            }

            function visAddFirstLaterLocation() {
//              console.log("visAddFirstLaterLocation()");

              visualEditorUpdate();

              closeDialogBoxes();

              // get name from authors

              $('newFirstLaterName').value = '';
              $('createFirstLaterDiv').style.display='block';

              document.querySelector("#newFirstLaterName").focus()
              document.querySelector("#newFirstLaterName").select()


            }

            function actuallyAddFirstLater() {
              console.log("actuallyAddFirstLaterLocation()");
              console.log($('newFirstLaterName').value);


              newFirstLaterName = $('newFirstLaterName').value.replace(/[^a-zA-Z0-9]/g, '');

              if ( placesWeCanGo.includes( newFirstLaterName ) ) {
                // we've already got one

                $('alreadyGotOne').style.display = 'block';

                return;
              }

              $('createFirstLaterDiv').style.display='none';

              // create variable nameVisited

              newVarNum = ( $('editorVariableBox').children.length - 1 ) / 2;

              newNodeStr = "<span id='" + newVarNum + "'>";
              newNodeStr += '<textarea rows="1" cols="20" style="vertical-align: middle;">' + newFirstLaterName+ 'Visited</textarea>';
              newNodeStr += " starts at ";
              newNodeStr += '<textarea rows="1" cols="8" style="vertical-align: middle;">0</textarea> ';
              newNodeStr += '<span class="niftyButton" style="font-size: 60%; vertical-align: middle">Delete This Variable</span></span><br>';

//              console.log("new variable = "+newNodeStr);
              // add new variable nameVisited to visEd
              $('editorVariableBox').innerHTML += newNodeStr;

              // create location nameFirst

              newNodeStr = '<div class="locationNode" id="editorNode' + newFirstLaterName + 'First"><span style="vertical-align: middle;">Location: </span><textarea rows="1" cols="30" style="vertical-align: middle;" onchange="visualEditorUpdate()">' + newFirstLaterName + 'First</textarea><span style="float: right;">';
              newNodeStr += $('nodeContainer').children.length;
              newNodeStr += '</span><br>';

              newNodeStr += '<select onchange="changeAction(' + $('nodeContainer').children.length + ',0,this.value)"><option value="h">Heal</option><option value="e">Rest</option><option value="d">Damage</option><option value="w">Writing</option><option value="x">Grant XP</option><option value="r">Remove Foe</option><option value="^" selected="">Reassign Variable</option></select>';


              newNodeStr += makeVariableMenu( newFirstLaterName + 'Visited' );

              newNodeStr += ' = <textarea rows="1" cols="30" style="vertical-align: middle;">1</textarea>';

              newNodeStr += '<span class="niftyButton" style="font-size: 60%; position: relative;" onclick="deleteAction(' + $('nodeContainer').children.length + ',0)">Delete This Action</span>';
              newNodeStr += '<br><br>';

              newNodeStr += '<span class="niftyButton">Add an Action</span><br><br>Adventure Text: <br><textarea rows="8" cols="80" class="adventureText">description for the first visit to ' + newFirstLaterName + '</textarea><br><br><br><span class="niftyButton" onclick="addButton(' + $('nodeContainer').children.length + ')">Add Button</span><span class="niftyButton">Add Text</span><br><br>';
              newNodeStr += '<span class="niftyButton" style="float: right; position: relative; top: -4vh" onclick="deleteEditorNode(';
              newNodeStr += $('nodeContainer').children.length;
              newNodeStr += ')">Delete2</span></div>';


              // add nameFirst to visEd
              console.log("new first loc = "+newNodeStr);
              $('nodeContainer').innerHTML += newNodeStr;

              // create location nameLater

              newNodeStr = '<div class="locationNode" id="editorNode' + newFirstLaterName + 'Later"><span style="vertical-align: middle;">Location: </span><textarea rows="1" cols="30" style="vertical-align: middle;"> onchange="visualEditorUpdate()"' + newFirstLaterName + 'Later</textarea><span style="float: right;">';
              newNodeStr += $('nodeContainer').children.length;
              newNodeStr += '</span><br><br><span class="niftyButton">Add an Action</span><br><br>Adventure Text: <br><textarea rows="8" cols="80" class="adventureText">description for later vists to ' + newFirstLaterName + '</textarea><br><br><br><span class="niftyButton" onclick="addButton(' + $('nodeContainer').children.length + ')">Add Button</span><span class="niftyButton">Add Text</span><br><br><span class="niftyButton" style="float: right; position: relative; top: -4vh" onclick="deleteEditorNode(';
              newNodeStr += $('nodeContainer').children.length;
              newNodeStr += ')">Delete This Location</span></div>';

//              console.log("new laterLoc = "+newNodeStr);

              // add nameLater to visEd
              $('nodeContainer').innerHTML += newNodeStr;

              // create branch name

              newNodeStr = "<div class='branchNode' id='editorNode" + newFirstLaterName + "''>Branch: ";
              newNodeStr += "<textarea rows='1' cols='30' style='vertical-align: middle;'>" + newFirstLaterName + "</textarea>";
              newNodeStr += "<span style='float: right;'>"+$('nodeContainer').children.length+"</span><br>";

              newNodeStr += "<textArea rows='1' cols='20'>" + newFirstLaterName + "Visited</textArea>" + "&nbsp;";
              newNodeStr += "<textArea rows='1' cols='3'>></textArea>" + "&nbsp;";
              newNodeStr += "<textArea rows='1' cols='20'>0</textArea>" + "<br>";

//              newNodeStr += "<br><span class='niftyButton'onclick='addBonus("+$('nodeContainer').children.length+")'>Add a Bonus</span><br><br>";

              // newNodeStr += "<span style='vertical-align: middle;'>True Destination:&nbsp;</span><textArea rows='1' cols='30' style='vertical-align: middle;' oninput = 'suggestDestination(event)'>" + newFirstLaterName + "Later</textArea>  go there now: <a href='#editorNode" + newFirstLaterName + "Later'>" + newFirstLaterName + "Later</a><br>";

              newNodeStr += "<span style='vertical-align: middle;'>True Destination:&nbsp;</span><input list='destinationList' style='vertical-align: middle;' value='" + newFirstLaterName + "Later'></input>  go there now: <a href='#editorNode" + newFirstLaterName + "Later'>" + newFirstLaterName + "Later</a><br>";

              // newNodeStr += "<span style='vertical-align: middle;'>False Destination:&nbsp;</span><textArea rows='1' cols='30' style='vertical-align: middle;' oninput = 'suggestDestination(event)'>" + newFirstLaterName + "First</textArea> go there now: <a href='#editorNode" + newFirstLaterName + "First'>" + newFirstLaterName + "First</a><br>";

              newNodeStr += "<span style='vertical-align: middle;'>False Destination:&nbsp;</span><input list='destinationList style='vertical-align: middle;' value='" + newFirstLaterName + "First'></input> go there now: <a href='#editorNode" + newFirstLaterName + "First'>" + newFirstLaterName + "First</a><br>";

                newNodeStr += "<span class='niftyButton' style='float: right; position: relative; top: -4vh' onclick='deleteEditorNode(" + $('nodeContainer').children.length + ")'>Delete This Branch</span>";

              newNodeStr += '</div>';

              // add branch to visEd
              $('nodeContainer').innerHTML += newNodeStr;

//              visualEditorUpdate();

//              $('nodeContainerDiv').scrollTop=999999;

              convertVisualEditorToString();

              reviewUserInput();

              convertArrayToVisual();

              $( 'editorNode' + newFirstLaterName).scrollIntoView();

            }

            function visAddVariable() {
              console.log("visAddVariable()");

              newVarNum = ( $('editorVariableBox').children.length - 1 ) / 2;

              newNodeStr = "<span id='" + newVarNum + "'>";
              newNodeStr += '<textarea rows="1" cols="20" style="vertical-align: middle;">newVariable</textarea>';
              newNodeStr += " starts at ";
              newNodeStr += '<textarea rows="1" cols="8" style="vertical-align: middle;">0</textarea> ';
              newNodeStr += ' zero destination (optional):';
              // newNodeStr += " <textArea rows='1' cols='16' style='vertical-align: middle;' oninput='suggestDestination(event)'></textarea>";
              newNodeStr += " <input list='destinationList' style='vertical-align: middle;'></input>";
              newNodeStr += '<span class="niftyButton" style="font-size: 60%; vertical-align: middle">Delete This Variable</span></span><br>';

              $('editorVariableBox').innerHTML += newNodeStr;

              convertVisualEditorToString();

              reviewUserInput();

              convertArrayToVisual();

              // this worked, but it selects the last var, not the new var
              // $('editorVariableBox').children[$('editorVariableBox').children.length-2].children[0].focus();
              // $('editorVariableBox').children[$('editorVariableBox').children.length-2].children[0].select();

              $('nodeContainerDiv').scrollTop=0;

              //chatGPT to the rescue...

              // Get all the text areas on the page
              const textAreas = document.querySelectorAll('textarea');

              // Loop through each text area to find the desired content
              for (let i = 0; i < textAreas.length; i++) {

                // Check if the content of the text area matches the desired content
                if ( textAreas[i].value === 'newVariable') {

                  textAreas[i].focus();
                  textAreas[i].select();

                }
              }


            }


            function visAddBranch( newBranchName ) {
//              console.log("visAddBranch()");

              visualEditorUpdate();

              if ( typeof newBranchName == 'undefined' ) {
                newBranchName = 'newBranch';
              }


              newNodeStr = "<div class='branchNode' id='editorNodenewBranch'>Branch: ";
              newNodeStr += "<textarea rows='1' cols='30' style='vertical-align: middle;'>" + newBranchName + "</textarea>";
              newNodeStr += "<span style='float: right;'>"+$('nodeContainer').children.length+"</span><br>";

              // newNodeStr += "<textArea rows='1' cols='20'>0</textArea>" + "&nbsp;";
              // newNodeStr += "<textArea rows='1' cols='3'>=</textArea>" + "&nbsp;";
              // newNodeStr += "<textArea rows='1' cols='20'>0</textArea>" + "<br>";

              newNodeStr += "<textArea rows='1' cols='20'> 1 > 0 </textArea><br>";


//              newNodeStr += "<br><span class='niftyButton' onclick='addBonus("+$('nodeContainer').children.length+")'>Add a Bonus</span><br><br>";

              newNodeStr += "<span style='vertical-align: middle;'>True Destination:&nbsp;</span><input list='destinationList' style='vertical-align: middle;' value='trueDestination'></input>  go there now: <a href='#editorNodetrueDestination'>trueDestination</a><br>";

              newNodeStr += "<span style='vertical-align: middle;'>False Destination:&nbsp;</span><input list='destinationList' style='vertical-align: middle;' value='falseDestination'></textArea> go there now: <a href='#editorNodefalseDestination'>falseDestination</a><br>";


                newNodeStr += "<span class='niftyButton' style='float: right; position: relative; top: -4vh' onclick='deleteEditorNode(" + $('nodeContainer').children.length + ")'>Delete This Branch</span>";

              newNodeStr += '</div>';

              $('nodeContainer').innerHTML += newNodeStr;

              $('nodeContainerDiv').scrollTop=999999;

              document.querySelector("#editorNodenewBranch").children[0].focus();
              document.querySelector("#editorNodenewBranch").children[0].select();

            }



            function showVisAddFoeDialog() {

              closeDialogBoxes();
              $('addNewFoeDiv').style.display='block';

              document.querySelector("#newFoeNameTextArea").focus();
              document.querySelector("#newFoeNameTextArea").select()

            }

            function addMissingFoe( newFoeName ) {

              $('newFoeNameTextArea').value = newFoeName;

              visAddFoe();

            }

            function visAddFoe() {

              visualEditorUpdate();

              const newFoeName = $('newFoeNameTextArea').value.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();

              if ( placesWeCanGo.includes( newFoeName ) ) {
                // we've already got one

                $('alreadyGotOne').style.display = 'block';

                return;
              }

              document.getElementById('addNewFoeDiv').style.display='none';

//              console.log("visAddFoe(" + newFoeName + ")");


                            const newFoe  = {
                                armor: 0,
                                combatIntro: "As you enter the passageway you sense motion and freeze, luckily your eyes adjust quickly to the low light and you see the " + newFoeName + " before it strikes...",
                                damage: "1d",
                                damage2: "",
                                dx: 11,
                                foeName: newFoeName,
                                foeType: -1,
                                iq: 5,
                                loseDestination: newFoeName + 'victorious',
                                ma: 10,
                                name: newFoeName,
                                noFoe: newFoeName + 'missing',
                                range: 2,
                                st: 6,
                                toDo: [],
                                type: "f",
                                winDestination: newFoeName + 'defeated',
                                xp: 20
                            };

                            adventureArray.push( JSON.parse(JSON.stringify( newFoe)) );


                            const emptyLocation = {
                              type: "l",
                              name: 'nameless',
                              toDo: [],
                              html: "This location has not been described yet.",
                            };

                            emptyLocation.name = newFoeName + 'victorious';
                            emptyLocation.html = 'The ' + newFoeName + ' is victorious, the game is at an end.';
                            adventureArray.push( JSON.parse(JSON.stringify(emptyLocation)) );

                            emptyLocation.name = newFoeName + 'missing';
                            emptyLocation.html = 'The ' + newFoeName + ' is not present...';
                            adventureArray.push( JSON.parse(JSON.stringify(emptyLocation)) );

                            emptyLocation.name = newFoeName + 'defeated';
                            emptyLocation.html = 'You have defeated the ' + newFoeName + '!';
                            adventureArray.push( JSON.parse(JSON.stringify(emptyLocation)) );

                            convertArrayToVisual();

                            convertVisualEditorToString();

                            reviewUserInput();

                            // $('nodeContainerDiv').scrollTop = 99999;

                            $( 'editorNode' + newFoeName ).scrollIntoView();
            }

            function visUndelete() {
//              console.log("visUndelete()");

              if ( deletedNodes.length == 0 ) {
                restorableNodes = "There are no deleted nodes in the graveyard.";

              } else {
                restorableNodes = "";

                for ( let i=0; i < deletedNodes.length; i++ ) {

                  restorableNodes += "<span onclick='restoreDeletedNode(" + i + ")'>";
                  restorableNodes += deletedNodes[i].nodeNumber + " ";
                  restorableNodes += "(" + deletedNodes[i].nodeType + ") ";
                  restorableNodes += deletedNodes[i].nodeName + " ";
                  restorableNodes += "</span><br>";
                }
              }

              $('deletedNodesMenu').innerHTML = restorableNodes;

              $('undeleteNodeBox').style.display = 'block';


            }

            function restoreDeletedNode( nodeToRestore ) {
              console.log( "restoreDeletedNode(" + nodeToRestore + ")" );

              $('undeleteNodeBox').style.display = 'none';


              restoredElement = document.createElement('div');

              restoredElement.innerHTML = deletedNodes[ nodeToRestore].nodeHTML ;

              $('nodeContainer').insertBefore( restoredElement, $('nodeContainer').children[ deletedNodes[ nodeToRestore].nodeNumber ] );

              $('nodeContainer').children[ deletedNodes[ nodeToRestore].nodeNumber  ].classList.add(  deletedNodes[ nodeToRestore].nodeType + "Node" );

              $('nodeContainer').children[ deletedNodes[ nodeToRestore].nodeNumber  ].id = 'editorNode' + deletedNodes[ nodeToRestore].nodeName;

              deletedNodes.splice( nodeToRestore, 1 );

              convertVisualEditorToString();

              reviewUserInput();

              convertArrayToVisual();

            }


            function visCreateMissingNodes() {
//              console.log("visCreateMissingNodes()");

              missingFoes = foesWeTryToRemove.filter( x => !foesThatExist.includes(x) );

              const newFoe  = {
                  armor: 0,
                  combatIntro: "As you enter the passageway you sense motion and freeze, luckily your eyes adjust quickly to the low light and you see the giant rat before he strikes...",
                  damage: "1d",
                  damage2: "",
                  dx: 11,
                  foeName: "Giant Rat",
                  foeType: -1,
                  iq: 5,
                  loseDestination: "died",
                  ma: 10,
                  name: "giantrat",
                  noFoe: "noeFoeLocation",
                  range: 2,
                  st: 6,
                  toDo: [],
                  type: "f",
                  winDestination: "winDestination",
                  xp: 20
              };

              for ( i =0; i < missingFoes.length; i++ ) {

                newFoe.name = missingFoes[i];
                newFoe.noFoe = missingFoes[i] + 'missing';
                newFoe.winDestination = missingFoes[i] + 'defeated';
                newFoe.loseDestination = missingFoes[i] + 'victorious';

                missingLocations.push( {missingLoc: missingFoes[i] + 'missing', source: [missingFoes[i]] } );
                missingLocations.push( {missingLoc: missingFoes[i] + 'defeated', source: [missingFoes[i]] } );
                missingLocations.push( {missingLoc: missingFoes[i] + 'victorious', source: [missingFoes[i]] } );

                adventureArray.push( JSON.parse(JSON.stringify( newFoe)) );

              }



              const emptyLocation = {
                type: "l",
                name: 'nameless',
                toDo: [],
                html: "This location has not been described yet.",
              };

              for ( missingLocationIndex = 0; missingLocationIndex < missingLocations.length; missingLocationIndex++ ) {

                  emptyLocation.name = missingLocations[ missingLocationIndex ].missingLoc;
                  emptyLocation.html = "This location has not been described yet. It can be reached from the nodes: ";
                  for ( let sourceIndex = 0; sourceIndex < missingLocations[ missingLocationIndex ].source.length; sourceIndex++ ) {
                    emptyLocation.html += missingLocations[ missingLocationIndex ].source[sourceIndex] + " ";
                  }
                  adventureArray.push( JSON.parse(JSON.stringify(emptyLocation)) );
              }


              convertArrayToVisual();

              convertVisualEditorToString();

              reviewUserInput();

              $('nodeContainerDiv').scrollTop = 99999;

            }


            function confirmOverwrite( overWriteType ) {
//              console.log("visClearAllNodes()");

//              confirmDialog( "This is irreversible, are you sure you want to delete all everything?", "overwrite='enterTemplate'; overwriteFunction(); $('nodeContainerDiv').scrollTop=0" );
              confirmDialog( "This will overwrite the current adventure and cannot be undone. <br><br> Are you sure?", "overwrite='" + overWriteType + "';overwriteFunction(); $('overwriteDiv').style.display='block'" );

            }


            function textUpdate() {

//              console.log("textUpdate()");

              reviewUserInput();

              convertArrayToVisual();

            }


            function makeVariableMenu( selectedVariable ) {

              variableMenu = "<select>";
              varFound = false;

              for ( let i = 0; i < visualVariableArray.length; i++ ){

                variableMenu += "<option value='" + visualVariableArray[i].varName + "'";

//                variableMenu += "onchange='queueVisualEditorUpdate()'";
                variableMenu += "onchange='visualEditorUpdate()'";

                if ( selectedVariable == visualVariableArray[i].varName ) {
                  variableMenu += " selected";
                  varFound = true;
                }

                variableMenu += ">";
                variableMenu += visualVariableArray[i].varName;
                variableMenu += "</option>";

              }

              if ( !varFound ) {

                variableMenu += "<option value='" + selectedVariable + "'";
                variableMenu += "onchange='visualEditorUpdate()'";
                variableMenu += " selected";
                variableMenu += ">";
                variableMenu += selectedVariable;
                variableMenu += "</option>";

              }

              variableMenu += "</select>";

              return variableMenu;

            }

            function makeFoeMenu( selectedVariable ) {

              variableMenu = "<select>";

              if ( foesThatExist.length > 0 ) {

                for ( let i = 0; i < foesThatExist.length; i++ ){

                  variableMenu += "<option value='" + visualVariableArray[i].varName + "'";

  //                variableMenu += "onchange='queueVisualEditorUpdate()'";
                  variableMenu += "onchange='visualEditorUpdate()'";

                  if ( selectedVariable == visualVariableArray[i].varName ) {
                    variableMenu += " selected"
                  }

                  variableMenu += ">";
                  variableMenu += visualVariableArray[i].varName;
                  variableMenu += "</option>";

                }

              } else {
                "<option value='-1' onchange='visualEditorUpdate()'>no foes defined</option>"
              }

              variableMenu += "</select>";

              return variableMenu;

            }

            function convertArrayToVisual() {
//              console.log("convertArrayToVisual()");
//              console.log( 'userInputTextArea is ' + $('userInputTextArea').value.split('\n').length + " lines long.");

              // console.log(adventureArray[6].comparisonExpression);
              // if ( typeof getEditorNode(6) != 'undefined') {
              //
              //   console.log(getEditorNode(6).children[3].value);
              //
              // }

              $('editorTitleSpan').innerHTML = titleStr;
              $("editorCreatorSpan").innerHTML = creatorStr;

              $("editorTitle").innerHTML = titleStr;
              $("editorCreator").innerHTML = creatorStr;

              // $("editorTestMode").innerHTML = testMode;

              if ( testMode > 0 ) {
                $('testModeSelector').value = 1;
              } else {
                $('testModeSelector').value = 0;
              }

              $("editorMaxAttr").innerHTML = maxAttr;
              $("editorDescription").innerHTML = descriptionStr;

              visualVariableArray = variableArray.filter( whatever => whatever.varType=='U' );

              if ( visualVariableArray.length == 0 ) {
                $("editorVariableBox").innerHTML = 'no variables';
              } else {
                $("editorVariableBox").innerHTML = 'Variables:<br>';
                for ( let i = 0; i < visualVariableArray.length; i++ ){

                    // $("editorVariableBox").innerHTML += "<span id='variableNumber" + i + "'><textArea rows='1' cols='20' style='vertical-align: middle;'>" + visualVariableArray[i].varName +
                    //     "</textarea> starts at <textArea rows='1' cols='8' style='vertical-align: middle;'>" + visualVariableArray[i].varValue + '</textarea> ' +
                    //     "<span class='niftyButton' style='font-size: 60%; position: relative; top: -1vh; vertical-align: bottom;' onclick='deleteVariable(" + i + ")'>Delete This Variable</span></span><br>";

                    // $("editorVariableBox").innerHTML += "<span id='variableNumber" + i + "'><textArea rows='1' cols='20' style='vertical-align: middle;'>" + visualVariableArray[i].varName +
                    //     "</textarea> starts at <textArea rows='1' cols='8' style='vertical-align: middle;'>" + visualVariableArray[i].varInitiator + '</textarea> ' +
                    //     " zero destination (optional): <textArea rows='1' cols='16' style='vertical-align: middle;' oninput='suggestDestination(event)'>" + visualVariableArray[i].varZeroDestination + '</textarea>' +
                    //     "<span class='nodeEditorButton' style='font-size: 60%; position: relative; top: -1vh; vertical-align: bottom;' onclick='deleteVariable(" + i + ")'>Delete This Variable</span></span><br>";

                    $("editorVariableBox").innerHTML += "<span id='variableNumber" + i + "'><textArea rows='1' cols='20' style='vertical-align: middle;'>" + visualVariableArray[i].varName +
                        "</textarea> starts at <textArea rows='1' cols='8' style='vertical-align: middle;'>" + visualVariableArray[i].varInitiator + '</textarea> ' +
                        " zero destination (optional): <input list='destinationList' style='vertical-align: middle;' value='" + visualVariableArray[i].varZeroDestination +"'>"+ '</input>' +
                        "<span class='nodeEditorButton' style='font-size: 60%; vertical-align: middle;' onclick='deleteVariable(" + i + ")'>Delete This Variable</span></span><br>";


                }
              }



              newNodeStr = '';
              for ( let i = 0; i < adventureArray.length; i++ ) {

                switch (adventureArray[i].type) {
                  case 'l':
                    newNodeStr += "<div class='locationNode' id='editorNode" + adventureArray[i].name + "'><span style='vertical-align: middle;' onchange='visualEditorUpdate()'>Location: </span>";
                    newNodeStr += "<textArea rows='1' cols='30' style='vertical-align: middle;'>" + adventureArray[i].name + "</textArea>";
                    newNodeStr += "<span style='float: right;'>"+i+"</span><br>";

                    for ( let j = 0; j < adventureArray[i].toDo.length; j++ ) {


                      newNodeStr += "<select onchange =\"changeAction(" + i + "," + j + ",this.value)\">";

                      newNodeStr += "<option value='h'";
                      if ( adventureArray[i].toDo[j][1] == 'h' && adventureArray[i].toDo[j][0] != '^' ) {
                        thisType='h';
                        actionOperand = adventureArray[i].toDo[j].substr(5,999).trim();
                        newNodeStr += " selected";
                      }
                      newNodeStr += ">Heal</option>";

                      newNodeStr += "<option value='e'";
                      if ( adventureArray[i].toDo[j].substr(1,3) == 'res' && adventureArray[i].toDo[j][0] != '^' ) {
                        thisType='e';
                        actionOperand = adventureArray[i].toDo[j].substr(5,999).trim();
                        newNodeStr += " selected";
                      }
                      newNodeStr += ">Rest</option>";

                      newNodeStr += "<option value='d'";
                      if ( adventureArray[i].toDo[j][1] == 'd' && adventureArray[i].toDo[j][0] != '^' ) {
                        thisType='d';
                        actionOperand = adventureArray[i].toDo[j].substr(7,999).trim();
                        newNodeStr += " selected";
                      }
                      newNodeStr += ">Damage</option>";

                      newNodeStr += "<option value='w'";
                      if ( adventureArray[i].toDo[j][1] == 'w' && adventureArray[i].toDo[j][0] != '^' ) {
                        thisType='w';
                        actionOperand = adventureArray[i].writing;
                        newNodeStr += " selected";
                      }
                      newNodeStr += ">Writing</option>";

                      newNodeStr += "<option value='x'";
                      if ( adventureArray[i].toDo[j][1] == 'x' && adventureArray[i].toDo[j][0] != '^' ) {
                        thisType='x';
                        actionOperand = adventureArray[i].toDo[j].substr(3,999).trim();
                        newNodeStr += " selected";
                      }
                      newNodeStr += ">Grant XP</option>";

                      newNodeStr += "<option value='r'";
                      if ( adventureArray[i].toDo[j].substr(1,4) == 'remo' && adventureArray[i].toDo[j][0] != '^' ) {
                        thisType='r';
                        actionOperand = adventureArray[i].toDo[j].substr(10,999).trim();
                        newNodeStr += " selected";
                      }
                      newNodeStr += ">Remove Foe</option>";

                      newNodeStr += "<option value='m'";
                      if ( adventureArray[i].toDo[j].substr(1,4) == 'reme' && adventureArray[i].toDo[j][0] != '^' ) {
                        thisType='m';
                        actionOperand = adventureArray[i].toDo[j].substr(9,999).trim();
                        newNodeStr += " selected";
                      }
                      newNodeStr += ">Remember</option>";

                      newNodeStr += "<option value='^'";
                      if ( adventureArray[i].toDo[j][0] == '^' ) {
                        thisType='^';
                        actionOperand = adventureArray[i].toDo[j].substr(1,999).trim();
                        newNodeStr += " selected";
                      }
                      newNodeStr += ">Reassign Variable</option>";

                      newNodeStr += "</select>";

                      switch( thisType ) {
                        case 'h':
                        case 'e':
                        case 'x':
                          newNodeStr += "<textarea rows='1' cols ='4' style='vertical-align: middle;'>" + actionOperand + "</textarea>";
                          break;
                          case 'r':
                          case 'm':
                          newNodeStr += "<textarea rows='1' cols ='15' style='vertical-align: middle;'>" + actionOperand + "</textarea>";

                          // newNodeStr += makeFoeMenu( ); // insert foe name menu
                          break;
                        case 'w':
                          newNodeStr += "<textarea rows='1' cols ='70' style='vertical-align: middle;'>" + actionOperand + "</textarea>";
                          break;
                        case 'd':
                          //2/23/23 update
                          // varName = actionOperand.substr( 0, actionOperand.indexOf(' ') ).trim();
                          // newValue = actionOperand.substr( actionOperand.indexOf(' ')+1, 9999 ).trim();
                          varName = actionOperand.substr( 0, actionOperand.lastIndexOf(' ') ).trim();
                          newValue = actionOperand.substr( actionOperand.lastIndexOf(' ')+1, 9999 ).trim();
                          newNodeStr += "<textarea rows='1' cols ='20' style='vertical-align: middle;'>" + varName + "</textarea> and if that takes HP below 0 go to <textarea rows='1' cols ='20' style='vertical-align: middle;'>" + newValue + "</textarea>";
                          newNodeStr += " go there now: <a href='#editorNode" + newValue + "'>" + newValue + "</a>";
                          break;
                        case '^':
                          varName = actionOperand.substr( 0, actionOperand.indexOf('=') ).trim();
                          newValue = actionOperand.substr( actionOperand.indexOf('=')+1, 9999 ).trim();
//                          console.log(i+","+j+","+actionOperand);
                          // newNodeStr += "<textarea rows='1' cols ='30'>" + varName + "</textarea><textarea rows='1' cols ='60'>" + newValue + "</textarea>";

//                          newNodeStr += variableMenu + " = ";

                          newNodeStr += makeVariableMenu( varName ) + " = ";

                          newNodeStr += "<textarea rows='1' cols ='30' style='vertical-align: middle;'>" + newValue + "</textarea>";
                          break;
                        }

                      newNodeStr += "<span class='nodeEditorButton' style='font-size: 60%; position: relative;' onclick =\"deleteAction(" + i + "," + j + ")\">Delete This Action</span><br>";

                    } //  next j - item in the toDo list


                    newNodeStr += "<br><span class='nodeEditorButton' onclick='addAction(" + i + ")'>Add an Action</span><br><br>";


                    atLeastOneAdventureText = 0;
                    buttonNumber = 0;
                    lastButtonWasConditional = 0;

//                    locationLines = adventureArray[i].html.split('<br>').filter( x => x.trim() !='' );
                    locationLines = adventureArray[i].html.split('<br>');

                    // continue building newNodeStr
                    // each line starts with either "<div" or "@if" or it's adventure text




                    for ( let htmlLine = 0; htmlLine < locationLines.length; htmlLine++ ) {

                      switch( locationLines[ htmlLine ].substring( 0, 3 ).toLowerCase() ) {

                        case '<di': // this line is a button

                          newNodeStr += '<div id="N' + i + 'B' + ( buttonNumber + 1 ) + '">';
                          newNodeStr += buttonParse( i, locationLines[ htmlLine ] );
                          newNodeStr += '</div>';
                          break;

                        case '@if': // it's a conditional for adventure text or buttonNode
                          if ( locationLines[ htmlLine + 1 ].substring( 0, 3 ).toLowerCase() == "<di" ) {
                            // conditional for a button

                            newNodeStr += '<div id="N' + i + 'B' + ( buttonNumber + 1 ) + '">';
                            newNodeStr += "This button appears only if: <textarea rows='1' cols='50' class='buttonCondition'>" + locationLines[ htmlLine ].substring(3).trim() + "</textarea><br>";

                            lastButtonWasConditional = 1;

//                            while ( locationLines[ ++htmlLine ].trim() == '' ){}

                            newNodeStr += buttonParse( i, locationLines[ ++htmlLine ] );
                            newNodeStr += '</div>';

                          } else {
                            //conditional for adventureText

                            newNodeStr += "This text appears only if: <textarea rows='1' cols='50' class='textCondition'>" + locationLines[ htmlLine ].substring(3).trim() + "</textarea><br>";

                            newNodeStr += "Adventure Text: <br><textarea rows='8' cols='80'  class='adventureText'>" + locationLines[ ++htmlLine ];
                            newNodeStr += "</textarea>";
                            newNodeStr += "<br><br>";

                          }
                          break;

                        default: // it must be adventureText

                          if ( locationLines[ htmlLine ].trim() != '' ) {

                          newNodeStr += "Adventure Text: <br><textarea rows='8' cols='80'  class='adventureText'>";

//                          console.log( locationLines[i] );
//  while ( htmlLine < locationLines.length && !["<di","@if"].includes( locationLines[i].substring(0,3) ) ){
                            while ( htmlLine < locationLines.length && locationLines[ htmlLine ].substring(0,3) != "<di" && locationLines[ htmlLine ].substring(0,3) != "@if"  ) {

//console.log('adding '+locationLines[ htmlLine ]);
                            // if ( locationLines[ htmlLine ] == '\n' ) {
                            //   console.log( 'adding blank line for ' + adventureArray[i].name );
                            // }

                            newNodeStr += locationLines[ htmlLine ] + '\n';
                            htmlLine++;

                          }

                          newNodeStr += "</textarea>";
                          newNodeStr += "<br><br>";
                          htmlLine--;

                        }

                      }


                    }




                    // add buttons to add adventure text or buttons

                    newNodeStr += "<span class='nodeEditorButton' onclick='addButton("+i+")'>Add Button</span><span class='nodeEditorButton' onclick='addText("+i+")'>Add Text</span><br><br>";

                    if ( i > 0 ) {
                      newNodeStr += "<span class='nodeEditorButton' style='float: right; position: relative; top: -4vh' onclick='deleteEditorNode(" + i + ")'>Delete This Location</span>";
                    }

                    newNodeStr += '</div>';

                    break;

                  case 'b':
                    newNodeStr += "<div class='branchNode'id='editorNode" + adventureArray[i].name + "'>Branch: ";
                    newNodeStr += "<textarea rows='1' cols='30' style='vertical-align: middle;'>" + adventureArray[i].name + "</textarea>";
                    newNodeStr += "<span style='float: right;'>"+i+"</span><br>";


                    // 8/26/24 we converted three elements in the branch object to one
                    // newNodeStr += "<textArea rows='1' cols='20'>" + adventureArray[i].firstExpression + "</textArea>" + "&nbsp;";
                    // newNodeStr += "<textArea rows='1' cols='3'>" + adventureArray[i].comparator + "</textArea>" + "&nbsp;";
                    // newNodeStr += "<textArea rows='1' cols='20'>" + adventureArray[i].secondExpression + "</textArea>" + "<br>";

//                    console.log(adventureArray[i].comparisonExpression);

                    newNodeStr += 'Branch Expression:&nbsp;';
                    newNodeStr += "<textArea rows='1' cols='70'>" + adventureArray[i].comparisonExpression + "</textArea>" + "<br>";


                    // newNodeStr += "<span style='vertical-align: middle;'>True Destination:&nbsp;</span><textArea rows='1' cols='30' style='vertical-align: middle;' oninput='suggestDestination(event)'>" + adventureArray[i].destinationTrue + "</textArea>  go there now: <a href='#editorNode" + adventureArray[i].destinationTrue + "'>" + adventureArray[i].destinationTrue + "</a><br>";
                    //
                    // newNodeStr += "<span style='vertical-align: middle;'>False Destination:&nbsp;</span><textArea rows='1' cols='30' style='vertical-align: middle;' oninput='suggestDestination(event)'>" + adventureArray[i].destinationFalse + "</textArea> go there now: <a href='#editorNode" + adventureArray[i].destinationFalse + "'>" + adventureArray[i].destinationFalse + "</a><br>";
                    //

                    newNodeStr += "<span style='vertical-align: middle;'>True Destination:&nbsp;</span><input list='destinationList' style='vertical-align: middle;' value='" + adventureArray[i].destinationTrue + "'></input>  go there now: <a href='#editorNode" + adventureArray[i].destinationTrue + "'>" + adventureArray[i].destinationTrue + "</a><br>";

                    newNodeStr += "<span style='vertical-align: middle;'>False Destination:&nbsp;</span><input list='destinationList' style='vertical-align: middle;' value='" + adventureArray[i].destinationFalse + "'></input> go there now: <a href='#editorNode" + adventureArray[i].destinationFalse + "'>" + adventureArray[i].destinationFalse + "</a><br>";

                    if ( i > 0 ) {
                      newNodeStr += "<span class='nodeEditorButton' style='float: right; position: relative; top: -4vh' onclick='deleteEditorNode(" + i + ")'>Delete This Branch</span>";
                    }

                    newNodeStr += '</div>';
                    break;

                  case 'f':
                    newNodeStr += "<div class='foeNode'id='editorNode" + adventureArray[i].name + "'>Foe: ";
                    newNodeStr += "<textarea rows='1' cols='30' style='vertical-align: middle;'>" + adventureArray[i].name + "</textarea>";
                    newNodeStr += "<span style='float: right;'>"+i+"</span><br>";

                    newNodeStr += "<span style='vertical-align: middle;'>Combat Intro Text:&nbsp;</span><br><textArea rows='5' cols='80' style='vertical-align: middle;'>" + adventureArray[i].combatIntro + '</textArea><br>';

                    newNodeStr += "<span style='vertical-align: middle;'>Type:&nbsp;</span>";
                    newNodeStr += gimmeFoeTypeSelectHTMLFor( adventureArray[i].foeType ) + "<br>";

                    newNodeStr += "<span style='vertical-align: middle;'>Foe Name:&nbsp;</span><textArea rows='1' cols='30' style='vertical-align: middle;'>" + adventureArray[i].foeName + '</textArea><br>';
                    newNodeStr += "<span style='vertical-align: middle;'>ST:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].st + '</textArea><br>';
                    newNodeStr += "<span style='vertical-align: middle;'>DX:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].dx + '</textArea><br>';
                    newNodeStr += "<span style='vertical-align: middle;'>IQ:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].iq + '</textArea><br>';
                    newNodeStr += "<span style='vertical-align: middle;'>MA:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].ma + '</textArea><br>';
                    newNodeStr += "<span style='vertical-align: middle;'>Armor:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].armor + '</textArea><br>';
                    newNodeStr += "<span style='vertical-align: middle;'>Damage:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].damage +  '</textArea> primary weapon<br>';
                    newNodeStr += "<span style='vertical-align: middle;'>Damage:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].damage2 + '</textArea> secondary weapon<br>';
                    newNodeStr += "<span style='vertical-align: middle;'>Range:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].range + '</textArea><br>';
                    newNodeStr += "<span style='vertical-align: middle;'>XP:&nbsp;</span><textArea rows='1' cols='3' style='vertical-align: middle;'>" + adventureArray[i].xp + '</textArea><br>';
                    newNodeStr += "<span style='vertical-align: middle;'>Win Destination:&nbsp;</span><input list='destinationList' style='vertical-align: middle;' value='"+adventureArray[i].winDestination+"'>" + '</input> go there now: ' + "<a href='#editorNode" + adventureArray[i].winDestination + "'>" + adventureArray[i].winDestination + "</a><br>";
                    newNodeStr += "<span style='vertical-align: middle;'>Lose Destination:&nbsp;</span><input list='destinationList' style='vertical-align: middle;' value='"+adventureArray[i].loseDestination+"'>" + '</input> go there now: ' + "<a href='#editorNode" + adventureArray[i].loseDestination + "'>" + adventureArray[i].loseDestination + "</a><br>";
                    newNodeStr += "<span style='vertical-align: middle;'>No Foe:&nbsp;</span><input list='destinationList' style='vertical-align: middle;' value='" + adventureArray[i].noFoe + "'>" + '</input> go there now: ' + "<a href='#editorNode" + adventureArray[i].noFoe + "'>" + adventureArray[i].noFoe + "</a><br>";

                    if ( i > 0 ) {
                      newNodeStr += "<span class='nodeEditorButton' style='float: right; position: relative; top: -4vh' onclick='deleteEditorNode(" + i + ")'>Delete This Foe</span><span class='nodeEditorButton' style='float: right; position: relative; top: -4vh' onclick='deleteEditorNode(" + i + ",1)'>Delete This Foe & Outcome Nodes</span>";
                    }

                    newNodeStr += '</div>';
                    break;

                  default:
                    newNodeStr += "mystery node with no type: ";
                    newNodeStr += adventureArray[i].name + "<br>";

                }


              } // next i - looping adventureArray


              $('nodeContainer').innerHTML = newNodeStr;

              // console.log(adventureArray[6].comparisonExpression);
              // console.log(getEditorNode(6).children[3].value);

              // destinationAreas = document.querySelectorAll('.destinationTextArea');
              //
              // destinationAreas.forEach( (textarea) => { textarea.addEventListener( 'input', suggestDestination ) } );
              //
              ncSelects = $('nodeContainerDiv').querySelectorAll('select');

              ncSelects.forEach( element  => element.addEventListener( 'change', visualEditorUpdate ) );

              ncTextAreas = $('nodeContainerDiv').querySelectorAll('textarea');

              ncTextAreas.forEach( element => {
                element.addEventListener('click', ncClick );
                element.addEventListener('keydown', ncKeydown );
              });

//              console.log( 'userInputTextArea is ' + $('userInputTextArea').value.split('\n').length + " lines long.");

                document.getElementById('nodeContainerDiv').querySelectorAll('a').forEach(link => link.style.color = 'darkblue');


            } // end of convertArrayToVisual()


            function buttonParse( theNode, theString ) {

//              console.log( "buttonParse(" + theString + ")");

              buttonNumber++;

              buttonDestinationStart = theString.indexOf( 'adventureGo("' ) + 13;
              if ( buttonDestinationStart == 11 )
                console.log( "Something has gone terribly wrong in buttonParse('" + theString + "'");
              buttonDestinationEnd = theString.indexOf( '")' );
              buttonDestination = theString.substring( buttonDestinationStart, buttonDestinationEnd );

              buttonLabelStart = theString.indexOf('>') + 1;
              buttonLabelEnd = theString.indexOf('</d');
              buttonLabel = theString.substring( buttonLabelStart, buttonLabelEnd );

//              console.log( buttonLabel + '=>' + buttonDestination );

              nextButtonString = "<br>Button Text:&nbsp;";
              nextButtonString += "<textarea rows='1' cols='20' style='vertical-align: middle;' class='buttonText'>";
              nextButtonString += buttonLabel;
              nextButtonString += "</textarea>";

              nextButtonString += " Button Destination:&nbsp;<input list='destinationList' style='vertical-align: middle;' value='" + buttonDestination + "' onchange='visualEditorUpdate()'>";
//              nextButtonString += " Button Destination:&nbsp;<textarea rows='1' cols='20' style='vertical-align: middle;' class='destinationTextArea'>";
//              nextButtonString += " Button Destination:&nbsp;<textarea rows='1' cols='20' style='vertical-align: middle;' class='destinationTextArea'>";
//              nextButtonString += buttonDestination;
              nextButtonString += "</input>";

//              console.log( theNode + ": " + buttonDestination );

              nextButtonString += " View that node:&nbsp;";
              nextButtonString += "<a href='#editorNode";
              nextButtonString += buttonDestination;
              nextButtonString += "' style='text-decoration: none; color: black;'>";
              nextButtonString += "<button type='button' class='adventureButtonE'>";
              nextButtonString += buttonLabel;
              nextButtonString += "</button>";
              nextButtonString += "</a><button type='button' class='nodeEditorButton' onclick='visDeleteButton(";
              nextButtonString += theNode + "," + buttonNumber + ")'>Delete This Button</button>";

              if ( lastButtonWasConditional == 0 ) {

                // nextButtonString += "<button type='button' class='niftyButton' onclick='visAddButtonCondition(";
                // nextButtonString += i + "," + buttonNumber + ")'>Add a Condition</button>";

                nextButtonString += "<button type='button' class='nodeEditorButton' onclick='visAddButtonCondition(";
                nextButtonString += theNode + "," + buttonNumber + ")'>Add a Condition</button>";

              } else {

                lastButtonWasConditional = 0;

              }

              nextButtonString += "<br><br><hr style='width: 70%'>";


              return nextButtonString;

            }


            function tabHideSuggestions(event) {

              if ( event.key == 'Tab' ) {

                hideDestinationSuggestionBox();

              }


            }

            function hideDestinationSuggestionBox() {

              if (!$('nodeNameSuggestions').contains(event.target)) {

                $('nodeNameSuggestions').style.display = 'none';

              }

            }

//             function suggestDestination( theEvent ) {
//
// //             console.log(theEvent);
// //              console.log( theEvent.target.value );
//
// //              console.log(theEvent.target.id);
//
// //              console.log( getDomPath( theEvent.target ) );
//
//                 if ( theEvent.inputType == 'insertLineBreak' ) {
//                   query = query.slice(0,-1);
//                 }
//
//
//               targetTextArea = getDomPath( theEvent.target );
//
//               query = theEvent.target.value.toLowerCase();
//
//               if ( theEvent.inputType == 'insertLineBreak' ) {
//                 query = query.slice(0,-1);
//               }
//
//               const suggestions = placesWeCanGo.filter(x=>x.startsWith( query ));
//
//               if ( theEvent.inputType == 'insertLineBreak' && suggestions.length == 1 ) {
//
//                 theEvent.target.value = suggestions[0];
//                 suggestionsBox.style.display = 'none';
//
//                 postDestinationScroll = $('nodeContainerDiv').scrollTop;
//                 focusedElement = document.activeElement;
//
//                 visualEditorUpdate();
//
//
//                 setTimeout(function() {
//                     $('nodeContainerDiv').scrollTop = postDestinationScroll;
//                     focusedElement.focus();
//                 }, 10);
//
//                 return;
//
//               } else {
//
//               }
//
//               suggestionsBox = $('nodeNameSuggestions');
//
//               suggestionsBox.innerHTML = '';
//               if (suggestions.length > 0 && query.length > 0) {
//
//                   suggestionsBox.style.display = 'block';
//                   // document.addEventListener('click', hideDestinationSuggestionBox);
//                   // console.log('Event listener added');
//
//                   suggestions.forEach(function(suggestion) {
//                       const suggestionItem = document.createElement('div');
//                       suggestionItem.textContent = suggestion;
//                       suggestionsBox.appendChild(suggestionItem);
//
//                       suggestionItem.addEventListener('click',function() { changeDestination( targetTextArea, suggestion ) } );
//
//                   });
//
//                   suggestionsBox.style.left = theEvent.target.getBoundingClientRect().right + 'px';
//                   suggestionsBox.style.top = theEvent.target.getBoundingClientRect().top + theEvent.target.getBoundingClientRect().height / 2 - suggestionsBox.getBoundingClientRect().height / 2 + 'px';
//
//               } else {
//                   suggestionsBox.style.display = 'none';
//               }
//
//
//             }


            function changeDestination( theTA, theNewValue ) {

//              console.log(theTA);
//
//              $(theTA).value = theNewValue;
//              $('lookatme').removeAttribute('id');

//              theTA.value = theNewValue;

              document.querySelector( theTA ).value = theNewValue;

              $('nodeNameSuggestions').style.display = 'none';
//              console.log(theNewValue);
//              console.log(theTA);

              visualEditorUpdate();

            }

            function getDomPath(element) {
                if (!element) return '';
                var path = [];

                while (element.nodeType === Node.ELEMENT_NODE) {
                    var selector = element.nodeName.toLowerCase();
                    if (element.id) {
                        selector += '#' + element.id;
                        path.unshift(selector);
                        break;
                    } else {
                        var sib = element, nth = 1;
                        while (sib = sib.previousElementSibling) {
                            if (sib.nodeName.toLowerCase() == selector)
                                nth++;
                        }
                        if (nth != 1)
                            selector += ":nth-of-type(" + nth + ")";
                    }
                    path.unshift(selector);
                    element = element.parentNode;
                }
                return path.join(" > ");
            }



            function addButton( toNode ) {

//              console.log('addButton(' + toNode + ')');

              visualEditorUpdate();

//              console.log( adventureArray[ toNode ].html.length );

//              adventureArray[ toNode ].html = adventureArray[ toNode ].html.slice(0,adventureArray[ toNode ].html.length-4);

              adventureArray[ toNode ].html += "<div class='adventureButton' onclick = 'adventureGo(\"location\")'>Go To Location</div><br><br>";

//              console.log( adventureArray[ toNode ].html.length );
//              console.log( $('nodeContainer').children[toNode].children.length )

              convertArrayToVisual();

//              console.log( $('nodeContainer').children[toNode].children.length )

//              console.log( adventureArray[ toNode ].html.length );

//              console.log( $('userInputTextArea').value.length );

              convertVisualEditorToString();

//              console.log( $('userInputTextArea').value.length );

//              console.log( adventureArray[ toNode ].html.length );

            } // end of addButton(toNode)

            function addText( toNode ) {
              console.log('addText(' + toNode + ')');

              adventureArray[ toNode ].html += "more text";

              convertArrayToVisual();
              convertVisualEditorToString();

            } // end of addText(toNode)

            function deleteAction ( theNode, theAction ) {
//              console.log( "deleteAction( " + theNode + ", " + theAction + " )");

              visualEditorUpdate();

              adventureArray[theNode].toDo.splice( theAction, 1 );

              convertArrayToVisual();
              convertVisualEditorToString();
              reviewUserInput();

            }

            function gimmeFoeTypeSelectHTMLFor( foeType ) {

              returnString = "<select>";

              returnString += "<option value='-1'>Beast</option>";
              returnString += "<option value='0'>Melee Fighter</option>";
              returnString += "<option value='1'>Fighter with Pole Weapon</option>";
              returnString += "<option value='2'>Archer</option>";
              returnString += "<option value='3'>Wizard (Dazzle, Magic Fist)</option>";
              returnString += "<option value='4'>Wizard (Illusions of Bears)</option>";
              returnString += "<option value='5'>Wizard (Sleep)</option>";
              returnString += "<option value='6'>Wizard (Fireball)</option>";

              returnString = returnString.replace( "'" + foeType + "'", "'" + foeType + "' selected" );

              returnString += "</select>";

              return returnString;
            }


            function convertVisualEditorToString() {
//              console.log("convertVisualEditorToString()");
//              console.log( 'userInputTextArea is ' + $('userInputTextArea').value.split('\n').length + " lines long.");
//              console.log(adventureArray[10].toDo);

              // Overall Adventure Info

              newTextVersion = '@title ' + $('editorTitle').value + '\n';
              newTextVersion += '@creator ' + $('editorCreator').value + '\n';
              newTextVersion += '@maxattributes ' + $('editorMaxAttr').value + '\n';
              newTextVersion += '@description ' + $('editorDescription').value + '\n';

              // if ( Number( $( 'editorTestMode' ).value ) > 0 ) {
              //   newTextVersion += '@testmode';
              // }
              if ( Number( $( 'testModeSelector' ).value ) > 0 ) {
                newTextVersion += '@testmode';
              }

              newTextVersion += '\n';

              //  Variables

//              arrayOfVariableTAs = $('editorVariableBox').getElementsByTagName('textarea, input');
              arrayOfVariableTAs = $('editorVariableBox').querySelectorAll('textarea, input');

              for ( currentVariable = 0; currentVariable < arrayOfVariableTAs.length; currentVariable += 3 ) {

                newTextVersion += '^' + arrayOfVariableTAs[currentVariable].value + " = " + arrayOfVariableTAs[currentVariable+1].value;

                if ( arrayOfVariableTAs[currentVariable+2].value.trim().length > 0 ) {

                  newTextVersion += ' -> ' + arrayOfVariableTAs[ currentVariable + 2 ].value;

                }

                newTextVersion += '\n';

              }
//              console.log( 'userInputTextArea is ' + $('userInputTextArea').value.split('\n').length + " lines long.");

              newTextVersion += '\n';

              // now we go through the nodes...

//              arrayOfNodeDivs = $('nodeContainer').getElementsByTagName('div');
//              console.log( "1st-1st: " + arrayOfNodeDivs[0].children[ 4 ].value);

              arrayOfNodeDivs = $('nodeContainer').querySelectorAll('div[id^="editorNode"]');

              for ( currentNode = 0; currentNode < arrayOfNodeDivs.length; currentNode++ ) {


                switch ( arrayOfNodeDivs[currentNode].className.substr(0,2) ) {

                  case "lo":

                    newTextVersion += "@location " + arrayOfNodeDivs[currentNode].children[1].value + "\n";

                    nextAction = 4;
                    // if child 4 is select-one that's the first action, otherwise we go to "Add An Action"
                    // after parsing an action we skip forward to the "Delte This Action" button
                    while ( arrayOfNodeDivs[currentNode].children[ nextAction ].type == 'select-one' ) {

//                      console.log(currentNode + ": " + arrayOfNodeDivs[currentNode].children[ nextAction ].value);

                      // console.log( );

                      switch ( arrayOfNodeDivs[currentNode].children[ nextAction ].value ) {

                        case 'h':
                          newTextVersion += "@heal " + arrayOfNodeDivs[currentNode].children[nextAction + 1].value + "\n";
//                          nextAction += 4;
                          break;

                        case 'e':
                          newTextVersion += "@rest " + arrayOfNodeDivs[currentNode].children[nextAction + 1].value + "\n";
                          console.log( "adding @rest to text in node " + currentNode + " and action " + nextAction );
  //                        nextAction += 4;
                          break;

                        case 'd':
                          // console.log(currentNode + " - " + nextAction);
                          // console.log( arrayOfNodeDivs[currentNode].children[nextAction].value );
                          // console.log( arrayOfNodeDivs[currentNode].children[nextAction+1].value );
                          // console.log( arrayOfNodeDivs[currentNode].children[nextAction+2].value );
                          newTextVersion += "@damage " + arrayOfNodeDivs[currentNode].children[nextAction + 1].value + " " + arrayOfNodeDivs[currentNode].children[nextAction + 2].value.toLowerCase() + "\n";

                          // console.log( newTextVersion.split('\n')[ newTextVersion.split('\n').length - 2 ] );

//                          nextAction += 7;
                          break;

                        case 'x':
                          newTextVersion += "@xp " + arrayOfNodeDivs[currentNode].children[nextAction + 1].value + "\n";
  //                        nextAction += 4;
                          break;

                        case 'w':
                          if ( arrayOfNodeDivs[currentNode].children[nextAction + 1].value == '' ) {
                            arrayOfNodeDivs[currentNode].children[nextAction + 1].value = 'text';
                          }
                          newTextVersion += "@writing " + arrayOfNodeDivs[currentNode].children[nextAction + 1].value + "\n";
  //                        nextAction += 4;
                          break;

                        case 'r':
                          newTextVersion += "@removeFoe " + arrayOfNodeDivs[currentNode].children[nextAction + 1].value + "\n";
                          // console.log( "adding @removeFoe to text in node " + currentNode + " and action " + nextAction );
//                          nextAction += 4;
                          break;

                        case 'm':
                          newTextVersion += "@remember " + arrayOfNodeDivs[currentNode].children[nextAction + 1].value + "\n";
                          break;

                        case '^':
//                          console.log( currentNode +" - " + nextAction );
                          newTextVersion += "^" + arrayOfNodeDivs[currentNode].children[nextAction + 1].value + " = " + arrayOfNodeDivs[currentNode].children[nextAction + 2].value +  "\n";
//                          nextAction += 5;
                          break;

                      }  // end of switch for type of action

//                      nextAction += 2;
// while ( arrayOfNodeDivs[currentNode].children[ nextAction ].type != 'select-one'
//     && arrayOfNodeDivs[currentNode].children[ nextAction ].innerHTML != 'Add an Action' && nextAction < 999) {

                      while ( arrayOfNodeDivs[currentNode].children[ nextAction ].innerHTML != 'Delete This Action' && arrayOfNodeDivs[currentNode].children[ nextAction ].innerHTML != 'Add an Action' && nextAction < 999) {
                            nextAction++;
                      }
                      nextAction += 2; // to skip past the "Delete This Action" button

                    }   // end of while going through loc looking for actions

                    if ( nextAction > 997 ) {
                      console.warn( "nextAction got too large, we didn't find the Add an Action button");
                    }

                    // now we work through the children
                    // a textarea by itself is adventure text
                    // two textarea in a row are a button

                    //LOCATION DECIPHER (visual to text)
                    // the next node will be class= textCondition, adventureText, buttonCondition, or button

                    //console.log(arrayOfNodeDivs[currentNode].children );


                    while ( nextAction < arrayOfNodeDivs[currentNode].children.length ) {

                      // each child will be a textArea, which will be adventureText or a condition for same,
                      // or a div in which case it's a button, or we ignore it.

                      if ( arrayOfNodeDivs[currentNode].children[ nextAction ].type == 'textarea' ) {

                        if ( arrayOfNodeDivs[ currentNode ].children[ nextAction ].classList.value.includes( "textCondition" ) ) {

                          if ( arrayOfNodeDivs[currentNode].children[ nextAction ].value.trim().length > 0 ) {

//                            console.log( currentNode + " * " + nextAction );

                            newTextVersion += "@if " + arrayOfNodeDivs[currentNode].children[ nextAction ].value + '\n';

                          }

                        } else {

                          newTextVersion += arrayOfNodeDivs[currentNode].children[ nextAction ].value + '\n';

                        }

                      }  else if ( arrayOfNodeDivs[ currentNode ].children[ nextAction ].tagName == 'DIV' && arrayOfNodeDivs[ currentNode ].children[ nextAction ].id !== undefined ) {

                        // if ( arrayOfNodeDivs[ currentNode ].children[ nextAction ].id.substring(0,1) == 'N' && arrayOfNodeDivs[ currentNode ].children[ nextAction ].id.substring(2,3) == 'B' ) {
                        if ( buttonDivRegEx.test( arrayOfNodeDivs[ currentNode ].children[ nextAction ].id ) ) {

                          arrayOfTextAreasForThisButton = arrayOfNodeDivs[ currentNode ].children[ nextAction ].querySelectorAll('textArea, input');

                          if ( arrayOfTextAreasForThisButton.length == 3 ) {

                            if ( arrayOfTextAreasForThisButton[0].value.trim().length > 0 ) {

                              newTextVersion += "@if " + arrayOfTextAreasForThisButton[0].value + '\n';

                            }

                            newTextVersion += "@button " + arrayOfTextAreasForThisButton[2].value + '\n';
                            newTextVersion += arrayOfTextAreasForThisButton[1].value+ '\n\n';

                          } else {

                            newTextVersion += "@button " + arrayOfTextAreasForThisButton[1].value + '\n';
                            newTextVersion += arrayOfTextAreasForThisButton[0].value + '\n\n';

                          }


                        }


                      }

                      // bottom of the loop just increments nextAction


                      nextAction++;
                    }


//                    newTextVersion +='\n';

                    break; // done with location


                  case "br":
                    newTextVersion += "@branch "  + getEditorNode( currentNode ).children[0].value + "\n";

                    newTextVersion += getEditorNode( currentNode ).children[3].value + "\n";

//                    console.log( getEditorNode( currentNode ).children[3].value  );

                    newTextVersion += "@destinationTrue: ";
                    newTextVersion +=  getEditorNode( currentNode ).children[6].value + '\n';
                    newTextVersion +=  "@destinationFalse: "
                    newTextVersion +=  getEditorNode( currentNode ).children[10].value + '\n';


                    newTextVersion +='\n';

                    break; // done with branches


                  case "fo":
                    newTextVersion += '@foe ' + getEditorNode( currentNode ).children[0].value + "\n";
                    newTextVersion += getEditorNode( currentNode ).children[5].value + "\n";
                    newTextVersion += '@type ' + getEditorNode( currentNode ).children[8].value + "\n";
                    newTextVersion += getEditorNode( currentNode ).children[11].value + "\n";
//                    newTextVersion += '(foe race and age, not used)\n';

                    newTextVersion += 'ST ' + getEditorNode( currentNode ).children[14].value;
                    newTextVersion += ', DX ' + getEditorNode( currentNode ).children[17].value;
                    newTextVersion += ', IQ ' + getEditorNode( currentNode ).children[20].value;
                    newTextVersion += ', MA ' + getEditorNode( currentNode ).children[23].value +'\n';

                    newTextVersion += 'Armor: ' + getEditorNode( currentNode ).children[26].value + '\n';

                    newTextVersion += 'Weapons: primary (' + getEditorNode( currentNode ).children[29].value;
                    newTextVersion += '), secondary (' + getEditorNode( currentNode ).children[32].value + ')\n';

                    newTextVersion += '@range ' + getEditorNode( currentNode ).children[35].value + '\n';
                    newTextVersion += '@xp ' + getEditorNode( currentNode ).children[38].value + '\n';
                    newTextVersion += '@winDestination ' + getEditorNode( currentNode ).children[41].value + '\n';
                    newTextVersion += '@loseDestination ' + getEditorNode( currentNode ).children[45].value + '\n';
                    newTextVersion += '@noFoe ' + getEditorNode( currentNode ).children[49].value + '\n';

                    newTextVersion +='\n';

                    break; /// done with foe



                } // end of lo/br/fo switch statement


              } // end of for loop of currentNode in arrayOfNodeDivs
//              console.log(adventureArray[10].toDo);

//              console.log(newTextVersion);




              $('userInputTextArea').value = newTextVersion

              normalizeBlankLines();
             // console.log(adventureArray[10].toDo);

             //             console.log("X1:" + adventureArray[3].toDo[1] );
//             console.log("end of convertVisualEditorToString " + adventureArray[0].toDo[0] );
//console.log( 'userInputTextArea is ' + $('userInputTextArea').value.split('\n').length + " lines long.");

//              reviewUserInput();
             // console.log(adventureArray[10].toDo);
//             console.log("X2:" + adventureArray[3].toDo[1] );

              // console.log(adventureArray[6].comparisonExpression);
              //

//              console.log( 'userInputTextArea is ' + $('userInputTextArea').value.split('\n').length + " lines long.");


            } // end of convertVisualEditorToString()

            function getNameOfEditorNode( nodeToID ) {

              actualNode = $('nodeContainer').querySelectorAll('div[id^="editorNode"]')[ nodeToID ];

              let nodeTypeNumber = "lbf".indexOf( actualNode.className[0] );

              let nodeNamePosition = [ 1, 0, 0 ][ nodeTypeNumber ];

              return actualNode.children[ nodeNamePosition ].value;

            }

            function getEditorNode( nodeNumber ) {

              return $('nodeContainer').querySelectorAll('div[id^="editorNode"]')[ nodeNumber ]

            }

            function deleteEditorNode( nodeToDelete, outcomes ) {
//              console.log( nodeToDelete + "-" + ( typeof outcomes !== 'undefined' ? 1 : 0 ));

//              actualNode = $('nodeContainer').querySelectorAll('div[id^="editorNode"]')[ nodeToDelete ];
              actualNode = getEditorNode( nodeToDelete );

              let nodeTypeNumber = "lbf".indexOf( actualNode.className[0] );

              let nodeTypeValue = ["location","branch","foe"][ nodeTypeNumber ];

              let nodeNameValue = getNameOfEditorNode( nodeToDelete );

              console.log( nodeToDelete + " - " + nodeTypeValue + " - " + nodeNameValue );

              if ( typeof outcomes !== 'undefined' && outcomes == 1 ) {

                outcomeNodesToDelete = [ actualNode.children[49].value, actualNode.children[45].value, actualNode.children[41].value ];

                for ( let ii = 0; ii < 3; ii++ ) {

                  for ( let i = 0; i < $('nodeContainer').children.length; i++ ) {

                    if ( outcomeNodesToDelete[ ii ] == getNameOfEditorNode( i ) ) {
                      deleteEditorNode( i );
                    }
                  }
                }


              }


              deletedNodes.push( {
                nodeNumber: nodeToDelete,
                nodeType: nodeTypeValue,
                nodeName: nodeNameValue,
                nodeHTML: actualNode.innerHTML
              });

              $('nodeContainer').querySelectorAll('div[id^="editorNode"]')[ nodeToDelete ].remove();

              convertVisualEditorToString();

              reviewUserInput();

              convertArrayToVisual();

            }



            function deleteVariable( varToDel ) {

              $('variableNumber'+varToDel).remove();

              convertVisualEditorToString();

              reviewUserInput();

              convertArrayToVisual();

            }


            function $(x) {
              return document.getElementById(x);
            }

            function breakHTML( theString ){

              // return theString.replace(/</g,'< ');

              return theString.replace(/<(?!\s)/g, '< ');

            }


            function securityCheck( suspiciousString ) {

              badChars = '_%{["]}`\'';

              for ( let i=0; i<badChars.length; i++ ) {
                if ( suspiciousString.indexOf(badChars.substr(i,1)) > -1 ) {

                  reviewResults += "Line " + (currentLine + 1) + ":  an expression cannot include the character " + badChars.substr(i,1) +"<br>" ;
                  editorReportStr += prefixString + ":  an expression cannot include the character " + badChars.substr(i,1) +"<br>" ;
                  return 0;

                }
              }


              return 1; // it's secure

            }

            function evaluateStringUnitTest() {

              let testStrings=[
                '',
                'naturalist',
                '1+2',
                '1 + 2',
                'sexappeal',
                'shield',
                'st',
                'st + dx',
                'sex appeal',
                '3d+1',
                '3d/0',
                '3d-alertness*3',
                'alertness*3',
                '2<3',
                '3>4',
                'variableArray',
                'adventureGo',
                'blast',
                'literacy-naturalist',
                'armor/2',
                '3+3-3+3-3',
                '3 + 3 -3 +3 - 3',
                '3 + -2',
                'myVar',
                'armor',
                '1+1+1+1+1',
                'naturalist + literacy'

              ]

              for ( let i = 0; i < testStrings.length; i++ ) {
                console.log("  ");
                console.log( "evaluateString: " + testStrings[i] + " evaluates to " + evaluateString( testStrings[i] ));


              }

              console.log();

            }


            function evaluateString( theString ) {

//              console.log( "Evaluating '" + theString + "'...");

              //theExpression = theString.substr(2,9999);
              theExpression=theString.toUpperCase();

              theExpression = theExpression.replace(/ VS /, '<=');

              // remove anything that might be slipping code to eval()
              theExpression = theExpression.replace( /=>/g, "" );
              theExpression = theExpression.replace( /[()]/g, "" );

              //remove whitespace
              theExpression = theExpression.replace( /\s/g, "" );

              // the ^ before vars just confuses things.
              theExpression = theExpression.replace( /\^/g, "" );




// 8/10/24 new variable substitution code:

              elements = theExpression.split(/(\W+)/);

//              console.log(elements);

              for ( let i = 0; i < elements.length; i++ ) {

                elements[i] = elements[i].toUpperCase();

                if ( elements[i] == 'ST') {
                  elements[i] = charStrValue;
                }
                if ( elements[i] == 'DX') {
                  elements[i] = charDexValue;
                }
                if ( elements[i] == 'IQ') {
                  elements[i] = charIntValue;
                }
                if ( elements[i] == 'ADJDX') {
                  elements[i] = charAdjDexValue;
                }
                if ( elements[i] == 'MA') {
                  elements[i] = charMAValue;
                }
                if ( elements[i] == 'ARMOR') {
                  elements[i] = charArmor;
                }
                if ( elements[i] == 'INJURY') {
                  elements[i] = charInjuryValue;
                }
                if ( elements[i] == 'FATIGUE') {
                  elements[i] = charFatigueValue;
                }
                // if ( elements[i] == 'LASTACTION') {
                //   elements[i] = lastAction;
                // }
                if ( elements[i] == 'CHARRACE') {
                  elements[i] = charRace;
                }

                for ( let j = 0; j < variableArray.length; j++ ) {

                  if ( elements[i] == variableArray[j].varName.toUpperCase() ) {

                    varsUsedInBranches.push( elements[i] );

                    elements[i] = variableArray[j].varValue;

                  }

                }


              }

//              console.log(elements);

              theExpression = elements.join('');
//              console.log(theExpression);

// end of new variable substitution code

              // first we run eval() to see if it gives an answer
              // if it doesn't, we tell the user and the variable is not created
              // if it does, we proceed

              itWorked=1;
              //console.log("evaluateString part 2");

              // first we roll the dice 5/24/22
              while ( theExpression.match(/[0-9]+D/) != null ) {

                diceExpr = theExpression.match(/[0-9]+D/)[0];
                numDice = parseInt(diceExpr.substr(0,diceExpr.indexOf('D')));

                totalOfDice = 0;
                for ( let j=0; j<numDice; j++ ) {
                  totalOfDice += Math.ceil(Math.random()*6);

                }
                // console.log('diceExpr: ' + diceExpr );
                // console.log('numDice: ' + numDice );
                // console.log('totalOfDice: ' + totalOfDice );
                // console.log('theExpression (before): ' + theExpression );

                theExpression = theExpression.replace( diceExpr, totalOfDice );
                // console.log('theExpression (after): ' + theExpression );

              }
              // end of die rolls

              try {
                eval( doubleTheEqualSignForEval( theExpression ) );
              }
              catch( err ) {
                reviewResults += "Line " + (currentLine + 2) + ":  the expression '" + theExpression +"' doesn't seem to work.<br>" ;
                itWorked=0;
                problemsFound++;
                console.log( "Eval('" + theExpression + "') failed on line " + currentLine + " : " + theExpression);
              }

              if ( itWorked > 0 ){
                finalValue = eval( doubleTheEqualSignForEval( theExpression ) );
    //            console.log( "Evaluating '" + theString + "'... it seems to be " + finalValue + ".");
              } else {
                finalValue = -2323;
              }

              if ( isNaN( finalValue ) ) {
                finalValue = -2323;
                console.log( theExpression + " worked out to NaN!  Replacing with 0.");
              }

              //console.log("evaluateString part 3");

              displayVariables();

              //console.log("evaluateString part 4");

              return finalValue;

            }

            function resetAdventureCharSheetHeight()  {


            }


            function variableReassignment( theLine ) {
//              console.log( newLoc.name + " variableReassignment( " + theLine  + " )" );

//              console.log( "A:"+theLine +"|"+ theVar +"|"+ theExpr);

              theLine = theLine.trim();
              let theVar = theLine.substr( 0, theLine.indexOf('=') ).toUpperCase().replace(/ +/g, "");


              splitLine = theLine.split('->');

              if ( splitLine.length > 1 ) {

                variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varZeroDestination = splitLine[1].trim();

              } else {

                if ( theLine.indexOf('->') > -1 ) {
                  variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varZeroDestination = '';

                }

              }

              theLine = splitLine[0];

              theExpr = theLine.substr( theLine.indexOf('=') + 1, 9999 ).toUpperCase().replace(/ +/g, "");
//              console.log( "B:"+theLine +"|"+ theVar +"|"+ theExpr);

              variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varValue = evaluateString( theExpr );

//              console.log( "new value is " + variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varValue );

//              console.log( "C:"+theLine +"|"+ theVar +"|"+ theExpr);

              displayVariables();

              //console.log( "variableReassignment - end")

              charStrValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'ST').varValue;
              charDexValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'DX').varValue;
              charAdjDexValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'ADJDX').varValue;
              charIntValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'IQ').varValue;
              charMAValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'MA').varValue;
              charArmor = variableArray.find( whatever => whatever.varName.toUpperCase() === 'ARMOR').varValue;
              charInjuryValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'INJURY').varValue;
              charFatigueValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'FATIGUE').varValue;
              charRace = variableArray.find( whatever => whatever.varName.toUpperCase() === 'CHARRACE').varValue;
              charType = variableArray.find( whatever => whatever.varName.toUpperCase() === 'CHARTYPE').varValue;

              if ( variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varType == 'T') {

                    resetAdventureCharSheetHeight();
              }

              if ( variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varType == 'S') {

                    resetAdventureCharSheetHeight();
              }
              // did a Zero Destination variable hit zero?
              // if so we adventureGo() to that locationName

              if ( variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varZeroDestination != '' && variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varValue <= 0 ) {

                zeroVarDestination  = variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varZeroDestination;

                // destination is cleared to avoid loop
                variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varZeroDestination = '';

                console.log("Var hit zero, heading to: " + variableArray.find( whatever => whatever.varName.toUpperCase() === theVar.toUpperCase() ).varZeroDestination );

              } else {

                zeroVarDestination = '';

              }



            }

            function displayVariables () {
              //console.log( "displayVariables()" );

              userVarArray = [];
              attrVarArray = [];
              talentVarArray = [];
              spellVarArray = [];

              userVarStr = "";
              attrVarStr = "";
              talentVarStr = "";
              spellVarStr = "";


              for ( let i=0; i<variableArray.length; i++ ) {
                switch ( variableArray[i].varType) {

                  case 'U':
                    userVarArray.push( variableArray[i].varName +" = "+ variableArray[i].varValue );
                    break;

                  case 'A':
    //                attrVarArray.push( variableArray[i].varName +" = "+ variableArray[i].varValue ) ;
                    break;

                    case 'T':
                      talentVarArray.push( variableArray[i].varName +" = "+ variableArray[i].varValue ) ;
                      break;

                    case 'S':
                      spellVarArray.push( variableArray[i].varName +" = "+ variableArray[i].varValue ) ;
                      break;

                }
              }



              attrVarArray.push( "ST = " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'ST' ).varValue );
              attrVarArray.push( "DX = " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'DX' ).varValue );
              attrVarArray.push( "AdjDX = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'ADJDX' ).varValue );
              attrVarArray.push( "IQ = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'IQ' ).varValue );
              attrVarArray.push( "MA = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'MA' ).varValue );
              attrVarArray.push( "Armor = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'ARMOR' ).varValue );
              attrVarArray.push( "Injury = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'INJURY' ).varValue );
              attrVarArray.push( "Fatigue = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'FATIGUE' ).varValue );
              attrVarArray.push( "XP Earned = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'XPEARNED' ).varValue );
              attrVarArray.push( "Last Action = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'LASTACTION' ).varValue );

              attrVarArray.push( "Char Race = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'CHARRACE' ).varValue
                    + " (" + raceArray[ variableArray.find(whatever => whatever.varName.toUpperCase()==='CHARRACE').varValue ] + ")" );

              attrVarArray.push( "Char Type = " + variableArray.find(whatever => whatever.varName.toUpperCase() === 'CHARTYPE' ).varValue
                    + " (" + ( charType == 1 ? "Hero" : "Wizard" ) + ")" );

              userVarArray.sort();

              talentVarArray.sort();
              spellVarArray.sort();

              //console.log( "displayVariables() - 2" );


              for (let i = 0; i < userVarArray.length; i++ ) {

                theVar = userVarArray[i].substr( 0, userVarArray[i].indexOf("=") ).replace(/ +/g, "");

                newVarButton = "<span onclick='changeVar(";
                newVarButton += '\"' + theVar + '\"';
                newVarButton += ")'>" + userVarArray[i] + "</span><br>";

                userVarStr += newVarButton;

              }

              for (let i = 0; i < attrVarArray.length; i++ ) {

                theVar = attrVarArray[i].substr( 0, attrVarArray[i].indexOf("=") ).replace(/ +/g, "");

                newVarButton = "<span onclick='changeVar(";
                newVarButton += '\"' + theVar + '\"';
                newVarButton += ")'>" + attrVarArray[i] + "</span><br>";

                attrVarStr += newVarButton;

              }

              for (let i = 0; i < talentVarArray.length; i++ ) {

                theVar = talentVarArray[i].substr( 0, talentVarArray[i].indexOf("=") ).replace(/ +/g, "");

                newVarButton = "<span onclick='changeVar(";
                newVarButton += '\"' + theVar + '\"';
                newVarButton += ")'>" + talentVarArray[i] + "</span><br>";

                talentVarStr += newVarButton;

              }

              for ( let i = 4; i < spellVarArray.length; i++ ) {

                theVar = spellVarArray[i].substr( 0, spellVarArray[i].indexOf("=") ).replace(/ +/g, "");

                newVarButton = "<span onclick='changeVar(";
                newVarButton += '\"' + theVar + '\"';
                newVarButton += ")'>" + spellVarArray[i] + "</span><br>";

                spellVarStr += newVarButton;

              }

              //console.log( "displayVariables() - 3" );

              document.getElementById("userVariablesDiv").innerHTML = userVarStr ;
              document.getElementById("attributeVariablesDiv").innerHTML = attrVarStr;

//              document.getElementById("talentVariablesDiv").innerHTML = talentVarStr;
              updateTalentVars();

//              document.getElementById("spellVariablesDiv").innerHTML = spellVarStr;
              updateSpellVars();

              document.getElementById("charL1L").innerHTML = "ST: " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'ST' ).varValue;
              document.getElementById("charL1R").innerHTML = "Injury: " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'INJURY' ).varValue;

              document.getElementById("charL2L").innerHTML = "DX: " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'DX' ).varValue
                  +"&nbsp;&nbsp; adjDX: " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'ADJDX' ).varValue;
              document.getElementById("charL2R").innerHTML = "Fatigue: " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'FATIGUE' ).varValue;

              document.getElementById("charL3La").innerHTML = "IQ: " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'IQ' ).varValue;

              document.getElementById("charL3Lb").innerHTML = "&nbsp;&nbsp;MA: " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'MA' ).varValue;

              document.getElementById("charL3R").innerHTML = "Remaining ST: " + ( variableArray.find( whatever => whatever.varName.toUpperCase() === 'ST' ).varValue -
              variableArray.find( whatever => whatever.varName.toUpperCase() === 'INJURY' ).varValue - variableArray.find( whatever => whatever.varName.toUpperCase() === 'FATIGUE' ).varValue);

              document.getElementById("charL4L").innerHTML = "XP Earned: " + variableArray.find( whatever => whatever.varName.toUpperCase() === 'XPEARNED' ).varValue;

              charKnowledge=[];
              //console.log( "displayVariables() - 4" );

              for ( let i = 0; i < variableArray.length; i++ ) {

                if ( ( variableArray[i].varType == "T" || variableArray[i].varType == "S" )
                && variableArray[i].varValue > 0 ) {

                  charKnowledge.push ( variableArray[i].varName );

                }
                charKnowledge = charKnowledge.sort();

              }
              //console.log( "displayVariables() - 5" );

    //           charKnowledgeStr = charKnowledge.join(", ")
    // //          document.getElementById("charL5").innerHTML = charKnowledgeStr.substr(0,charKnowledgeStr.length-2);
    //           document.getElementById("charL5").innerHTML = charKnowledgeStr;

              document.getElementById("charArmorDisp").innerHTML = "Armor: " + armorTypes[ charArmor ];

              document.getElementById("charL5").innerHTML = "Talents: " + charKnowledge.join(", ");

              document.getElementById('currentRememberedLocation').innerHTML = rememberedLocation;

            }

            function updateTalentVars() {

              talentVarStr = '';

              for (let i = 0; i < talentVarArray.length; i++ ) {

                if ( document.getElementById('showOnlyKnownTalents').checked && Number(talentVarArray[i].split(' ')[2]) == 0 ) {
                  continue;
                }

                theVar = talentVarArray[i].substr( 0, talentVarArray[i].indexOf("=") ).replace(/ +/g, "");

                newVarButton = "<span onclick='changeVar(";
                newVarButton += '\"' + theVar + '\"';
                newVarButton += ")'>" + talentVarArray[i] + "</span><br>";

                talentVarStr += newVarButton;

              }

              document.getElementById("talentVariablesDiv").innerHTML = talentVarStr;

            }

            function updateSpellVars() {

              spellVarStr = '';

              for (let i = 0; i < spellVarArray.length; i++ ) {

                if ( document.getElementById('showOnlyKnownSpells').checked && Number(spellVarArray[i].split(' ')[2]) == 0 ) {
                  continue;
                }

                theVar = spellVarArray[i].substr( 0, spellVarArray[i].indexOf("=") ).replace(/ +/g, "");

                newVarButton = "<span onclick='changeVar(";
                newVarButton += '\"' + theVar + '\"';
                newVarButton += ")'>" + spellVarArray[i] + "</span><br>";

                spellVarStr += newVarButton;

              }

              document.getElementById("spellVariablesDiv").innerHTML = spellVarStr;

            }

            function changeVar( varToChange ) {

              console.log( "changeVar(" + varToChange + ")" );

              varType = variableArray.find( whatever => whatever.varName.toUpperCase()===varToChange.toUpperCase()).varType;

              document.getElementById("currentValueSpan").innerHTML = variableArray.find( whatever => whatever.varName.toUpperCase() === varToChange.toUpperCase() ).varValue;

              if ( varType == 'T' ) {
                  document.getElementById("varChangeInfoDiv").innerHTML = "This variable represents the character possessing a particular talent. 1 means they have the talent, 0 means they do not.";
              } else if ( varType == 'S' ) {
                  document.getElementById("varChangeInfoDiv").innerHTML = "This variable represents the character knowing a particular spell. 1 means they have the talent, 0 means they do not.";
              } else if ( varType == 'U' ) {
                document.getElementById("varChangeInfoDiv").innerHTML = "An adventure variable can have any numeric value.";
              } else if ( "STDXADJDXMA".indexOf(variableArray.find( whatever => whatever.varName.toUpperCase() === varToChange.toUpperCase()).varName.toUpperCase() ) > -1 ) {
                document.getElementById("varChangeInfoDiv").innerHTML = "Character attributes should be between 6 and 16.";
              } else if ( "ARMOR" == variableArray.find( whatever => whatever.varName.toUpperCase() === varToChange.toUpperCase() ).varName.toUpperCase() ) {
                document.getElementById("varChangeInfoDiv").innerHTML = "Armor should be between 0 and 6.";
              } else if ( "CHARRACE" == variableArray.find( whatever => whatever.varName.toUpperCase() === varToChange.toUpperCase() ).varName.toUpperCase() ) {
                document.getElementById("varChangeInfoDiv").innerHTML = "0=Human, 1=Elf, 2=Dwarf, 3=Halfling, 4=Orc, 5=Goblin.";
              } else if ( "XPEARNED" == variableArray.find( whatever => whatever.varName.toUpperCase() === varToChange.toUpperCase() ).varName.toUpperCase() ) {
                document.getElementById("varChangeInfoDiv").innerHTML = "Enter new total XP so far...";
              } else if ( "INJURYFATIGUE".indexOf(variableArray.find( whatever => whatever.varName.toUpperCase() === varToChange.toUpperCase() ).varName.toUpperCase() ) > -1 ) {
                document.getElementById("varChangeInfoDiv").innerHTML = "Injury and Fatigue values should be from 0 to the character's ST.";
              } else {
                document.getElementById("varChangeInfoDiv").innerHTML = "This message should never appear. Error code = ln(-1).";
              }

              document.getElementById("newVarValue").value = variableArray.find( whatever => whatever.varName.toUpperCase()===varToChange.toUpperCase()).varValue;

              document.getElementById('successButton').onclick = function() { checkAndStoreVar( varToChange ) };

              document.getElementById("varChangeDiv").style.display = 'block';

              $('newVarValue').select();

            }

            function checkAndStoreVar( varToChange ) {

    //          console.log( "checkAndStoreVar(" + varToChange + ")" );

              document.getElementById('varChangeDiv').style.display = 'none';
              //document.getElementById('generalFaultMessage').innerHTML = theMessage;


              proposedValue = document.getElementById("newVarValue").value;

              newValue = evaluateString( proposedValue );

              if ( isNaN(proposedValue) ) {
                generalFault("Only numerical values are possible.");
                return;
              }

    //          console.log( newValue );
              variableArray.find( whatever => whatever.varName.toUpperCase() ===varToChange.toUpperCase() ).varValue = newValue;

              if ( variableArray.find( whatever => whatever.varName.toUpperCase() ===varToChange.toUpperCase() ).varType == "A" ) {

                charStrValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'ST' ).varValue;
                charDexValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'DX' ).varValue;
                charAdjDexValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'ADJDX' ).varValue;
                charIntValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'IQ' ).varValue;
                charMAValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'MA' ).varValue;
                charArmor = variableArray.find( whatever => whatever.varName.toUpperCase() === 'ARMOR' ).varValue;
                charInjuryValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'INJURY' ).varValue;
                charFatigueValue = variableArray.find( whatever => whatever.varName.toUpperCase() === 'FATIGUE' ).varValue;
                charRace = variableArray.find( whatever => whatever.varName.toUpperCase() === 'CHARRACE' ).varValue;

              }

              displayVariables();

            }

            function generalFault( theMessage ) {

              document.getElementById('generalFaultMessage').innerHTML = theMessage;
              document.getElementById('generalFaultDiv').style.display = 'block';


            }

            function implementLocationHTML( newLoc ) {

              if ( newLoc.writing != ""  && variableArray.find( whatever => whatever.varName.toUpperCase() === 'LITERACY').varValue > 0 ) {

                newHTML = newLoc.html.substr(0,newLoc.html.indexOf("<div"));
                newHTML += 'The writing says, "' + newLoc.writing + '"<br>';
                newHTML +=  newLoc.html.substr(newLoc.html.indexOf("<div"),9999);

              } else {

                newHTML = newLoc.html;

              }


              // display variablesDiv
              for (variableCounter=0; variableCounter < variableArray.length; variableCounter++) {

                counter = 0;

                while ( newHTML.toUpperCase().indexOf( '^' + variableArray[variableCounter].varName.toUpperCase() ) > -1 && counter < 999) {

                  counter++;

                  varPosition = newHTML.toUpperCase().indexOf( '^' + variableArray[variableCounter].varName.toUpperCase() );

                  newHTML = newHTML.replace( newHTML.substr( varPosition, variableArray[variableCounter].varName.length + 1 ),
                    variableArray[variableCounter].varValue )

                  //this won't work because caps may not match
                  //newHTML = newHTML.replace( '^' + variableArray[variableCounter].varName, variableArray[variableCounter].varValue );

                }

                if ( counter > 900 ) {
                  console.log( varPosition + "-" + newHTML.substr( varPosition, variableArray[variableCounter].varName.length ) );
                }

              }

              // conditional paragraphs/buttonTextStart 8/24
              newParas = newHTML.split('<br>');
              newHTML = '';
              // buttonsPresented = 0;

              for ( let i=0; i < newParas.length; i++ ) {

                // if ( newParas[i].substr(0,28) == "<div class='adventureButton'" ) {
                //   buttonsPresented++;
                // }


                if ( newParas[i].substr(0,3) == '@if' ) {

                  // console.log('testing ' + newParas[i].substring(3) );
                  // console.log(evaluateString( newParas[i].substring(3)));

                  if ( evaluateString( newParas[i].substring(3) ) ) {

                    i++;

                    while ( newParas[i].trim() == '' ) {
                      i++;
//                          console.log('skipping blank line');
                    }


//                        newHTML += newParas[i] + '<br><br>';
                    newHTML += newParas[i] + '<br>';

                  } else {
                    i++;
                    while ( newParas[i].trim() == '' ) {
                      i++;
//                          console.log('skipping blank line');
                    }
                  }

              } else {

                  newHTML += newParas[i] + '<br>';

                }

              }

              // we never want more than one blank line.
              newHTML = newHTML.replace(/(<br>\s*){3,}/g, '<br><br>');

              return newHTML;

            }






            function adventureGo( locName ) {

//              console.log("adventureGo("+locName+")");

              if ( locName.toUpperCase() == 'RETURN' ) {

                locName = rememberedLocation;

              } else if ( locName.toUpperCase() == 'LASTLOCATION'  ) {

                locName = lastLocation;

              } else {

                lastLocation = newLoc.name;

              }

              newLoc = adventureArray.find( locn => locn.name === locName );
//              newLoc = adventureArray.find( locn => locn.name === expandedLocName );
//console.log( newLoc );

//              $('historyDiv').innerHTML += "<br>" + newLoc.name;
              $('historyDiv').innerHTML += "<br>" + "(" + newLoc.type.toUpperCase() + ") " + newLoc.name;

              if ( newLoc.toDo.length > 0 ) {

                //console.log(newLoc.toDo.length);

                for ( let ii=0; ii<newLoc.toDo.length; ii++ ) {
                  //  console.log(ii);

                  if ( newLoc.toDo[ii].substr(0,1) == "^" ) {

                    variableReassignment( newLoc.toDo[ii].substr(1,9999) );
//                    console.log(ii);

                  } else if ( newLoc.toDo[ii].substr(0,5) == "@heal" ) {

                      hps = evaluateString( newLoc.toDo[ii].substr(5,999) );
                      hps = Math.trunc( hps );

                    if ( isNaN(hps) || hps < 0 ) {
                      hps=0;
                    }

                    charInjuryValue -= hps;

                    if ( charInjuryValue < 0 ) {
                      charInjuryValue = 0;
                    }

                    variableArray.find(x=>x.varName.toUpperCase()=='LASTACTION').varValue = hps;

                    variableArray.find(whatever => whatever.varName.toUpperCase() === 'INJURY' ).varValue = charInjuryValue;

                    displayVariables();

                  } else if ( newLoc.toDo[ii].substr(0,5) == "@rest" ) {

                    hps = evaluateString( newLoc.toDo[ii].substr(5,999) );
                    hps = Math.trunc( hps );

                    if ( isNaN(hps) ) {
                      hps=0;
                    }

                    charFatigueValue -= hps;
                    if ( charFatigueValue < 0 ) {
                      charFatigueValue = 0;
                    }

                    variableArray.find(whatever => whatever.varName.toUpperCase() === 'FATIGUE' ).varValue = charFatigueValue;

                    displayVariables();

                  } else if ( newLoc.toDo[ii].substr(0,3) == "@xp" ) {

                    xps = evaluateString( newLoc.toDo[ii].substr(3,999) );
                    xps = Number(xps);
                    xps = Math.trunc(xps);

                    if ( isNaN(xps) ) {
                      xps=0;
                    }

                    let currentXP = Number(variableArray.find(whatever => whatever.varName.toUpperCase() === 'XPEARNED' ).varValue );

                    variableArray.find(whatever => whatever.varName.toUpperCase() === 'XPEARNED' ).varValue = Number(currentXP + xps);

                    displayVariables();

                  } else if ( newLoc.toDo[ii].substr(0,9) == "@remember" ) {

                    let words = newLoc.toDo[ii].split(' ');
//                    console.log( words );

                    if ( words.length === 1 ) {

                      rememberedLocation = locName;
                      displayVariables();

                    } else {

                      rememberedLocation = words[ words.length - 1 ];
                      displayVariables();

                    }


                  } else if ( newLoc.toDo[ii].substr(0,7).toLowerCase() == "@damage" ) {


                    damageExpression  = newLoc.toDo[ii].substring( newLoc.toDo[ii].indexOf(' ') + 1,
                      newLoc.toDo[ii].lastIndexOf(' ') );

                    hps = evaluateString( damageExpression );

                    hps = Math.trunc(hps)

                    hps -= charArmor;

                    if ( isNaN(hps) || hps < 0 ) {
                      hps=0;
                    }

    //                console.log(hps);
                    charInjuryValue += hps;
                    variableArray.find(x=>x.varName.toUpperCase()=='LASTACTION').varValue = hps;
//                    console.log( 'new charInjuryValue is ' + charInjuryValue );

                    variableArray.find(whatever => whatever.varName.toUpperCase() === 'INJURY' ).varValue = charInjuryValue;

                    displayVariables();

                      if ( charStrValue - charFatigueValue - charInjuryValue < 0 ) {
                        //how did this ever work?
//                        adventureGo( parsed[2] );
                        // new 9/16/23
                        adventureGo( newLoc.toDo[ii].substr( newLoc.toDo[ii].lastIndexOf(' ') + 1, 999 ) );
                      }

                    } else if ( newLoc.toDo[ii].substr(0,10).toUpperCase() == "@REMOVEFOE" ) {
                        console.log("removing foe: " + newLoc.toDo[ii].substr(11,888).toUpperCase() );
                      foesWeHaveRemoved.push(newLoc.toDo[ii].substr(11,888).toUpperCase());

                    }

                }

              }
              //console.log("about to switch");
              switch ( newLoc.type ) {
                case "l":
                  // presenting location

                  branchesVisited = 0;

                  document.getElementById("simulatedScreen").innerHTML = implementLocationHTML( newLoc );;

                  break;

                case "b":

                  branchesVisited++;

                  if ( branchesVisited > 100 ) {
                    document.getElementById("simulatedScreen").innerHTML = "We appear to be in an endless loop of branches, so we're going to call it quits right here.\n\n If you look at the History of Locations Visited panel in the lower right you can discern which branches got you into this mess and fix your logic.";
                    return;
                  }

                  // presenting branch


                  comparisonString = newLoc.comparisonExpression;


                  destinationTrue = newLoc.destinationTrue;
                  destinationFalse = newLoc.destinationFalse;

                  // if the comparison staring involves a die roll we want to send this to
                  // the dry run dialog box for the user to choose the outcome, but if it's
                  // deterministic we go straight through.

                  // how do we tell the difference? Parsing requires thought, but
                  //running the evaluation thirteen times is easy...

                  let deterministic = 1;
                  evalResult = evaluateString( comparisonString );
                  for ( let j = 0; j < 13; j++ ) {
                    if ( evalResult != evaluateString( comparisonString ) ) {
                      deterministic = 0;
                    }
                  }

                  if ( !deterministic ) {

//                  if ( whatTypeOfTermIs( newLoc.firstExpression ) == 'D' || whatTypeOfTermIs( newLoc.secondExpression ) == 'D' ) {

                    // Dry run version with dialog box
                    document.getElementById("dryrunDiv").style.display = "block";

                    document.getElementById("dryrunInfoDiv").innerHTML = "You have run into a branch with the following condition:<br><br>";

                    document.getElementById("dryrunInfoDiv").innerHTML += "<div style='background-color: ghostwhite; border: solid thin; padding: 4px;'>" + newLoc.comparisonExpression + "</div>&nbsp;&nbsp;";

                    document.getElementById("dryrunInfoDiv").innerHTML += "<br>Which pathway do you want to follow?<br><br>";

                    document.getElementById("dryrunInfoDiv").innerHTML += "<br><br><br>";



                  } else {


                    comparisonResult = evaluateString( comparisonString );

                    if ( comparisonResult ) {
                      adventureGo( newLoc.destinationTrue );
                    } else {
                      adventureGo( newLoc.destinationFalse );
                    }

                  }

                  break;

                case "f":
                  // presenting foe

                  branchesVisited = 0;

                  if ( foesWeHaveRemoved.indexOf(newLoc.name.toUpperCase()) > -1 ) {

                    adventureGo( newLoc.noFoe );

                    break;

                  } else {

                    destinationTrue = newLoc.winDestination;
                    destinationFalse = newLoc.loseDestination;


                    document.getElementById("combatDiv").style.display = "block";

                    document.getElementById("combatInfoDiv").innerHTML = "\"" + newLoc.combatIntro + "\"<br><br>";

                    document.getElementById("combatInfoDiv").innerHTML += "You have run into a foe with the following attributes:<br><br>";

                    document.getElementById("combatInfoDiv").innerHTML += "Name: " + newLoc.foeName + "<br>";

                    document.getElementById("combatInfoDiv").innerHTML += "ST " + newLoc.st + ", DX " + newLoc.dx + ", IQ " + newLoc.iq + ", MA " + newLoc.ma + "<br>";

                    document.getElementById("combatInfoDiv").innerHTML += "Type:  " + newLoc.foeType + ", armor stops " + newLoc.armor + ", Damage: " + newLoc.damage;

                    if ( newLoc.damage2 != "" ) {
                        document.getElementById("combatInfoDiv").innerHTML += "/" + newLoc.damage2;
                    }

                    document.getElementById("combatInfoDiv").innerHTML += "<br>";

                    document.getElementById("combatInfoDiv").innerHTML += "<br><br><br>Which pathway do you want to follow?<br><br>";

                    document.getElementById("combatInfoDiv").innerHTML += "<br><br><br>";

                    break;
                  }

              }

              // // did a Zero Destination variable hit zero?
              // // if so we adventureGo() to that locationName
//              console.log( zeroVarDestination );

              if ( zeroVarDestination != '' ) {

                reroute = zeroVarDestination;
                zeroVarDestination = '';

                adventureGo( reroute );

                reroute = '';

              }

              //
              // for ( let i = 0; i < variableArray.length; i++ ) {
              //
              //   if ( variableArray[ i ].varType === 'U' && variableArray[ i ].varValue <= 0 && variableArray[ i ].varZeroDestination != '' && variableArray[ i ].varZeroDestination != locName ) {
              //
              //     adventureGo( variableArray[ i ].varZeroDestination );
              //
              //   }
              // }

              // console.log("buttons presented: " + buttonsPresented );


              $('historyDiv').scrollTop = 9999;

              //console.log("adventureGO() ends");
            }

            function doubleTheEqualSignForEval( theString ) {

              if ( theString.indexOf( '<=' ) > -1 ) { return theString }

              if ( theString.indexOf( '>=' ) > -1 ) { return theString }

              if ( theString.indexOf( '==' ) > -1 ) { return theString }

              if ( theString.indexOf( '=' ) > -1 ) {

                theString = theString.substring( 0, theString.indexOf( '=' )  )
                   + '==' + theString.substring( theString.indexOf( '=' ) + 1, 999  );

              }

              return theString;

            }

            function successGo() {

              document.getElementById("dryrunDiv").style.display = "none";
              document.getElementById("combatDiv").style.display = "none";

              if ( newLoc.type.toUpperCase() == "F") {
                foesWeHaveRemoved.push( newLoc.name );
              }

              adventureGo( destinationTrue );

            }

            function failureGo() {

              document.getElementById("dryrunDiv").style.display = "none";
              document.getElementById("combatDiv").style.display = "none";

              if ( newLoc.type.toUpperCase() == "F") {
                foesWeHaveRemoved.push( newLoc.name );
              }

              adventureGo( destinationFalse );

            }





            function setCurrentTime () {

              var d = new Date();

              hours = d.getHours();

              if ( hours > 12 ) {
                hours -= 12;
                meridian = "PM";
              } else {
                meridian = "AM";
              }

              minutes = d.getMinutes();

              if ( minutes < 10 ) {
                minutes = "0" + minutes;
              }


              document.getElementById("currentTimeSpan").innerHTML = hours + ":" + minutes + " " + meridian;

            }

            function saveLocal() {

              if( localStorage.allowCookies == 1 ) {

                localStorage.setItem( "userAdventure", document.getElementById("userInputTextArea").value );

              }
            }

            function loadLocal() {

              if( localStorage.allowCookies == 1 ) {

                document.getElementById("userInputTextArea").value = localStorage.getItem( "userAdventure" );

              }
            }

            function restoreLastOverwrite() {

              console.log( "restoreLastOverwrite()" );

              document.getElementById("userInputTextArea").value = localStorage.lastOverwrite;

              reviewUserInput();

              convertArrayToVisual();

            }

            function overwriteFunction() {

             console.log(overwrite);

              localStorage.lastOverwrite = document.getElementById("userInputTextArea").value;

              switch ( overwrite ) {
                case 'loadLocal':
                  loadLocal();
                  break;
                case 'blank':
                  enterTemplate();
                  break;
                case 'file':
                  loadAdventure();
                  break;
                case 'toadGodTemple':
                  toadGodTemple();
                  break;
                case 'towerGoblin':
                  document.getElementById("userInputTextArea").value = document.getElementById("towerGoblin").innerText;
                  break;
                case 'tomb':
                  document.getElementById("userInputTextArea").value = document.getElementById("tomb").innerText;
                  break;
                case 'wilfurd':
                  document.getElementById("userInputTextArea").value = document.getElementById("wilfurd").innerText;
                  break;
                case 'ordinaryDungeon':
                    ordinaryDungeon();
                    break;
                case 'memory':
                  document.getElementById("userInputTextArea").value = document.getElementById("memoryDiv").innerText;
                  break;
                case 'newtPool':
                  document.getElementById("userInputTextArea").value = document.getElementById("newtPool").innerText;
                  break;
                case 'JSON':
                  // document.getElementById("userInputTextArea").value = JSON.parse(document.getElementById('JSONTextArea').value);

                  importedJSON = JSON.parse( document.getElementById('JSONTextArea').value );

                  titleStr = importedJSON.titleStr;
                  creatorStr = importedJSON.creatorStr;
                  maxAttr = importedJSON.maxAttr;
                  descriptionStr = importedJSON.descriptionStr;
                  adventureArray = importedJSON.adventureArray;

//                  visualVariableArray = importedJSON.tempVarArray;
//                  variableArray = importedJSON.tempVarArray;
                  variableArray = variableArray.filter( whatever => whatever.varType!='U' );
                  variableArray.push( ...importedJSON.tempVarArray );

                  convertArrayToVisual();
                  convertVisualEditorToString();

                  break;
                default:
                  console.log('overwriteFunction() was called with an unknown overwrite name: ' + overwrite );
              }

              deletedNodes = [];

              removeLeadingSpaces( userInputTextArea );
              removeTopBlankLines( userInputTextArea );

              reviewUserInput();

              convertArrayToVisual();

            }

            function removeLeadingSpaces(textarea) {
                // Split the textarea content into an array of lines
                const lines = textarea.value.split('\n');

                // Remove leading spaces from each line
                const trimmedLines = lines.map(line => line.trimStart());

                // Join the trimmed lines back together and set the textarea value
                textarea.value = trimmedLines.join('\n');
            }

            function removeTopBlankLines(textarea) {
                // Split the textarea content into an array of lines
                const lines = textarea.value.split('\n');

                // Remove blank lines from the top
                const trimmedLines = lines.slice(lines.findIndex(line => line.trim() !== ''));

                // Join the lines back together and set the textarea value
                textarea.value = trimmedLines.join('\n');
            }


            // const downloadToFile = (content, filename, contentType) => {
            //   const a = document.createElement('a');
            //   const file = new Blob([content], {type: contentType});
            //
            //   a.href= URL.createObjectURL(file);
            //   a.download = filename;
            //   a.click();
            //
            // 	URL.revokeObjectURL(a.href);
            // };

            function saveToDownloads() {

                const a = document.createElement('a');
                const file = new Blob([ document.getElementById('userInputTextArea').value ], {type: 'text/plain'});

                var d = new Date();

                          dateString = d.getMonth() + "-" + d.getDate() + "-" + d.getYear() + " " + d.getHours() + " " + d.getMinutes();

                a.href= URL.createObjectURL(file);
                a.download = titleStr + " " + dateString;
                a.click();

              	URL.revokeObjectURL(a.href);



            }

            function generateExportable() {

              theFnord = fnord();


              exportableString = "<><><><><><><><><><><><><><><><><><><><><><><><>\n";
              exportableString += titleStr + "\n";
              exportableString += "By " + creatorStr + "\n";
              exportableString += "An adventure for TFT Helper and The Fantasy Trip\n";
              exportableString += descriptionStr + "\n";
              exportableString += theFnord + "\n";
              exportableString += JSON.stringify(adventureArray).length + "\n";

              exportableString += "<><><><><><><><><><><><><><><><><><><><><><><><>\n";

    //          exportableString += scrambledString + "\n";

              exportableString += scramble( titleStr ) + "\n";
              exportableString += scramble( creatorStr ) + "\n";
              exportableString += scramble( descriptionStr ) + "\n";
              exportableString += scramble( maxAttr.toString() ) + "\n";
              exportableString += scramble( testMode.toString() ) + "\n";

              exportableString += scramble( JSON.stringify(variableArray.filter( whatever => whatever.varType=='U' ) ), theFnord  ) + "\n";

              exportableString += scramble( JSON.stringify(adventureArray) ) + "\n";

              exportableString += "<><><><><><><><><><><><><><><><><><><><><><><><>\n";

              let tempVarArray = variableArray.filter( whatever => whatever.varType=='U' );

              jsonExportable = {
                titleStr,
                creatorStr,
                maxAttr,
                descriptionStr,
                tempVarArray,
                adventureArray
              }

              return exportableString;

            }


            function cookies( newSetting ) {

              localStorage.setItem( 'allowCookies', newSetting );

              if ( newSetting == 1 ) {

                document.getElementById('cookieStatus').innerText = 'localStorage is currently enabled.';

              } else {

                document.getElementById('cookieStatus').innerText = 'localStorage is not currently enabled.';

              }

            }

            function generateFlowChart() {

              chartString="<pre class = 'mermaid'>\n";

              chartString+="graph TD\n";

              for ( let i = 0; i < adventureArray.length; i++ ) {

                switch( adventureArray[ i ].type ) {
                  case 'l':
                    locDestinations = locationLeadsTo( i );
                    for ( let j = 0; j < locDestinations.length; j++ ) {
//                      chartString += adventureArray[i].name + '-->' + locDestinations[ j ] + '\n';
                      chartString += adventureArray[i].name + '-->|' + arrayOfButtonNames[ j ] + '|' + locDestinations[ j ] + '\n';
                    }
                    break;

                  case 'b':
                    // compString = adventureArray[i].firstExpression + ' and ' + adventureArray[i].secondExpression;
                    chartString += 'style ' + adventureArray[i].name + ' fill: #aaf\n';
                    if ( adventureArray[i].comparator == '<' ) {
                      compStr = '\<';
                    } else {
                      compStr = adventureArray[i].comparator;
                    }
                    compString = adventureArray[i].firstExpression + '>' + adventureArray[i].secondExpression;
                    //console.log(compString);
                    chartString += adventureArray[i].name + '{' + adventureArray[i].name + '\\n' + compString + '}-->|true|' + adventureArray[i].destinationTrue + '\n';
                    chartString += adventureArray[i].name + '-->|false|' + adventureArray[i].destinationFalse + '\n';
                    break;

                  case 'f':
                    chartString += 'style ' + adventureArray[i].name + ' fill: #f96\n';
                    chartString += adventureArray[i].name + '((' + adventureArray[i].name + '))-->|win|' + adventureArray[i].winDestination + '\n';

                    chartString += adventureArray[i].name + '-->|lose|' + adventureArray[i].loseDestination + '\n';
                  break;

                }


              } // end of adventureArray loop i

              chartString+="</pre>\n";


              $('flowChartCode').innerText = chartString;

              $('flowchartDiv').innerHTML = chartString;

              mermaid.init();

            } //  end of generateFlowChart()

            function locationLeadsTo( whichNode ) {

              arrayOfDestinations = [];

              arrayOfButtonNames = [];

              nextPosition = adventureArray[ whichNode ].html.indexOf( 'adventureGo' );

              while ( nextPosition > -1 ) {

                destinationOfThisButton = adventureArray[ whichNode ].html.substring( nextPosition + 13, adventureArray[ whichNode ].html.indexOf( '"', nextPosition + 14 ) );

                arrayOfDestinations.push( destinationOfThisButton );

                buttonTextStart = adventureArray[ whichNode ].html.indexOf( ")'>", nextPosition ) + 3;
                buttonTextEnd = adventureArray[ whichNode ].html.indexOf( "</div>", nextPosition );

                buttonText = adventureArray[ whichNode ].html.substring( buttonTextStart, buttonTextEnd );

                arrayOfButtonNames.push( buttonText );

                nextPosition = adventureArray[ whichNode ].html.indexOf( 'adventureGo', nextPosition + 11 );

              }

              return arrayOfDestinations;

            } // end of locationLeadsTo()

            function flKeyup( theEvent ) {
              if ( theEvent.key =='Enter' ) {

                $('newFirstLaterName').value = $('newFirstLaterName').value.slice(0, -1);

                actuallyAddFirstLater();

              }
            }

            function addFoeKeyup( theEvent ) {
              if ( theEvent.key =='Enter' ) {

//                $('newFirstLaterName').value = $('newFirstLaterName').value.slice(0, -1);

                visAddFoe();

              }
            }

        function make100Rooms(){

          returnString = '';

          for ( let x = 101; x < 200; x++ ) {

            returnString += '@location room' + x + '\n This is room number ' + x + '. \n\n@button room' + (x+1) + '\n Go To Room ' + (x+1) + '\n';


          }

          $('userInputTextArea').value += returnString;

        }

        function forceColorMode( newMode ) {

          localStorage.colorMode = newMode;

          document.querySelector('input[name="colorMode"][value= ' + newMode + ' ]').checked = true;

          switchColorMode();

        }

        function switchColorMode() {
          const selectedMode = document.querySelector('input[name="colorMode"]:checked').value;
//          console.log("Selected color mode:", selectedMode);

          localStorage.colorMode = selectedMode;

          let elements = [];

          switch (selectedMode) {

            case 'dark':

              document.documentElement.style.setProperty('--link-color', '#cccccc');
              document.documentElement.style.setProperty('--bgColor', '#000000');
              document.documentElement.style.setProperty('--pageColor', '#444444');
              document.documentElement.style.setProperty('--textColor', '#cccccc');
              document.documentElement.style.setProperty('--selectedColor', '#ffffff');
              document.documentElement.style.setProperty('--textAreaBGColor', '#aaaaaa');
              document.documentElement.style.setProperty('--lineNumberColor', '#444444');
              document.documentElement.style.setProperty('--niftyButtonTextColor', '#333333');
              document.documentElement.style.setProperty('--niftyButtonBorderColor', '#000000');
              document.documentElement.style.setProperty('--niftyButtonBGColor', '#eeeeee');
              document.documentElement.style.setProperty('--niftyButtonShadowColor', '#111111');

              break;

            case 'light':

              document.documentElement.style.setProperty('--link-color', '#0000ff');
              document.documentElement.style.setProperty('--bgColor', '#dddddd');
              document.documentElement.style.setProperty('--pageColor', '#ffffff');
              document.documentElement.style.setProperty('--textColor', '#000000');
              document.documentElement.style.setProperty('--selectedColor', 'darkred');
              document.documentElement.style.setProperty('--textAreaBGColor', '#ffffff');
              document.documentElement.style.setProperty('--lineNumberColor', 'grey');
              document.documentElement.style.setProperty('--niftyButtonTextColor', '#000000');
              document.documentElement.style.setProperty('--niftyButtonBorderColor', '#000000');
              document.documentElement.style.setProperty('--niftyButtonBGColor', '#cccccc');
              document.documentElement.style.setProperty('--niftyButtonShadowColor', '#111111');

              break;

              case 'melee':

                document.documentElement.style.setProperty('--link-color', '#ff0000');
                document.documentElement.style.setProperty('--bgColor', '#550000');
                document.documentElement.style.setProperty('--pageColor', '#880000');
                document.documentElement.style.setProperty('--textColor', '#D2c58C');
                document.documentElement.style.setProperty('--selectedColor', 'darkorange');
                document.documentElement.style.setProperty('--textAreaBGColor', '#e0bbaa');
                document.documentElement.style.setProperty('--lineNumberColor', '#3a3a3a');
                document.documentElement.style.setProperty('--niftyButtonTextColor', '#D2c58C');
                document.documentElement.style.setProperty('--niftyButtonBorderColor', '#D2c58C');
                document.documentElement.style.setProperty('--niftyButtonBGColor', '#552222');
                document.documentElement.style.setProperty('--niftyButtonShadowColor', '#D2c58C');

                break;


              case 'wizard':

                document.documentElement.style.setProperty('--link-color', '#bb00bb');
                document.documentElement.style.setProperty('--bgColor', 'indigo');
                document.documentElement.style.setProperty('--pageColor', 'darkslateblue');
                document.documentElement.style.setProperty('--textColor', '#ffffff');
                document.documentElement.style.setProperty('--selectedColor', '#aa00aa');
                document.documentElement.style.setProperty('--textAreaBGColor', 'skyblue');
                document.documentElement.style.setProperty('--lineNumberColor', '#444444');
                document.documentElement.style.setProperty('--niftyButtonTextColor', '#99ccff');
                document.documentElement.style.setProperty('--niftyButtonBorderColor', 'black');
                document.documentElement.style.setProperty('--niftyButtonBGColor', '#660000');
                document.documentElement.style.setProperty('--niftyButtonShadowColor', '#000000');

                break;

              case 'blue':

                document.documentElement.style.setProperty('--link-color', '#aaddff');
                document.documentElement.style.setProperty('--bgColor', '#1A1A2E');
                document.documentElement.style.setProperty('--pageColor', '#213350');
                document.documentElement.style.setProperty('--textColor', '#ffffff');
                document.documentElement.style.setProperty('--selectedColor', 'aa00aa');
                document.documentElement.style.setProperty('--textAreaBGColor', 'skyblue');
                document.documentElement.style.setProperty('--lineNumberColor', '#333333');
                document.documentElement.style.setProperty('--niftyButtonTextColor', '#000066');
                document.documentElement.style.setProperty('--niftyButtonBorderColor', 'black');
                document.documentElement.style.setProperty('--niftyButtonBGColor', '#88aabb');
                document.documentElement.style.setProperty('--niftyButtonShadowColor', '#000000');

                break;

              case 'elvish':

                document.documentElement.style.setProperty('--link-color', '#00ff00');
                document.documentElement.style.setProperty('--bgColor', '#004400');
                document.documentElement.style.setProperty('--pageColor', 'darkgreen');
                document.documentElement.style.setProperty('--textColor', '#D2c58C');
                document.documentElement.style.setProperty('--selectedColor', 'springgreen');
                document.documentElement.style.setProperty('--textAreaBGColor', '#9FcC9F');
                document.documentElement.style.setProperty('--lineNumberColor', 'darkgrey');
                document.documentElement.style.setProperty('--niftyButtonTextColor', '#002200');
                document.documentElement.style.setProperty('--niftyButtonBorderColor', '#003300');
                document.documentElement.style.setProperty('--niftyButtonBGColor', '#77dd77');
                document.documentElement.style.setProperty('--niftyButtonShadowColor', '#000000');

                break;


              default:

                document.documentElement.style.setProperty('--link-color', '#bb00bb');
                document.documentElement.style.setProperty('--bgColor', 'indigo');
                document.documentElement.style.setProperty('--pageColor', 'darkslateblue');
                document.documentElement.style.setProperty('--textColor', '#ffffff');
                document.documentElement.style.setProperty('--selectedColor', 'aa00aa');
                document.documentElement.style.setProperty('--textAreaBGColor', 'skyblue');
                document.documentElement.style.setProperty('--lineNumberColor', 'darkgrey');
                document.documentElement.style.setProperty('--niftyButtonTextColor', 'cyan');
                document.documentElement.style.setProperty('--niftyButtonBorderColor', 'black');
                document.documentElement.style.setProperty('--niftyButtonBGColor', '#666666');
                document.documentElement.style.setProperty('--niftyButtonShadowColor', '#000000');

          }


        }



            function saveAdventure() {

              // Get the content of the textarea
              const text = document.getElementById('userInputTextArea').value;

              // Create a Blob with the text content
              const blob = new Blob([text], { type: 'text/plain' });

              // Create a download link
              const link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = titleStr + '.txt';

              // Simulate a click to download the file
              link.click();

              // Clean up by revoking the object URL
              window.URL.revokeObjectURL(link.href);

            }

            function exportableToFile() {

              // Get the content of the textarea
              const text = document.getElementById('exportableTextArea').value;

              // Create a Blob with the text content
              const blob = new Blob([text], { type: 'text/plain' });

              // Create a download link
              const link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = titleStr + 'EXPORT.txt';

              // Simulate a click to download the file
              link.click();

              // Clean up by revoking the object URL
              window.URL.revokeObjectURL(link.href);

            }

            function exportableToClipboard() {

              const textarea = document.getElementById("exportableTextArea");
              navigator.clipboard.writeText(textarea.value);


            }

            function jsonToClipboard() {

              const textarea = document.getElementById("jsonTextArea");
              navigator.clipboard.writeText(textarea.value);

            }


            function loadAdventure() {

              document.getElementById('fileInput').click();



            }

            function homeClick() {

              console.log('homeClick()');

            }

            function showLoc() {

              $('refDiv').style.display = 'none';
              $('locDiv').style.display = 'block';

            }

            function showRef() {

              $('refDiv').style.display = 'block';
              $('locDiv').style.display = 'none';

            }

            function changeShowWarnings() {

              if ( localStorage.showWarnings > 0 ) {

                localStorage.showWarnings = 0;

              } else {

                localStorage.showWarnings = 1;

              }

            }


            function changeShowJSON() {

              if ( localStorage.showJSON > 0 ) {

                localStorage.showJSON = 0;

                document.getElementById('jsonSection').style.display='none';

              } else {

                localStorage.showJSON = 1;
                document.getElementById('jsonSection').style.display='block';

              }

            }


            function showDocTopic( theTopic ) {

              document.querySelectorAll('[id$="TopicButton"]').forEach(element =>
                  { element.classList.remove( 'selectedTopic' ) } );

              document.getElementById( theTopic + 'TopicButton' ).classList.add( 'selectedTopic' );

              document.querySelectorAll('.docTopic').forEach(element => {  element.style.display = 'none'; } )

              document.getElementById( theTopic ).style.display = 'block' ;

            }



    </script>

    <style>

        :root {
            --link-color: #0000ff; /* Default link color */
            --bgColor: #dddddd;
            --pageColor: #ffffff;
            --textColor: #000000;
            --selectedColor: darkred;
            --textAreaBGColor: #ffffff;
            --lineNumberColor: grey;
            --niftyButtonTextColor: #000000;
            --niftyButtonBorderColor: #000000;
            --niftyButtonBGColor: #888888;
            --niftyButtonShadowColor: #111111;


        }

        a {
            color: var(--link-color);
        }


        .code {
            margin-left: 20px; /* Adjust the value as needed */
            white-space: pre-wrap; /* This will respect line breaks and spaces */
            font-family: monospace; /* Monospaced font for code readability */
            background-color: #f4f4f4; /* Optional: light background for better contrast */
            padding: 10px; /* Optional: padding for better spacing */
            border-left: 3px solid #ddd; /* Optional: a left border to highlight code block */
            word-wrap: break-word; /* Allows long words to break and wrap */
            overflow-wrap: break-word; /* Ensures text breaks to prevent overflow */
        }

        /* .tinyButton {
            line-height: 0.5;
            border: solid thin;
            margin: 0.5vh;
            border-radius: 10px;
            padding: 0.3vh 0.7vh;
            text-align: center;
            box-shadow: 0.2vh 0.4vh;
            background-color: white;

        } */

        .hiddenContent {
            opacity: 0; /* Set opacity to 0 */
            transition: visibility 0s 0.3s, opacity 0.3s ease; /* Delay visibility change for smooth effect */
        }

        .hiddenContent:hover {
            opacity: 1; /* Set opacity to full */
            transition-delay: 0s; /* Reset transition delay */
        }

        .minorButton {

          border: solid thin;
          margin: 0.5vh;
          border-radius: 7px;
          padding: 0.2vh 0.5vh;
          text-align: center;
          /* background-color: white; */
          font-size: small;

        }

        .inlineButton {
            border: solid thin;
            border-radius: 4px;
            padding: 0px 4px;
        }

        .nodeEditorButton {
            border: solid thin;
            margin: 0.5vh;
            border-radius: 7px;
            padding: 0.3vh 0.7vh;
            text-align: center;
            box-shadow: 0.2vh 0.4vh 0.5vh #111111;
            display: inline-block;
            background-color: white;
            /* background-color: var(--niftyButtonBGColor); */
          }

          .nodeEditorButton:active {
              transform: translate( 2px, 2px);

          }


        .niftyButton {
            border: solid thin;
            margin: 0.5vh;
            border-radius: 7px;
            padding: 0.3vh 0.7vh;
            text-align: center;
            /* box-shadow: 0.2vh 0.4vh; */
            display: inline-block;

            background-color: var(--niftyButtonBGColor);
            color: var(--niftyButtonTextColor);
            border-color: var(--niftyButtonBorderColor);
            background-color: var(--niftyButtonBGColor);
            /* box-shadow: var(--niftyButtonShadowColor); */
            box-shadow: 0.2vh 0.4vh 1vh var(--niftyButtonBorderColor);

        }

        .niftyButton:active {
            /* background-color: lightgrey;
            box-shadow: 0.1vh 0.2vh; */
            transform: translate( 2px, 2px);

        }

        .tabButton {
            border: solid thin;
            border-radius: 15px 15px 0 0;
            padding: 7px 15px;
            background-color: #bbb;
            border-color: black black var(--pageColor) black;
            margin-top: 10px;
        }

        .tabButton:hover {
            background-color: #ddd;
        }

        .tabButton.active {
            background-color: var(--pageColor) ;
/*            border-bottom: none;*/
            border-bottom-color: var(--pageColor) ;
        }

        .page {
            color: var(--textColor);
            background-color: var(--pageColor);
            border: solid thin;
            margin: 5px 0px;
            padding: 2vw;
            border-radius: 0px 10px 10px 10px;
            border-color: black;
        }

        .howto {
            background-color: white;
/*            float: left;*/
            clear: both;
        }

        .example {
            background-color: ivory;
            font-family: monospace;
/*            width: 50%;*/
            border: dotted thin;
/*            white-space: pre-wrap;*/
        }

        .nitty {
            background-color: lightblue;
            border: solid thin;
            margin: 5px 0px;
            padding: 2vh;
            width: 50%;
            float: right;
            clear: both;
            display: none;
        }

        .adventureButtonE {
            background-image: linear-gradient(silver, white, silver);
            color: black;
            border: solid thin;
            width: 20%;
            /* height: 1vh; */
            margin: 6px;
            border-radius: 6px;
            padding: 6px;
            text-align: center;
        }

        .adventureButton {
            background-image: linear-gradient(silver, white, silver);
            color: black;
            border: solid thin;
            width: 78%;
            margin: 2%;
            border-radius: 6px;
            padding: 2% 8%;
            text-align: center;
        }

        .adventureButton:active {
            background-color: lightgrey;
            box-shadow: 0.1vh 0.2vh;
            transform: translateX( 2px);
            transform: translateY( 2px);

        }

        .watermark {
          pointer-events: none;
          position: absolute;
          z-index: 10;
          opacity: 15%;
          top: 500px;
          right: 10%;
          color:red;
          font-size:120px;
          transform:rotate(-30deg);
        }

        .blinking {
        	animation:blinkingText 3s infinite;
        }
        @keyframes blinkingText{
        	0%{		color: #0F0;	}
        	99%{	color:transparent;	}
        	100%{	color: #000;	}
        }

        .buttonCondition {
            vertical-align: middle;
        }

        .textCondition {
            vertical-align: middle;
        }

        .overlay-div {
            position: absolute; /* Position the new div absolutely */
            top: 0;
            left: 0;
            width: 100%; /* Take up the full width of the outer div */
            height: 100%; /* Take up the full height of the outer div */
            pointer-events: none; /* Prevent interference with other divs */
            /* background-color: rgba(0, 0, 0, 0.5); /* Example background to visualize the div */
            z-index: 1; /* Ensure it is on top of other divs */
        }

        .emphasized {
          font-weight: bold;
        }


    </style>


      <div id="confirmationBox" style="position: fixed; left: 30%; right: 30%; top: 30%; bottom: 30%; display: none; z-index: 997">
        <img src="art/stoneoutline.png" style="width: 100%">

        <div id="confirmationMessageBox" style="background-color:  white; position: absolute; left: 10%; right: 10%; top: 20%; text-align: center">
          Are you sure you want to do this crazy thing?
        </div>

        <div id="confirmationMessageBox" style="position: absolute; left: 10%; right: 10%; top: 50%; text-align: center">
          <span id='confirmYesButton' class="nodeEditorButton">&nbsp;&nbsp;Yes&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nodeEditorButton" onclick="$('confirmationBox').style.display='none';">&nbsp;&nbsp;No&nbsp;&nbsp;</span>
        </div>
      </div>


      <div id="undeleteNodeBox" style="position: fixed; left: 30%; right: 30%; top: 30%;  padding: 0.5vh; background-color: white; display: none; border: double; z-index:999">

        <img src='art/gembar.png' style="width: 100%;">

        <!-- <div  style="position: absolute; left: 13%; top: 11%; transform( 0%, -50%); "> -->
          <div  style="position: absolute; left: 13%; top: 1.5vh; transform( 0%, -50%); ">
          Select a node to restore
        </div>

        <div id="deletedNodesMenu" style='padding: 1.5vh;'>
        </div
        <br>
        <br>
        <div style="text-align:center">
          <span class='nodeEditorButton' onclick='$("undeleteNodeBox").style.display = "none";'>Never Mind</span>
        </div>
        <br><br>
      </div>




      <div id='cookieBox' style="position: fixed; width: 40%; top: 20%; left:30%; border: solid thick darkGrey; background:lightgrey; display:none;">

        <br>
        <br>
        <br>

        <p style='text-align: center'>
          Allow cookies?
        </p>
        <br>
        <br>

        <p style='text-align: center'>
          <span class='adventureButton' onclick='document.getElementById("cookieBox").style.display="none";cookies(1)'>
            Yes!
          </span>
          <span class='adventureButton' onclick='document.getElementById("cookieBox").style.display="none";showPage(7)'>
            Wait, what, maybe no? Explain please...
          </span>
        </p>

        <br>
        <br>
        <br>
        <br>

      </div>

      <!-- <div id="tabs" style="border: solid thin; border-color: white white black white"> -->
      <div style ="height: 5px;">
        &nbsp;
      </div>

        <div id="tabs" style = "z-index: -1; ">

            <span class="tabButton" id="tab1" onclick="showPage(1)">Overview</span>
            <!-- <span class="tabButton" id="tab9" onclick="showPage(9)">Using the Editor</span> -->
            <span class="tabButton" id="tab8" onclick="showPage(8)">Editor</span>
            <span class="tabButton" id="tab4" onclick="showPage(4)">Simulator</span>
            <span class="tabButton" id="tab5" onclick="showPage(5)">Exportable</span>
            <!-- <span class="tabButton" id="tab2" onclick="showPage(2)">Using Text Editor</span> -->
            <span class="tabButton" id="tab3" onclick="showPage(3)">Text Editor</span>
            <span class="tabButton" id="tab6" onclick="showPage(6)">Examples</span>
            <span class="tabButton" id="tab10" onclick="showPage(10)">Graphic</span>
            <span class="tabButton" id="tab7" onclick="showPage(7)">Settings</span>

            <span class='hiddenContent'>

              <span onclick='forceColorMode("light")' style='float: right; background-color: white; border: solid thin black; border-radius: 50%;'>L</span>
              <span onclick='forceColorMode("melee")' style='float: right; background-color: orange; border: solid thin black; border-radius: 50%;'>M</span>
              <span onclick='forceColorMode("wizard")' style='float: right; background-color: purple; border: solid thin black; border-radius: 50%;'>W</span>
              <span onclick='forceColorMode("elvish")' style='float: right; background-color: green; border: solid thin black; border-radius: 50%;'>E</span>
              <span onclick='forceColorMode("blue")' style='float: right; background-color: blue; border: solid thin black; border-radius: 50%;'>B</span>
              <span onclick='forceColorMode("dark")' style='float: right; background-color: grey; border: solid thin black; border-radius: 50%;'>D</span>

            </span>

        </div>

        <!-- <div style="position: fixed; bottom: 5px; right: 5px; border: solid thin; background-color: lightgrey; padding: 7px; " onclick="window.scrollTo( 0, 0 );">
          Back to Top
        </div> -->

        <div id="page1" class="page" style='display: flex; width: 95%;'>

<span class="watermark">Beta</span>

        <div style='width: 15%;text-align: right; padding-right: 2vw;'>
          <span id ='overviewTopicButton' onclick = 'showDocTopic("overview")' class='niftyButton selectedTopic'>Overview</span><br><br><br>
          <span id ='basicsTopicButton' onclick = 'showDocTopic("basics")' class='niftyButton'>The Basics</span><br><br><br>
          <span id ='nodesTopicButton' onclick = 'showDocTopic("nodes")' class='niftyButton'>Nodes</span><br><br><br>
          <span id ='usingEditorTopicButton' onclick = 'showDocTopic("usingEditor")' class='niftyButton'>Using&nbsp;the&nbsp;Editor</span><br><br><br>
          <span id ='actionsTopicButton' onclick = 'showDocTopic("actions")' class='niftyButton'>Actions</span><br><br><br>
          <span id ='variablesTopicButton' onclick = 'showDocTopic("variables")' class='niftyButton'>Variables</span><br><br><br>
          <span id ='usingSimulatorTopicButton' onclick = 'showDocTopic("usingSimulator")' class='niftyButton'>Using&nbsp;the&nbsp;Simulator</span><br><br><br>
          <span id ='exportableTopicButton' onclick = 'showDocTopic("exportable")' class='niftyButton'>The&nbsp;Exportable</span><br><br><br>
          <span id ='usingTextEditorTopicButton' onclick = 'showDocTopic("usingTextEditor")' class='niftyButton'>Using&nbsp;the&nbsp;Text&nbsp;Editor</span><br><br><br>
          <span id ='graphicTopicButton' onclick = 'showDocTopic("graphic")' class='niftyButton'>The&nbsp;Graphic</span><br><br><br>
          <span id ='settingsTopicButton' onclick = 'showDocTopic("settings")' class='niftyButton'>Settings</span><br><br><br>
        </div>

      <style>

          .docTopic {
            overflow-y: scroll;
            overflow-x: hidden;
            height: 90vh;
            width: 80%;
            display: none;
          }

          .selectedTopic {
            color: var(--selectedColor) !important;
            font-weight: bold;
          }

      </style>


      <div id ='overview' class = 'docTopic' style='display: block;'>

        <p>
            Welcome to the TFT Helper Adventure Creator! It's designed to make creating an adventure for TFT Helper as easy as possible. Thanks for checking it out!
        </p>
        <h3>Overview</h3>
        <p>
            You create an adventure in this web app by describing the various locations and the buttons that allow the characters to move from one to another. The adventure can also have branches where the computer sends the character to one of two locations based on various conditions you describe. Of course, you will also include some foes to fight! When you are finished you have an "Exportable", a block of scrambled text you can paste into the TFT Helper mobile app to play the adventure live. You can also share this finished adventure.
        </p>
        <p>
            You should see eight tabs at the top of this window...
        </p>
        <p>
          <b>Overview</b> - This introductory page, with buttons for various topics on the left.
        </p>
        <!-- <p>
          <b>Using The Editor</b> - How to use the adventure editor to create Locations, Branches, and Foes.
        </p> -->
        <p>
          <b>Editor</b> - This is where you actually craft your adventure.
        </p>
        <p>
          <b>Simulator</b> - Walk through your adventure as it would appear on a mobile device and make sure everything works as expected! You will be able to "see under the hood" and jump to any location, streamlining the testing process.
        </p>
        <p>
          <b>Exportable</b> - Presents the scrambled adventure you can load into TFT Helper and share with others.
        </p>
        <!-- <p>
          <b>Using The Text Editor</b> - How to use the text editor, which allows you to view and edit your adventure as raw text. This isn't as handy as the visual editor, but you can copy the text to the clipboard and that allows you to do two things. First, you can paste that text into a document and save it like any text, allowing you to back up adventures in progress. Second, if you are collaborating with someone on an adventure you can send the text back and forth between you.
        </p> -->
        <p>
          <b>Text Editor</b> - Here you can write and edit your adventure as raw text. Copying and pasting this text is also the way to back up or share an adventure in development. The same content is always displayed in the Editor, Text Editor, Simulator, and Exportable tab.
        </p>
        <p>
          <b>Examples</b> - Diagrams and descriptions of several sample dungeons. With a click these can be transferred to the editor so you can see how they were implemented (this will overwrite whatever is currently in the editors).
        </p>
        <p>
          <b>Graphic</b> - The current adventure presented as something like a flow chart. This non-interactive diagram is not a map, but if your adventure gets tangled this may help you figure things out.
        </p>
        <p>
          <b>Settings and Cookies</b> - Cookies and settings. There are not a lot, only whether you want the Adventure Creator to automatically back up your work inside the browser while you are working.
        </p>
        <h3>Writing Standards</h3>
        <p>
            You should strive for a high level of professionalism in an adventure you plan to share. While you are not writing for SJ Games, you are writing for the customers of SJ Games and they are accustomed to quality writing. Keep it PG, no hate. The SJ Games writer's guidelines will be very helpful.
        </p>
        <a href="http://www.sjgames.com/general/guidelines/authors/">http://www.sjgames.com/general/guidelines/authors/</a><br>
        <a href="http://www.sjgames.com/general/guidelines/authors/writing-thefantasytrip/">http://www.sjgames.com/general/guidelines/authors/writing-thefantasytrip</a><br>
        <a href="http://www.sjgames.com/general/online_policy.html">http://www.sjgames.com/general/online_policy.html</a><br>

        <a href="https://www.sjgames.com/general/guidelines/authors/style.html">https://www.sjgames.com/general/guidelines/authors/style.html</a><br>

        <a href="https://cairo.sjgames.com/news/2018/july/writing-a-solo-adventure">https://cairo.sjgames.com/news/2018/july/writing-a-solo-adventure/</a><br>

        <p>
          The Adventure Creator will check for potentially offensive language. The blacklist for offensive words is borrowed from elsewhere, so no warranties are made as to its completeness. If there are words you feel should be included or excluded please let us know at tfthelper@gmail.com
        </p>

        <h3>What is "Beta"?</h3>
        <p>
          In this case it means that the Adventure Creator is "feature complete" but
          has been tested only by a few people.
            Something as involved as this requires a lot of testing to be really reliable, so we need to release it to get more exposure. Because of the inherent security and app isolation of web browswers and moblie devices it is safe to use TFT Helper and New Adventures. The risk is that adventures may misbehave, or in a worst case scenario the TFT Helper app may freeze and need to be force closed. There is no known bug or potential bug that could cause the latter, but it's always a possibility. A poorly written adventure could lead the player to a dead end, but it should not affect the app's behavior otherwise.
           If you run into any issues let us know at tfthelper@gmail.com.
        </p>

        <h3>Tips for Writing Solo Adventures</h3>
        <p>
          Much GMing and narrative construction advice carries over, and we don't need to go over that here. But here are some guidelines to keep in mind.
        </p>

        <p>
          Don't make it too easy. If players complete the adventure on the first run through they are likely to feel disappointed and not revisit your adventure.
        </p>
        <p>
          Don't make it too hard. Specifically, there will only be a single character without a lot of resources so they won't be able to face a series of fearsome foes. Put in some weaker foes. Create paths by which clever adventurers can get around some foes. Put in some encounters that offer healing (perhaps at a cost).
        </p>
        <p>
          There should be a clear goal expressed early, perhaps even in the description. It's also fun to learn more about the goal in the first part of the adventure. Foreshadowing increases excitement.
        </p>
        <p>
          Small screens are not the place to read novels, so you'll want short, high impact descriptions of the important elements of the adventure, and no descriptions of anything else. Your players have imaginations and they've read some fantasy, they'll fill in the rest.
        </p>
        <p>
          You can achieve replayability by providing multiple paths to victory and degrees of success. The player should finish the game wanting to try again and achieve a better result or to try the paths not taken. Perhaps you can hint to players that characters with particular talents (eg Naturalist, Courtly Graces) will have opportunities to see other parts of the adventure and succeed via a different path.
        </p>
        <p>
          Variables can create a lot of depth in the world, but they also create work for you. Lean towards fewer rather than many, but make them meaningful.
        </p>
        <p>
          It is fun to learn hidden secrets. As they progress through the adventure an exciting reward is learning more about what's going on in the story, discovering that things are not as they appear.
        </p>
        <p>
          Treasure is a classic reward, but that's because you look forward to spending it. You might devise a treasure that you can use during the adventure. Possessing a treasure can take the character to an alternate version of some locations where the character can see more or do more. If the character kills a giant rat and finds some gold the player is unlikely to remember the adventure, thre was nothing for the player to take away But if the first part of the adventure creates some curiousity about the mystery of the abandoned temple and completing the adventure means learing the secret, that will give the player something to remember.
        </p>
        <p>
          Beware of paths that become boring or frustrating. If the player makes choices that make winning impossible, wrap things up. Write a destination that explains that they lost, or introduce an unbeatable foe. Either way they get to try again and make different choices.
        </p>
        <p>
          It's very rewarding to players to receive goodies because their characters have particular particular Talents. These should be extras, however; an adventure that can only be won though knowledge of Courtly Graces will be frustrating if this is not made clear early on (hopefully in the description).
        </p>


      </div>


      <div id ='basics' class = 'docTopic'>

        <p>
        The Adventure Creator has been designed to make it easy for anyone to create an adventure. To that end this section, along with the sections on Using the Editor and Using the Text Editor, have been written with the important topics at the outset. You do not need to read these in their entirity, just as much as you can swallow. Reading further will introduce you to more tools to create more involved adventures, but adventures will be compelling based on design and writing, not bells and whistles. That said, bells and whistles are fun and can bring the fantasy world to life. The point is, read only as much as you want, then start creating. When you feel like it go back and read more to get more toys.
        </p>

        <p>
          If you have played Death Test or any Choose-Your-Own-Adventure style game, you know the basic unit of solitaire adventures is the numbered paragraph. If you have not played Death Test you should probably stop and do that now, you have hours of exciting fun ahead of you and you a good grasp of the numbered-paragraph system will be very useful here, even though TFT Helper Adventure Creator doesn't use numbers, or paragraphs.
        </p>
        <p>
          Instead, we have Nodes. A node can be a location, a trap, a foe, a test against an attriubte, a decision point in a conversation, etc. They come in three functional types: Locations, Branches, and Foes. A Location has text for the player and one or more buttons to take them further along. A Location could be a fork in the road, a response point in a conversation, a decision to drink from the magic fountain, etc. The player reads some text and taps a button. A Branch is invisible to players, the software will send the character to one of two locations according to a condition you specify, such as rolling 3d vs adjDX. A Foe is just that - something the character will fight. These nodes have names used by author and the software but the player won't see these. All three types are described in detail under Nodes.

          <p>
            In addition, some locations will have Actions. These are actions for the software to perform, not the character. When arriving at a Location means that something has changed - perhaps the character has taken damage or earned some XP, you will add that to the Location as an Action. The text of the Location can let the player know this has happened or not, as the author sees fit. These are described in full under Actions.
          </p>

          <p>
            Finally, there are Variables. Variables allow the adventure to track various things during the adventure, such as how much rope has been collected, whether or not the character has picked up a key, whether or not a certain place has been visited. These are initialized at the beginning of the adventure, modified by Actions, and checked by Branches. You can also include them in location descriptions. All this is described in detail under Variables.
          </p>

        <p>
        </p>

        <p>
        </p>

        <p>
        </p>

      </div>

      <div id ='nodes' class = 'docTopic'>


                <p>
                  Nodes are the basic unit of an adventure, and they come in three types, Locations, Branches, and Foes.
                </p>

                <p>
                  Every node will have a name, which the players will not see. These are the equivelent of the paragraph numbers in a traditional solitaire adventure. When a button or branch outcome takes the player to another node the name is how it knows where to go. Node names are a string of letters and numbers with no spaces, ideally something that helps you remember what this node is.
                </p>

                <p>
                  A Location might be a physical place, but it could also be a part of a conversation with an NPC, or a report of something that has happened. One physical place in the adventure might correspond to several Locations in the adventure, since how that place is presented and what options the character has may depend on how the character got there. In these ways it is similar to a paragraph in the traditional solitair adventure.
                </p>

                <p>
                  Locations can have four parts: the name, Actions, paragraphs of text, and buttons. Actions will be discussed later, and you can postpone learning about them. The paragraphs of text are what will appear on screen when the character arrives at this Location. Buttons are also presented, but they appear as buttons and if tapped they will take the character to another node. A Location must have some text - to leave the player with nothing on the screen doesn't make sense. A Location without buttons is a dead end; this is only appropriate for the end of the adventure, since the ony thing the player can do at that point is touch the Main Menu button of the mobile app and leave the adventure. When writing adventure text you can't use @ or ^ as these have a special meaning to the software that interprets the adventure.
                </p>

                <p>
                  You can also include Conditional Buttons or paragraphs. These are optional. Conditional buttons and paragraphs will only appear if a certain condition is met. This lets you customize a Location to specific game condtions. For example: maybe characters with the Naturalist talent will see something others don't, the condition would be Naturalist > 0. You can learn more about how to write the condtions in the section on Variables.
                </p>

                <p>
                  Branches are nodes that are not presented to the player, they are executed by the software. Branches always have four elements: the name, the branch expression, the true destination, and the false destination. The branch expression is what the branch is switching on, such as a DX roll, the value of a variable, a reaction roll, etc. The true destination is the node the software will go to if the branch expression turns out to be true. The false destination is where the software will go if the branch expression turns out to be false.
                </p>

                <p>
                  Branch expressions are basically algebraic expressions, and can include variables, character attributes, die rolls.
                </p>

                <ul style='list-style-type: none; '>
                  <li>1d > 4 (a good reaction roll)</li>
                  <li>3d <= adjDX (a basic DX saving throw)</li>
                  <li>amuletfound > 0 (has the variable amuletfound been set to something other than zero?)</li>
                  <li>ST > 12 (is the character's ST at least 13?)</li>
                  <li>armor > 2 (is the character wearing metal armor?)</li>
                  <li>courtlygraces (does the character have the Courtly Graces talent?)</li>
                </ul>

                <p>
                  Branch expressions can be more complicated if you want to capture more detail. For example:
                  <ul style='list-style-type: none; '>
                  <li>3d <= adjDX + ( 3 * acrobatics ) - this is a 3 die DX roll with a bonus of 3 for characters with the acrobatics talent</li>
                  <li>3d < ST - armor + 2 * swimming - this is a swim check based on strength, penalized by armor, and with a +2 if the character has the Swimming talent</li>
                  <li>charRace = 1 & courtlygraces & 1d > 4 - this will be true only if the character is an elf, has courtlygraces, and rolls a five or better on a d6, phew!</li>
                  <li></li>
                </ul>
                </p>

                <p>
                  You can use | or || for a logical OR, and & or && for logical AND. You can use =, ==, or === for equality. You can use parentheses. Note that if you don't use a comparison operator (=, <, >, <=, >=) an expression that works out to zero will be treated as false and any non-zero value will be treated as true. Capitalization will not matter. You can write die rolls as 3d vs ST if you like, VS translates to <=. You can use your own variables, and all the talents and attributes in the game appear automatically, so MA is MA, etc. Chartype will be 1 for heroes and 2 for wizards. Charrace is 0 for humans, 1 for elves, 2 for a dwarf, 3 if a halfling, 4 is an orc, and 5 if the character is a goblin.
                </p>

                <p>
                  The third type of node is a Foe. This is the most straightforward, even if it has the most info to enter. When the adventure leads to a Foe node combat will begin. If you want the player to be able to talk to the foe first that would be a set of Locations and Branches that might lead to compromise or could lead to actual combat, which is the Foe node.
                </p>

                <p>
                  The Foe will have a name, as all nodes do, which is how other nodes will lead to it. The player will not see this name. You will separately specify the name that will be shown in combat. You will specify all the attributes of the foe for the combat system. Range is the distance at which combat wll commence. Intro text is the text the player will see just as combat starts. Foes will also have a type, which will be one of these:
                </p>

                <ul style='list-style-type: none; '>

                  <li>creature, charges and melees, dropped/broken weapon means they take damage</li>
                  <li>melee fighter, charges and melees, drops or breaks weapons as normal</li>
                  <li>melee fighter with pole weapon</li>
                  <li>archer, shoots immediately, then switches to their melee weapon and charges</li>
                  <li>mage that casts Dazzle, then Magic Fist, has Staff</li>
                  <li>mage that casts Illusions of bears</li>
                  <li>mage that casts Sleep</li>
                  <li>mage that casts Fireball</li>
                </ul>

                <p>
                  Finally, Foes will have three destinations. Win Destination is the node the character will go to next if they win the fight. Lose Destination is the node the player will see if they lose, which is probably one of the adventures endings, since there's not much the character can do when they are out of hit points. No Foe is the node the character will go to if they reach the foe but the foe is gone, either having previously been defeated or removed by other means through the Remove Foe action.
                </p>

                <p>
                  There is also a virtual node called LastLocation. When a button or branch tries to go to this location the adventure will return to the last Location the character visited.

      </div>


      <div id ='actions' class = 'docTopic'>

      <h3>
        <a id='introActions'>Actions</a>
      </h3>
      <p>
        Arriving at certain locations means something significant has happened that effects the game state, and you can make this happen with Actions: Heal, Rest, Damage, Grant XP, Remove Foe, Reassign Variable, and Writing. These things happen automatically on arriving at the Location - they are not actions the character will choose, in fact the player will not know these things have happened unless you mention it in the location description!
      </p>
      <!-- <p style='color:red'>
        In the visual editor each Location will have a button labelled "Add an Action" which will add an action to that Location. You then choose which Action you want from the pop up menu and enter the other numbers. There will be a Delete button next to each action to remove actions. In the Text Editor you will put Actions under the @location line in the form "@damage 2d". For more details on how to implement Actions check the sections on Using the Editor or Using the Text Editor.
      </p> -->
      <p>
        A <span class="emphasized">Heal</span> action comes with a number, and the character will be healed up to that many hit points. This can be a set number, a die roll such as 1d+1, or even a variable. Obviously, a character will not be healed above their initial ST.
      </p>
      <p>
        A <span class="emphasized">Rest</span> action works the same way for Fatigue.
      </p>
      <p>
        A <span class="emphasized">Damage</span> action is similar; the character will take the specified amount of damage. If that takes the character below 0 HP then the character has died and the player will not see this location, instead they will go to the node named after the damage amount. Note that the game assumes this is physical damage such as a fall or a trap, so armor will protect the character. If this is poison or magical damage that ignores armor you can add the armor value to the amount of damage. EG, two dice of damage that ignores armor would be expressed as "2d+armor".
      </p>
      <p>
        <span class="emphasized">Grant XP</span> is straightforward, the character is simply granted that many XP. Characters spend XP between adventures, so there is no inherent way to use XP during the adventure. Since this is silent, like all actions, you should let the player know in the adventure text that they have earned XP, and if the character survives tell them how many XP they earned by displaying the variable XPEARNED in the final Locations by including '^XPEARNED' in the text.
      </p>
      <p>
        The <span class="emphasized">Remove Foe</span> Action will cause a foe to disappear from the adventure. If the player reaches the named Foe location they will be diverted to the No Foe node named in that Foe's description. This is handy when the player bribes a guard or dropped a rock on the giant spider and thus won't have to fight them, or when a conversation with a potential foe turns them nuetral or even favorable, or when a foe is killed by subterfuge instead of combat. This adds depth to the adventure and increases the chances of success for a single character.
      </p>
      <p>
        Note that actions are silent, the player won't know that they happened. It is up to you to inform them in the adventure text, or not. Of course, @Damage and @Heal may apply random amounts of damage, and you might want to mention that amount. There is a built-in variable called ^LastAction which will hold the last amount of a @Damage or @Heal action, and you can include that in your text to let the player know what happened.
      </p>
      <p>Not all characters can read. If there is writing in your adventure - on a scroll, on a wall, etc, the Location description should mention the writing, but not what it says, since the character may not have the Literacy talent. A <span class="emphasized">Writing</span> Action allows you to specify what the writing says, and this will be presented as part of the description <span class="emphasized">if</span> the character has literacy. You could do this with a Branch and two versions of the Location or a conditional paragraph, but the Writing Action provides a shortcut since this may happen often. When you want to give extra info to a character with Naturalist, Architect, etc, you will need to use a conditonal paragraph or create a Branch and two versions of the Location.
      </p>
      <p>
        The <span class="emphasized">Reassign Variable</span> action allows you to chage the value of one of the variables you set up at the start of the adventure. If the character finds some rope, wins some favor, collects some berries, consumes or spends a resource collected earlier, etc, this action makes it happen. The expression on the right side of the equal sign will be the variable's new value. This can be a numeral, die roll, variable, attribute, etc. You can read more about Varibales in their section.
      </p>
      <p>
        Sometimes you will want to interrupt the flow of play and return to it. Perhaps there is a magic item they may choose to use in one of several locations. Perhaps time has run out and the situation has changed. You can use the <span class="emphasized">Remember</span> action to store a specific location, and then when the adventure tries to go to a location called Return (whether from a button, the result of a Branch, etc) it will go to the remembered location instead.

      </p>



      </div>


      <div id ='variables' class = 'docTopic'>

        <p>
          Variables let you store a number to keep track of various things to add richness to your adventure. You can keep track of whether or not a particular item has been picked up, how much of a resource is left, how many times something has happened, whether or not a particular event has happend, or how much silver or rope or berries the character has picked up here and there. You give a variable a name and a starting value at the top of the editor. Variables can then be modified by Actions when the character arrives at a Location.
        </p>
        <p>
          The value of variables can affect the adventure in two ways. Most commonly, you will check the value of a variable in a Branch and go to one of two Locations (or Foes, etc). Some variables keep track of how much time or food or air is left, and it would be inconvenient to have a Branch every time the player makes a move to see if it's run out. These variables will have a Zero Destination named in the Variable box at the top of the editor. When this variable reaches zero or below the character will go straight to the Location, Branch, or Foe named in the Zero Destination field. This may or may not be end of the adventure. All the actions of the original location will happen, but the player will not see the description or buttons of that location, they will go directly to the Zero Destination. If you want to return, see the Remember/Return feature.
        </p>
        <p>
          Variables are listed at the top of the Editor, and they always have  starting value. That starting value doesn't have to be a number, it can be a forumla including Attributes, Talents, and die rolls.
        </p>
        <p>
          You can change a variable at any Location by using an action like ^foodLeft = foodLeft - 1 That would subtract one from the variable foodLeft. You can use die rolls in the standard TFT notation, as in ^foodLeft = foodLeft -1D.
        </p>
        <p>
           If you want to get fancy there are a few more details: + - * / ^ % all work, and you can use parentheses. If you do division you may get a decimal result, so ^numberOfWebs = numberofWebs / 2 when numberOfWebs starts at 5 will give you 2.5. If you want an integer subtract the decimal part using the % 1 trick, eg assuming torches = 5 then ^torches = torches / 2 will set torches equal to 2.5, but ^torches = torches / 2 - torches / 2 % 1 will set torches equal to 2.
            If you want to get really fancy the ternary operator will work.
        </p>
        <p>
          Perhaps there is a key that opens a particular door. At the top of the editor you would add a variable called silverkey and set it to 0. The Location where the key can be picked up would have an Action that sets silverkey to 1. If the character arrives at the door it will not be a Location but a Branch. The Branch will check if the value of silverkey is  greater than 0. If it's not they do not have the key and the Branch will lead to the location where they are faced with a door they cannot unlock. You can present them with the option to try to break it down or go back or whatever. If the value of silverkey is greather than 0 the Branch would take the player to a location where they have the option of unlocking the door.
        </p>
        <p>
          You can include the value of a variable in your adventure text or button text by putting a caret (^) in front of the variable name. So the value of a variable called FOODLEFT will be substituted into "You have ^FOODLEFT days of food left."
        </p>
        <p>
          There are many "automatic" variables that let you use the basic game elements in assigning variables and testing conditions in branches. ST, DX, adjDX, IQ, MA, armor, injury, fatigue, xpearned are the most obvious. Chartype is 1 for heroes, 2 for wizards. Charrace is 0 for humans, 1 for elves, 2 for dwarves, 3 for halflings, 4 for orc characters, and 5 if the character is a goblin. In addition, each Talent and Spell is a variable, set to 0 if the character does not have that Talent or Spell and 1 if they do.
        </p>
        <p>
          Examples:
          3d < ST - armor + 2 * swimming this is a swimming roll, three dice vs ST penalized by the weight of your armor with a +2 if you have the Swimming talent.
        </p>
        <p>
          In general you will not change these automatic variables, but this game does have "Fantasy" right in the name so you definitely can. You can change any Talent or Spell to 1 to give a character that Talent or Spell, or set it to Zero to take it away. You can increase ST or DX if the player drinks from a magical fountain or whatnot, and you can lower a chracter's stats if you really want to annoy them.
        </p>
        <p>
          The value of the last action such as @heal or @damage is stored in a variable ^lastaction that you can use in your adventure text to report what happened. This is stored until the next @heal or @damage in case you want to use it in a branch or store it in a variable.
        </p>
        <p>
          Some variables keep track of how much time or food or air is left, and it would be inconvenient to have a Branch every time the player makes a move to see if it's run out. For situations like this you can set a  Zero Destination when assigning or reassigning a variable's value. When this variable reaches zero or below the character will go straight to the Location, Branch, or Foe named in the Zero Destination field. This may or may not be end of the adventure. All the actions of the original location will happen, but the player will not see the description or buttons of that location, they will go directly to the Zero Destination. If you want to return, see the LastLocation node or Remember/Return feature. Once a Zero Destination has been triggered it will clear, the character will not be brought back to that location over and over, even if the variable in question is raised and then lowered back to zero again. You can set the Zero Destination again if you want, but if you don't it won't be there.
        </p>
        <p>
        </p>

      </div>


      <div id ='usingEditor' class = 'docTopic'>
        <h3>Topics:</h3>
   &emsp;<a href="#introNodes">Nodes</a><br>
   &emsp;<a href="#introLocations">Locations</a><br>
   &emsp;<a href="#introBranches">Branches</a><br>
   &emsp;<a href="#introFoes">Foes</a><br>
   &emsp;<a href="#introActions">Actions</a><br>
   &emsp;<a href="#introVariables">Variables</a><br>
   &emsp;<a href="#introFirstLater">First/Later Locations</a><br>
   &emsp;<a href="#introFeatures">Editor Features</a><br>
   &emsp;<a href="#introCantDo">What you can't do in the Visual Editor</a><br>


 <h3>
   <a id='introIntro'>Introduction</a>
 </h3>
 <p>
   An interesting adventure involves a lot of details and contingencies, and working with all this is challenging. The Visual Editor allows you to work with all this info in a handy way. You should read the tour below, and the sections on Nodes, Locations, Branches, and Foes. Then you can start creating. When you get the hang of it you can learn about Actions and Variables.
 </p>
 <p>
   At the top of the editor you will enter the basic info about your adventure: the Title, Creator (you!), and the maximum character attribute level the adventure is suited for. Typical TFT characters start with 32 attribute points, and this system should work well up to 36. You can read more about Test Mode under <a href="#introFeatures">Editor&nbsp;Features</a>. You also enter a description that will be visible to people before they load the adventure, up to 50 characters.
 </p>

 <P>
   After the basic info you can initialize Variables for the adventure. You can ignore variables, or read more about them in their own section.
 </P>

 <P>
   After the variables come the nodes, each in their own box. Every node has a unique name in the upper left corner, followed by the other elements necessary for that type of node. In the lower right corner of each node's box is a button to delete that node.
 </P>

 <P>
   Below the scrolling list of nodes boxes is a row of buttons that will let you add new nodes of each type. You can read more about First/Later Locations below, but in a nutshell this button quickly creates several nodes such that a location will appear one way when a character first visits it and differently when they return. There's also an Undelete button that will show you a list of deleted nodes if you want to pick one to bring back from the dead. (The graveyard of deleted nodes is not preserved between sessions.) The Create Missing Nodes button will create Locations for all the names that your buttons and branches try to visit which you have not created yet. This can be handy as you are first sketching out your adventure, but of course if some of those buttons should lead to branches instead of locations you'll want to create those first manually.
 </P>

 <P>
   Below these buttons is the Report window. This lists all the problems with your adventure at the moment - buttons that go nowhere, locations to which nothing leads, and so on. Each item will have a link with the name of the node with each problem that will scroll the editor straight to that node. If a node links to a node that does not exist yet there will be three buttons allowing you to create a Location, Branch, or Foe with that name.
 </P>

 <P>
  On the right hand side is a list of all the nodes you have created so far. You can click on any of these to scroll the editor to show you that node so you can work on it. This starts out in chronological order, that is the order that you created the nodes, but below the list are buttons to swtich this to alphabetical order if that's easier.
 </P>


 <P>
   Finally, in the lower right hand corner are buttons that will let you save the current adventure to a file, or load an adventure from a file. Saved files will likey appear in your Downloads folder. These are ordinary text files and you can edit them in another application if that is helpful. You can save them again as text and load them with these buttons or copy the work and paste it into the Text Editor.
 </P>

 <P>

 <h3>
   <a id='introNodes'>Nodes</a>
 </h3>
 <p>
   If you have played Death Test or any Choose-Your-Own-Adventure style, you know the basic unit of solitaire adventures is the numbered paragraph. If you have not played Death Test you should probably stop and do that now, you have hours of exciting fun ahead of you and you a good grasp of the numbered-paragraph system will be very useful here, even though TFT Helper Adventure Creator doesn't use numbers, or paragraphs.
 </p>
 <p>
   Instead, we have nodes. A node can be a location, a trap, a foe, a test against an attribute, a decision point in a conversation, etc. They come in three types: Locations, Branches, and Foes. A Location has text for the player and one or more buttons to take them further along. A Branch is invisible to players, the software will send the character to one of two locations according to a test you specify, such as rolling 3d vs adjDX. A Foe is just that - something the character will fight. These nodes have names used by author and the software but the player won't see these.
 </p>
 <p>
   In addition, some locations will have Actions. You can ignore actions for now, or read more about them below. These are actions for the software to perform, not the character. When arriving at a Location means that something has changed - perhaps the character has taken damage or earned some XP, you will add that to the Location as an Action. The text of the Location can let the player know this has happend or not, as the author sees fit.
 </p>

 <p>
   Finally, there are Variables. You and start working without these and add them to your toolbox when you like. Variables allow the adventure to track various things during the adventure, such as how much rope has been collected, whether or not the character has picked up a key, whether or not a certain place has been visited. These are initialized at the beginning of the adventure, modified by Actions, and checked by Branches.
 </p>

 <h3>
   <a id='introLocations'>Locations</a>
 </h3>
 <p>
   Most locations will be physical locations. They start with a description of the location, then present one or more buttons. The button labels should be short, so the description of the adventure is the place to put more information about where the buttons go. It is possible to put text between buttons. You can start a new line by including a Return in the text, and start a new paragraph with two Returns. You'll be able to see how everything looks in the Simulator.
 </p>
 <p>
   A location without any buttons is possible, this is a dead end. This may be appropriate for the end of the adventure, and the user can exit by using the Main Menu Button. A good adventure will make it clear that this is the end and remind the user to go to the main menu.
 </p>
 <p>
   Some locations should be different when the character returns to them after the first visit. A trap will already have been triggered or disabled, an item will already have been collected, etc. This is easily done with a variable that keeps track of whether or not the location has been visited and a branch to send the player to either the unvisited or visited version of the location. Since this is an important way to make adventures great there is a short cut to setting this up: the First/Later Location, explained below.
 </p>

 <h3>
   <a id='introBranches'>Branches</a>
 </h3>
 <p>
   A Branch is invisible to players as the character is sent to one of two locations depending on circumstances.  When you add a Branch you will give it a name, which other parts of the adventure will use to get here.
 </p>
 <p>
   Then comes the heart of the Branch, where you specify what gets compared to what to decide where the adventure goes next. Can the character climb out of the pit? It's a 3d roll vs adjDX. You would put 3d for the first term, <= for the middle term, and adjDX for the third term. Does the character have the Naturalist talent? You would put Naturalist for the first term, > for the second, and 0 for the third. Is the charcter wearing metal armor? You would put armor for the first term, > for the second, and 2 for the third, since armor with a value of 1 or 2 is non-ferrous.
 </p>
 <p>
   Following the condition you will specify the name of the node to vist next if the condition is true and the name of the node to visit next if the condition is false.
 </p>
 <p>
   Things you can use in the comparison terms include character attributes and talents, variables you create.
   Examples:<br>

   1d > 5 (a basic reaction roll)<br>
   4d < = adjDX (a difficult climb)<br>
   ST > 12 (can the character lift that stone?)<br>
   Naturalist > 0 (does the character have a particular talent?) <br>
   charRace (0=human, 1=elf, 2=dwarf, 3=halfling, 4=orc, 5=goblin) <br>
   armor > 2 (is the character wearing metal armor?)     <br>
 </p>

<p>
 Be sure and use adjDX instead of DX when armor would affect the outcome. Also, be sure and use <= or > and never => or =<, as the latter won't work.
</p>

<p>
 If you want to get really fancy the condition for the branch can include "and" and "or" in the form or && and ||. Be sure to test carefully with the Simulator to make sure you are writing what you think you're writing. You can use parentheses to group things.<br>
 <br>
 literacy || courtlygraces - will go to @destinationTrue if the character has <span class="emphasized">either</span> Literacy or Courtly Graces.<br><br>
 alertness  && armor < 4 - will go to @destinationTrue if the character has Alertness <span class="emphasized">and</span> they are wearing chainmail or lighter.<br><br>
 charRace = 1 && injury = 0 - will go to @destinationTrue if the character is an uninjured elf.
</p>

 <p>
   Talents like Alertness, Acrobatics, and so on should give bonuses to some rolls. This is easily written since the various Talents act like variables. So...<br>
   <br>
   3d <= adjDX + ( Acrobatics * 3 ) - a 3d roll vs adjusted DX with a bonus of 3 if you have Acrobatics<br>
   4d <= IQ + ( Alertness  * 2 ) - a 4d roll vs IQ with a bonus of 2 if you have Alertness<br>
   <br>
   The value of the Talent is one if the character has it, zero if they do not. Multiply that but the amount of the bonus and add it to the number you're trying to roll under. This works the other way around, of course...<br>
   <br>
   3d <= st - armor - a swimming roll with armor as a penalty.<br>
   <br>
   If you really want to get fancy you can google ternary operator and give an Elf a penalty to an IQ roll in the presence of an insect like this:<br>
   <br>
   3d <= iq - ( charace == 2 ? 3 : 0 )<br>
   <br>
   Of course, if you want to give characters with Naturalist a bonus in the same situation you would write:<br>
   <br>
   3d <= iq - ( charrace == 2 ? 3 : 0 ) + ( naturalist * 2 )<br>
   <br>
   ...of course, the player will never see any of this.
 </p>

 <h3>
   <a id='introFoes'>Foes</a>
 </h3>
 <p>
   When the adventure reaches a Foe there will be a fight. If you want a chance to avoid the creature or a conversation before the fight breaks out, those should be separate locations that might lead to the Foe, but once you get to the Foe the fight starts. The combat intro text is presented and initiative is rolled.
 </p>
 <p>
   The Foe has a name like other nodes, then you will enter the various attributes of the Foe. These are mostly self-explanatory except for Type. This tells the software how the Foe should behave in a fight - charging straight in, keeping distance, and so forth. Spoiler: there are only four Wizards possible, specified here.
 </p>
 <p>
   Finally you will specify the nodes to visit next if the character wins or loses, the latter being one of the adventure's endpoints. If the character returns to this Foe after having defeated it, or if the Foe is removed by some other means than a fight via the Remove Foe action, the player will be taken to the node named undr No Foe.
 </p>
 <p>
 </p>

 <h3>
   <a id='introVariables'>Variables</a>
 </h3>
 <p>
   Variables let you store a number to give you a chance to keep track of various things to add richness to your adventure. You can keep track of whether or not a particular item has been picked up, how much of a resource is left, how many times something has happened, whether or not a particular event has happend, or how much silver or rope or berries the character has picked up here and there. You give a variable a name and a starting value at the top of the editor. Variables can then be modified by Actions when the character arrives at a Location.
 </p>
 <p>
   The value of variables can affect the adventure in two ways. Most commonly, you will check the value of a variable in a Branch and go to one of two Locations (or Foes, etc).
 </p>
 <p>
   Variables are listed at the top of the Editor, and they always have  starting value. That starting value doesn't have to be a number, it can be a forumla including Attributes, Talents, and die rolls.
 </p>
 <p>
   You can change a variable at any Location by using an action like ^foodLeft = foodLeft - 1 That would subtract one from the variable foodLeft. You can use die rolls in the standard TFT notation, as in ^foodLeft = foodLeft -1D.
 </p>
 <p>
    If you want to get fancy there are a few more details: + - * / ^ % all work, but you cannot use parentheses; if you have a complex formula you will have to split it onto to successive lines. If you do division you may get a decimal result, so ^numberOfWebs = numberofWebs / 2 when numberOfWebs starts at 5 will give you 2.5. If you want an integer subtract the decimal part using the % 1 trick, eg assuming torches = 5 then ^torches = torches / 2 will set torches equal to 2.5, but ^torches = torches / 2 - torches / 2 % 1 will set torches equal to 2. An exclamation point will give you the logical opposite of something, so !Swimming is TRUE if the character does NOT have swimming. If you want to get really fancy the ternary operator will work.
 </p>
 <p>
   Perhaps there is a key that opens a particular door. At the top of the editor you would add a variable called silverkey and set it to 0. The Location where the key can be picked up would have an Action that sets silverkey to 1. If the character arrives at the door it will not be a Location but a Branch. The Branch will check if the value of silverkey is  greater than 0. If it's not they do not have the key and the Branch will lead to the location where they are faced with a door they cannot unlock. You can present them with the option to try to break it down or go back or whatever. If the value of silverkey is greather than 0 the Branch would take the player to a location where they have the option of unlocking the door.
 </p>
 <p>
   You can include the value of a variable in your adventure text or button text by putting a caret (^) in front of the variable name. So the value of a variable called FOODLEFT will be substituted into "You have ^FOODLEFT days of food left."
 </p>

 <h3>
   <a id='introFirstLater'>First/Later Locations</a>
 </h3>
 <p>
   Sometimes when a character arives at a Location that location will change: a trap will be sprung, items will be collected, a conversation will take place, etc. This means that the place will be diferent when the character returns to this point on the map. This is easily done: you create a variable called "placeVisited" and set it's value to 0. The node named "place" will be a Branch, not a location. The condition for the Branch "place" will check if the variable placeVisited is equal to zero, and if it is send the player to a Location called "placeFirst". If the value of placeVisited is not equal to zero the player will go to a Location called "placeLater". The Location placefirst will include an Action that will reassign the variable placevisited to 1 (or any other non zero number).
 </p>
 <p>
   This is not hard at all, but it's a lot of steps for something that happens pretty often, so there's a button that will do it all: Add First/Later Location. This button will ask you for the place name, then create the Variable, Branch, both Locations, and the Reassign Variable Action to make it all work. All you need to add are the descriptions of the two locations and any Actions or Buttons needed.
 </p>


 <h3>
   <a id='introFeatures'>Editor Features</a>
 </h3>
 <p>
   The Editor continually saves your work inside the browser if you have "LocalStorage" enabled in Settings, so if you close the window and come back later you should find your work as you left it. The adventure is stored in something called LocalStorage, which is not the same as "Cookies" but will be cleared at the same time. So if you are going to clear your cookies you should save your work before doing so.
 </p>
 <p>
   To save your work outside the browser go the to Text Editor tab where you will see all your nodes in pure text format. You can copy all this text and then paste it into a text document on your device to save it. Later you can paste all this back into the Text Editor to restore all your work.
 </p>
 <p>
   Test Mode will be set to 0 for the adventure you will share with others. While you are writing the adventure you can set Test Mode ON and load the adventure into TFT Helper to test it with a couple of advantages. Your character will start with 23 hit points, so they won't die too easily. That means you will survive the combats, the traps, the falls, but it's not too many that you can't test character death. Additionally, you will see two buttons on the character sheet in TFT Helper, a staff of Aesculapius and a skull. The staff of Aesculapius resets injury and fatigue to 0, and the skull sets injury to 23. The latter won't kill the character immediately, but the next time character hit points are checked the character will be considered dead.
 </p>
 <p>
   The Undelete button will show you a list of the nodes you have deleted. You can select one and restore it to the same position in your adventure. Note that this is <span class="emphasized">not</span> stored in LocalStorage so it is volatile - if you refresh your window, close the window and return later, etc, the Undelete window will be empty. This window also only stores whole nodes; if you delete a Button, Action, Variable, etc, it will not be recoverable.
 </p>
 <p>
   The Create Missing Nodes button will first look for any Remove Foe actions that have no corresponding foe and create corresponding foes, along with locations for their missing, defeated, and victorious nodes. Then it will create locations for any buttons or branches that don't exist. You still have to describe them, but this will save you some clicking.
 </p>
 <p>
   Clear All Nodes will erase your entire adventure. You will get a confirmation box. This cannot be undone. If you want to save your adventure outside the web app before erasing it you can copy the entire contents of the Text Editor and save it in a text file as above.
 </p>

 <p>
   Below the node list and the buttons is a report on any problems with the adventure: buttons that go nowhere, etc. You will need to fix these issues before proceding to the Simulator or Exportable tabs. Luckly the report will include links that will scroll straight to the nodes with the issue.
 </p>

 <h3>
   <a id='introCantDo'>What you can't do in the Visual Editor</a>
 </h3>
 <p>
There are a few things the Visual Editor won't do, and if you need to do these you will need to use the Text Editor.
</p>
 <p>
   You can't change the order of nodes. The order of the nodes doesn't matter to the software, but if the order you originally created your nodes is getting in the way of improving and revising them and you want to reorder them, you'll need to do that in the Text Editor with Cut-and-Paste. Be sure to save your work first.  Be sure to cut and paste entire nodes.
 </p>
  <p>
    You can't duplicate things - whether entire nodes, buttons, etc. If you have several locations that are largely similar it might be more efficient to write on, make copies, and then edit each copy. You will have to do that in the Text Editor.
  </p>
   <p>
     You can't change a node's type, changing a Branch to a Location. These are so different there's no obvious way to convert them, so just delete the node and create a new node of the desired type with the same name.
   </p>
    <p>
     You can't spell check or do a global search and replace. If you wanted to change "amulet" to "talisman" throughout your adventure you would need to go to the Text Editor, copy the entire adventure, paste it into an editor that will let you search and replace, do that, copy it, and paste it back into the Text Editor. Not hard, but not easy. The same goes for other advanced editing tricks.
   </p>
    <p>
 </p>
      </div>


      <div id ='usingSimulator' class = 'docTopic'>

        <p>
          Clicking on the Simulator tab takes you to the simulator, which will let you see the adventure as your players will see it on a simulated phone screen. This allows you to step through and make sure things are connected the way you intended, and nothing is left out.
        </p>

        <p>
          The center of the window will be the simulated phone screen. The text and buttons will appear exactly like they would for player running the adventure on the TFT Helper mobile app. Note that if there are problems with the adventure (buttons that go nowhere, etc) you will have to resolve those before the simulator will work.
        </p>

        <p>
          When you reach a branch the simulator will follow the appropriate branch for the character and conditions, EG if a character with the Naturalist talent should go to one version of a location where they get more information and options that a character without that talent, then that's what the simulator will show. In cases where the branch comparison invovles a die roll a dialog box will ask you which path you want to pursue so you can conveniently test each one.
        </p>

        <p>
          Similalry, when you face a foe you will see a dialog box showing the foe's combat opening description and stats, and then you can choose to follow the path where the character wins the fight or the path where the character loses the fight.
        </p>

        <p>
          In the upper right hand corner you will see buttons that allow you to restart the adventure with a typical armored fighter or a literate wizard. The third button lets you load in a custom character from the text area immediately below that button, so you can simulate the adventure with that character. The Adventure Creator will expect you to use this format:
        </p>
        <p style ='white-space: pre-wrap; font-family: "Courier New"'>
        Jon of the Isles
        human, age 23
        ST 12, DX 12, IQ 8, MA 10
        Talents: Sword, Shield,acrobatics,naturalist,literacy
        Spells: Blur
        Weapons: Broadsword (2d), Small Shield (-1 hit)
        Attacks and Damage: Punch 1d-2
        Armor: leather
        Equipment:
        Special Note:

      </p>

      <p>
        You can edit the character in that little space, if that works. The imported character will be remembered between sessions if you have localStorage turned on.
      </p>

      <p>
        Below this is a a list of all the nodes in your adventure - locations, branches, and foes. You can click on any node to go directly there. This will save time testing larger adventures, since you won't have to walk through the whole adventure to get to the part you want to test. If you click on a branch it will immediately resolve as if you had travelled there, offering you a dialog box if a die roll is involved. If you click on a location with actions those actions will happen immediately, but of course any actions that would have happened if you had stepped through each location to reached the clicked location will not have happen.
      </p>

      <p>
        In the lower right hand corner is a history of the nodes visted so far in this run through. Clicking here does nothing.
      </p>

      <p>
        In the upper right hand corner is a list of the variables in your adventure with their current values, updated as you go through the adventure. You can click on any of them to change them.
      </p>

      <p>
        Below this are the character attributes as they exist at the moment. You can click on these to change them, too.
      </p>

      <p>
        Below this are lists of the Talents and Spells, which are like variables that are set to 1 if the character has that Talent or Spell and 0 if they don't. You can click on these to change them. There are checkboxes to list only the abilities the character has, ie only the non-zero values.
      </p>

      <p>
        Testing with the simulator is an efficient way to check your work as you write your adventure, but it's not a substitute for testing your adventure on the mobile app before sharing it with other people.
      </p>

      <p>
        Clicking on other phone features may reveal other features.
      </p>


      </div>


      <div id ='exportable' class = 'docTopic'>


        <p>
          The Exportable is the block of text you will share with the world. It's been prepared for the TFT Helper mobile app to present, and it's been scrambled to prevent spoilers. The text in that textArea is the adventure that can be played on the mobile app. Copy it to the clipboard or save it to a file and share it with your friends in any way you can move text.
          <p>
          </p>
          Once you have the text on the clipboard of a mobile device you can launch TFT Helper, then select Go On An Adventure from the main menu. Select a character and then select New Adventures from the adventure menu. In the bottom part of the New Adventures scren is a text area you can paste the exportable into, then tap Import to see that adventure added to the menu of adventures above. Now you can play it for real.
        </p>
        <p>
          Someone is going to ask why we're using a bespoke format instead of JSON or XML. Those formats use a <span class="emphasized">lot</span> of punctuation and extra tags in those formats and they are hard for humans to parse. But if you want to use JSON you can copy the JSON in the textArea below and take it to another editor to edit. When you're done you can bring the result back here, paste it into the JSON window, and click Import JSON to bring it back into the Adventure Creator.
        </p>
        <p>
          If you want to edit your adventure in XML there are many JSON-XML convertors on the web.
        </p>
        <p>
          Note that these adventures are <span class="emphasized">scrambled</span> and not <span class="emphasized">encrypted</span>. I don't need the headaches that come along with a mobile app associated with "encryption".
        </p>
      </div>


      <div id ='usingTextEditor' class = 'docTopic'>
        <!-- <span id = "nittyButton" style="position: fixed; right: 20px; border: solid thin; background-color: lightblue; padding: 7px;" onclick="toggleNitty()">
        Show Nitty Gritty Details
      </span> -->

      <div style="overflow-y: scroll; overflow-x: hidden; height: 90vh;">

      <!-- <div style="display: flex;">

        <div style="width: 5%; text-align: right; padding: 1%;">
          <a href="#basics">Basics</a> <br>

          <a href="#extras">Extras</a><br>

          <a href="#variables">Variables</a>
        </div>

        <div style = " padding: 1%;">
          The Essentials: Locations, Foes, and Branches<br>

          Handy tools that will make things easier for you<br>

          Add depth to your world by tracking things
        </div>

      </div> -->

      <!-- <a href="#basics">Basics</a> The Essentials: Locations, Foes, and Branches<br><br>

      <a href="#extras">Extras</a> Handy tools that will make things easier for you<br><br>

      <a href="#variables">Variables</a> Variables! Adding depth to the world<br><br> -->

      <!-- <h3>Basics</h3><a id="basics"></a> -->

    <p>
      The Text Editor lets you manipulate your adventure as straight up, plain vanilla text. Some people will find this more straightforward, while other will find it arcane, which is why the Adventure Creator gives you a choice. Text is handy if you want to email an excerpt to a collaborator, rearrange the sequence of the nodes you have created, do a gobal search-and-replace on some name, and other tasks. Every change you make in the adventure creator is within a few seconds evaluated and copied so that the Visual Editor and Text Editor as well as the Simulator all show the same thing, and the error report at the bottom of the screen is always up to date.
    </p>
    <p>
      Under the Text Editor tab you will see a big text area where you can edit your adventure. Line numbers are managed by the Adventure Creator to help you locate the problems mentioned in the report, which appears below the text area. On the right side you will see buttons that will let you clear the editor, save the contents, or load contents from a text file. Below this two buttons will allow you to see either a reference to the text formats described below for adventure elements or a list of existing locations you can click on to scroll the editor to that location.
    </p>
    <p>
      At the top you will have five lines...
    </p>
    <p class='code'>
      @title Temple of the Toad God
      @creator Jane the GM
      @description Not much of a temple, really.
      @maxattributes 32
      @testmode

    </p>

    <p>
      "@title" precedes the title, of course, and the same with the creator name and short description. @maxattributes specifies the maximum character attributes for this adventure. 32 is the normal starting attribute total, but you can design adventures that allow higher totals. Be aware that only the most basic Talents and Spells are implemented, and higher level characters generally use those. @testmode is activates test mode for the adventure in the mobile app; see using the Simulator for detils.
    </p>

    <p>
      After this header you can initialize variables. They must be initialized before the first location. The caret ^ is used to introduce them. They must have a starting value. If you want an optional Zero Destintion for a variable it will be the last word on the line. The initial value can be a formula.
    </p>

    <p class='code'>
      ^ropeCollected = 0
      ^daysOfFoodLeft = 10 starving
      ^carryingCapacity = ST - armor
    </p>

    <p>
      After the variables you will enter your locations, nodes, and branches. A location will start with @location followed by the nodes name. After this comes the text describing the situation. Buttons follow: @button is followed by the name of the destination, the name of the node this button will take you to. The next line is the text that will appear in the button, don't make it too long. If it makes things clearer you can intermix text and buttons. Here is a simple location:
    </p>

<div style='display:flex'>
    <p class='code' style='width:50%'>
@location caveEntrance
The cave entrance is at least twelve feet high. Cool, damp air exudes from it. To the south is the path that leads back to the farmstead.

@button firstChamber
Enter the Cave

@button pathToCave
Follow The Path

    </p>
    <img src="art/sampleLocation.png" style="margin-left: auto; width: 30%;" >
</div>

    <p>
      If you want to include a Conditional paragraph or button, simply precede it with a line that starts with @if followed by the expression that will determine if that paragraph or button appears. Here's an example:
    </p>

    <p class='code'>
      @location alongthepath
      Along the path there are some bushes.
      @if Naturalist
      You notice some healing herbs among them.
      @button pond
      Continue to the Pond
      @if naturalist
      @button pickherbs
      Pause to Pick Herbs
    </p>

    <p>
      In this case a typical character would only see the bushes and the Continue button. A character with naturalist would also learn more about the bushes and have the button appear that will allow them to pick some.
    </p>

    <p>
      If there are any Actions include them under the @location line. For example here is a location resulting from failing a climbing roll. When the character arrives here they will take two dice of damage (armor protecting) and if they die from that they will go straight to a node called 'deathbyfall'. If they survive they will get 5 XP but lose whatever rope they had. Note that the result of the damage will be substituted in the text for ^lastaction.
    </p>

    <p class='code'>
      @location fallen
      @damage 2d deathbyfall
      @xp 5
      ^rope = 0
      Your grip fails and you fall, taking ^lastaction points of damage. You do feel somewhat wiser for the experience, but you have lost your rope.
    </p>

    <p>
      Branches are easier, they always have four lines. @branch is followed by the node name, and the next line will be the condition. After this @destinationTrue is followed by the name of the node to go to if the condition evaluates to true, and @destinationFalse is followed by the name of the node to go to if the expression works out to be false.
    </p>

    <p class='code'>
      @branch climbDown
      3d<adjDX
      @destinationTrue climbdownsuccess
      @destinationFalse fallen
    </p>

    <p>
      In this simple example three dice are rolled against adjusted DX, and if the character succeeds they will go to the node called climbdownsuccess. If the roll fails they will end up at fallen. The section on Using The Editor goes into detail about the conditional expressions. They can be very simple, as here, but if you want to have involved situations they support a lot of complexity.
    </p>

    <p>
      If you want to choose between more than two outcomes you need to link branches. Here's an example where a character might have no rope, 1-29 feet of rope, or enough rope for a 30 foot climb, and will end up at one of three different destinations as a result.
    </p>

    <p class='code'>
      @branch inside
      ^ropeCarried>0
      @destinationTrue insideSomeRope
      @destinationFalse insideNoRope

      @branch insideSomeRope
      ^ropeCarried > 29
      @destinationTrue insideEnoughRope
      @destinationFalse insidenotEnoughRope
    </p>

    <p>
      Foes have many lines to fill out, but they are always the same.
    </p>

    <p class='code'>
      @foe foeName
      Combat intro text
      @type 0
      Scruffy Swordsman
      Human, age
      ST 12, DX 14, IQ 8, MA 10
      Talents: Sword
      Spells:
      Weapons: Broadsword (2d), Main-Gauche (1d-1)
      Attacks and Damage: Punch 1d-3
      Armor:
      Equipment:
      Special Note:
      @range
      @xp
      @winDestination searchSwordsmansBody
      @loseDestination diedAtGate
      @noFoe emptyGateway
    </p>


    <p>
Following @foe is the node's name, of course. Then comes the text that will be displayed at the start of combat. @type tells the software how this foe should behave in combat, and the types are listed below. Then the name that will be used in combat occurs, followed by the other stats in standard TFT format. @range specifies how far apart the foe will be at the start of combat. @xp is how many xp will be aerned if the foe is defeated. @winDestination is the node the player will see next if they win the combat. @loseDestination is where they will end up if they lose (probably the end of the adventure, though you could provide healing at that location and say they were only captured). @nofoe is the node the character will be taken to if the foe is not present, having been defeated earlier or removed by a @removeFoe action.
    </p>

    <p>
      Here are the foe types:<br>
  <br>
      -1 = creature, charges and melees, dropped/broken weapon means they take damage<br>
      0 = melee fighter, charges and melees, drops or breaks weapons as normal<br>
      1 = melee fighter with pole weapon<br>
      2 = archer, shoots immediately, then switches to their melee weapon and charges<br>
      3 = mage that casts Dazzle, then Magic Fist, has Staff<br>
      4 = mage that casts Illusions of bears<br>
      5 = mage that casts Sleep<br>
      6 = mage that casts Fireball<br>

    </p>

    <p>
    </p>



            <P class="howto">
                Don't use the at-sign '@' or caret '^' in the text of your adventure,  in location or branch names, or in button text. < and > can be use in branches as part of the conditional expression (eg "IQ > 10") but can't appear in location descriptions. You can use all the other special characters on the keyboard, but you cannot use spaces in the names of Locations, Branches, Foes, or in the names of variables.
            </P>

            <P class="nitty">
            Captialization will never be important to this software. "@Title", "@title", "@TITLE", and "@tItLe" are equivelent, and the location names "caveEntrance", "CaveEntrance", and "caveentrance" will all be the same place. Fair warning, nearly all modern programming languages care very much about capitalization, so avoid building bad habits. The names of Locations and variables must be a continuous string of numbers and letters - no spaces, no special characters.
            </P>
            <P class="nitty">
            Unicode is not supported, if you are wondering. It will probably work in description text and buttons, though it is likely to be very distracting. "Probably" means "that's why we test things." It will certainly cause unpredictable behavior in Location or Variable names.
            </P>

          </div>
        </div>

      <div id ='graphic' class = 'docTopic'>
        <p>
        A sketched out map is a great way to start working out your ideas for your adventure. Unfortunately, such an intuitive representation fails when some locations correspond to several nodes in the adventure, which happens when a place appears differently and offers the player different choices based on their abilities, how they got there, what they have done so far, etc. On top of that, the journey between map locaitons may involve decisions and tests, which may lead the character somewhere other than where they meant to go when they left the last location.
      </p>
      <p>
        This representation, then, is not a map but a display of your nodes and how they connect to each other. The green rectangles are locations, the ivory rectangles are the names of the buttons that lead from one location to another. The purple diamonds are branches. The orange circles are foes. These are the same colors as the boxes in the editor.
      </p>
      <p>
        While an entire adventure would be hard to follow if you lose track of the buttons and conditions leading through one part of your adventure you can look for that section in this image and hopefully figure out what's wrong.
      </p>
      <p>
        When you are studying the example adventures the graphic can also be a good way to get a handle on how they fit together.
      </p>
      </div>


      <div id ='settings' class = 'docTopic'>
        Cookies and settings. There are not a lot, only whether you want the Adventure Creator to automatically back up your work inside the browser while you are working.
      </div>


        </div>



        </div>


        <div id="page2" class="page" style="display: none;">

          This text should never show up but it cannot be deleted!


        </div>

<style>

  .TEgrid {
    height: 90vh;
    display: grid;
    grid-template-columns: 80% auto;
		grid-template-rows: 85% auto;
    grid-template-areas:
      "input reference"
      "report report";
  }

  .TEinput {
    grid-area: input;
  }

  .TEreference {
    grid-area: reference;
  }

  .TEreport {
    grid-area: report;
    /* padding: 2vh 0 0 0; */
  }

</style>

        <div id="page3" class="page" style="display: none;">

          <span class="watermark">Beta</span>

          <div class='TEgrid'>

            <div class='TEinput'>

              <br>
              <textarea id='lineNumbers' cols='5' readonly style="height: 90%; padding-right: none; margin-right: none; resize: none; border-right-style: none; border-radius: 0; overflow:hidden; color: var(--lineNumberColor); text-align:right; background-color: var(--textAreaBGColor);">
              </textarea><textarea id="userInputTextArea" rows="50" cols="80" style="height: 90%; padding-left: 0; margin-left: 0; resize: none; border-left-style: none; border-radius: 0; outline: none; scroll-behavior: smooth; background-color: var(--textAreaBGColor);" oninput="queueTextUpdate();">
              </textarea>

              <br>
              <span id="problemCountDiv"></span>

            </div>

            <div class='TEreference'>


              <span style='' class="niftyButton" onclick="closeDialogBoxes();confirmOverwrite('blank')">Clear&nbsp;Editor</span>
              <br>
              <span class="niftyButton" onclick="closeDialogBoxes();saveAdventure()">Save&nbsp;Adventure&nbsp;to&nbsp;Disk</span>
              <br>
              <span class="niftyButton" style=''  onclick="closeDialogBoxes();loadAdventure()">Load&nbsp;Adventure&nbsp;from&nbsp;Disk</span>
              <br>
              <input type="file" id="fileInput" style='display: none'>
              <br>

              <span style='line-height: 1; display: inline-block;' class="niftyButton" onclick="showLoc()">Show Locations</span>
              <span style='line-height: 1; display: inline-block;' class="niftyButton" onclick="showRef()">Show Reference</span>
              <br>
              <br>

              <div id="locDiv" style="height: 63%; overflow: scroll; border: solid thin; padding: 1vh">
                blue
              </div>

              <div id="refDiv" style="display: none; height: 74%; overflow: scroll; border: solid thin; padding: 1vh">
              <span style="font-size: large; font-weight: bold;">Reference</span>
              <br>
              <span style="font-size: small;">You can copy and paste these as templates, or just refer to them.</span>




              <div style="font-family: arial; font-size:small; border: solid thin; padding: 5px;">
<span class="niftyButton" style="float: right" onClick="event.stopPropagation();showSpecials();">Special Effects</span>                @location locationName<br>
                Location description paragraphs&nbsp; &nbsp; &nbsp; <br><br>
                @button button1Destination<br>
                Button 1 Text<br>
                @button button2Destination<br>
                Button 2 Text<br>
              </div>

              <br>
                <div style="font-family: arial; font-size:small; border: solid thin; padding: 5px;">
<span class="niftyButton" style="float: right" onClick="event.stopPropagation();showComparisons()">Branch Comparisons</span>
                @branch branchName<br>
                3d <= IQ <br>
                <!-- @bonus amount talent/spell<br> -->
                @destinationTrue destinationIfTrue<br>
                @destinationFalse destinationIfFalise<br>
              </div>
              <br>
                <div style="font-family: arial; font-size:small; border: solid thin; padding: 5px;">
                @damage amount destination<br>
                @heal amount<br>
                @rest amount<br>
                @removeFoe foeName<br>
                @writing<br>
                @testMode<br>
              </div>
              <br>
                <div style="font-family: arial; font-size:small; border: solid thin; padding: 5px;">
<span class="niftyButton" style="float: right" onClick="event.stopPropagation();showTypes()">Foe Types</span>
                @foe foeName<br>
                Combat intro text<br>
                @type 0 &nbsp; &nbsp; &nbsp; <br>
                Scruffy Swordsman<br>
                Human, age<br>
                ST 12, DX 14, IQ 8, MA 10<br>
                Talents: Sword<br>
                Spells:<br>
                Weapons: Broadsword (2d), Main-Gauche (1d-1)<br>
                Attacks and Damage: Punch 1d-3<br>
                Armor:<br>
                Equipment:<br>
                Special Note:<br>
                @range<br>
                @xp<br>
                @winDestination searchSwordsmansBody<br>
                @loseDestination diedAtGate<br>
                @noFoe emptyGateway<br>
            </div>

          </div>  <!--  end of reference div -->

        </div>  <!-- end of TE Reference -->

            <div class='TEreport'>

              Report:
              <br>

              <div id="feedbackTextArea" style="height: 70%; padding: 0.5vh; border: solid thin; overflow: scroll;">

                When you start writing your adventure the feedback will go here.

              </div>

            </div><!-- end of TEreport -->


        </div> <!-- end of tE Grid -->

</div>  <!-- end of page 3 text editor div -->

        <div id="page4" class="page" style="display: none; font-family: Times New Roman, serif;">

          <span class="watermark">Beta</span>

          <div style="display: flex;">

              <div style="flex-grow: 1">

                User Variable values:

                  <div style='overflow: hidden; width: 100%; height: 15vh; border: solid thin; border-color: var(--bgColor)'>
                  <div id="userVariablesDiv" style="padding: 0.6vw; overflow: scroll; height: 100%">
                  </div>
                </div>

                Remembered Location: <span id='currentRememberedLocation'></span>

                <br>
                <br>

                Attribute values:

                <div style='overflow: hidden; width: 100%; height: 15vh; border: solid thin; border-color: var(--bgColor)'>
                <div id="attributeVariablesDiv" style="padding: 0.6vw; overflow: scroll; height: 100%">
                </div>
              </div>
                <br>
                Talent values:

                <input type="checkbox" id="showOnlyKnownTalents" style='float: right' onchange='updateTalentVars()'>
                <label for="showOnlyKnownTalents" style='float: right'> Show Only Known</label>

                <div style='overflow: hidden; width: 100%; height: 15vh; border: solid thin; border-color: var(--bgColor)'>
                <div id="talentVariablesDiv" style="padding: 0.6vw; overflow: scroll; height: 100%">
                </div>
              </div>

                <br>
                Spell values:
                <input type="checkbox" id="showOnlyKnownSpells" style='float: right' onchange='updateSpellVars()'>
                <label for="showOnlyKnownTalents" style='float: right'> Show Only Known</label>
                <div style='overflow: hidden; width: 100%; height: 15vh; border: solid thin; border-color: var(--bgColor)'>
                <div id="spellVariablesDiv" style="padding: 0.6vw; overflow: scroll; height: 100%">
                </div>
              </div>




              </div>

              <div style="flex-grow: 4; ">

                <div style = "margin: auto; position: relative; background-color: black; padding: 2vh; border-radius: 30px; width: 400px; height: 720px;">


                  <div style="position: absolute; top: 18px; left:180px; margin: auto; background-color: #444444; border-radius: 5px; height: 7px; font-size:5px; width: 80px;">

                  </div>
<div style = "background-color: white; position: relative; top: 20px; margin-bottom: 0; margin-top: 0; margin-left: auto; margin-right:auto; width: 350px; height: 620px; ">
                  <!-- <div  style="position: relative; top:20px; text-align: center;  background-color: white; color: black; margin: auto; width: 350px; height: 20px; font-family: Arial, sans-serif; font-size: smaller; "> -->
                    <div  style="text-align: center;  background-color: white; color: black; margin-bottom: 0; margin-top: 0; margin-left: auto; margin-right:auto; width: 350px; height: 20px; font-family: Arial, sans-serif; font-size: smaller; ">

                    <img src="art/signalBars.png" height="20px" style="float: left;" onclick="event.stopPropagation();showEgg('signalDiv')">
                    <span style="float: left; position: relative; top: 3px;" onclick="event.stopPropagation();gimmeFnord();showEgg('illuminatiDiv')">illuminati</span>
                    <img src="art/WiFi.png" height="20px" style="float: left;" onclick="event.stopPropagation();showEgg('signalDiv')">
                    <span id="currentTimeSpan" style=" position: relative; top: 3px; left: -15px">99:99</span>
                    <img src="art/battery.png" height="20px" style="float: right;">
                    <span style="float: right; position: relative; top: 3px;">110%</span>
                    <img src="art/locator.png" height="20px" style="float: right;" onclick="event.stopPropagation();showEgg('locatorDiv')">
                  </div>

                  <div  style=" text-align: center; background-color: white;  margin: auto; width: 350px; margin-bottom: 0; ">
                    <!-- <img src="art/charSheet.png" width="350px"> -->
                    <img src="art/menuIconWide.png" width="350px">
                    <!-- <img src="art/menuBlank.png" width="350px"> -->
                  <!-- </div>
<div style="background-color: pink; color: black; margin: auto; ; width: 350px; height: 150px"> -->
  <!-- <div id="littleCharSheet" style="background-color: lightgrey; margin: auto; width: 80%; height: 90%; border: solid thin;"> -->
  <!-- <div id="littleCharSheet" style="height 114px; position: static; padding-left: 8px; padding-right: 8px; padding-top: 10px; padding-bottom: 10px; background-color: lightgrey; margin-bottom: 15px; margin-top: 15px; margin-left: auto; margin-right:auto; width: 80%;  border: solid thin;"> -->

    <!-- <div id="littleCharSheet" style=" position: static; padding-left: 8px; padding-right: 8px; padding-top: 10px; padding-bottom: 10px; color: black; background-color: lightgrey; margin-bottom: 10px; margin-top: 12px; margin-left: auto; margin-right:auto; width: 80%;  border: solid thin;"> -->

      <div id="littleCharSheet" style=" position: static; margin-left: auto; margin-right:auto; color: black; padding-left: 1vw; padding-right: 1vw; background-color: lightgrey;  width: 80%;  border: solid thin; margin-bottom: 15px;">


      <span style="font-size: larger; font-weight: bold" id='simCharName'>Test Char</span>
      <br>
      <span style="" id='simCharRaceType'>OOOOOOO</span>
<br>

<span id="charL1L" style="float: left" onclick="changeVar('ST')">ST: 12</span>
<span id="charL1R" style="float: right" onclick="changeVar('INJURY')">Injury: 0</span>
<br>

<span id="charL2L" style="float: left" onclick="changeVar('DX')">ST: 12</span>
<span id="charL2R" style="float: right" onclick="changeVar('FATIGUE')">Injury: 0</span>
<br>

<span id="charL3La" style="float: left" onclick="changeVar('IQ')">ST: 12</span>
&nbsp;&nbsp;
<span id="charL3Lb" style="float: left" onclick="changeVar('MA')">OOOO</span>

<span id="charL3R" style="float: right">Injury: 0</span>
<br>

<span id="charL4L" style="float: left" onclick="changeVar('XPEARNED')">ST: 12</span>

<br>

<span id="charArmorDisp" style="float: left; font-size: small;"></span>

<br>

<span id="charL5" style="float: left; font-size: small;"></span>

&nbsp;
</div>
<!-- end of little char sheet -->

</div>

                  <!-- <div id="simulatedScreen" style="position: relative; top:16px;  background-color: white; color: black; margin: auto; ; width: 350px; height: 410px"> -->
                    <div id="simulatedScreen" style="padding-left: 15px; padding-right: 15px; background-color: white; color: black; margin-bottom: 25px; margin-top: 15px; margin-left: auto; margin-right:auto; height: 377px; overflow-x: none; overflow-y: scroll;">
test


                  </div>

                  <div id="funWindow" class="overlay-div">

                  </div>


</div>
<!-- This next bit is the home button -->
                  <div onclick='homeClick()' style="position: absolute; top: 680px; left:190px;  border: solid thin; border-color: #444444; background-color: black; border-radius: 25px; height: 50px;  width: 50px;">&nbsp;
                  </div>


                </div>



              </div>

              <div style="flex-grow: 1; ">

                <span class="niftyButton"  onclick = "setHero(0);reviewUserInput();" >Restart with Fighter</span><br><br>
                <span class="niftyButton"  onclick = "setHero(1);reviewUserInput();" >Restart with Wizard</span><br><br>
                <span class="niftyButton"  onclick = "setHero(2);reviewUserInput();" >Restart with Other Hero</span><br><br>

                  <textarea id="otherCharTextArea" rows="4" cols="32" >
Jon of the Isles
Human, age
ST 12, DX 12, IQ 8, MA 10
Talents: Sword, Shield
Spells:
Weapons: Broadsword (2d), Small Shield (-1 hit)
Attacks and Damage: Punch 1d-2
Armor:
Equipment:
Special Note:
                  </textarea>

                  <br>
                  <br>

                Click to Jump to a Location:

                <div style='overflow: hidden; width: 100%; height: 25vh; border: solid thin; border-color: var(--bgColor)'>
                <div id="locationsDiv" style="padding: 0.6vw; overflow: scroll; height: 100%">
                </div>
              </div>


                <br>

                History of Locations Visited<br>
                <div style='overflow: hidden; width: 100%; height: 25vh; border: solid thin; border-color: var(--bgColor)'>
                <div id="historyDiv" style="padding: 0.6vw; overflow: scroll; height: 100%">
                </div>
              </div>



              </div>


          </div>

          <div id="varChangeDiv"   style="display: none; position: fixed; top: 30%; left: 30%; right: 30%; border: double thick; background-color: lightgrey; color:black; padding: 3.5vh; overflow: auto; z-index: 999;">
            <div id="varChangeInfoDiv">

              <p>
                  This should not show up.
              </p>
            </div>
<br>
Current value: <span id="currentValueSpan"></span><br>

<br>
New value:
<textarea id="newVarValue" rows="1" cols="10" style="vertical-align: middle;"></textarea>
<br>
<br>
<br>

          <div style="text-align: center;">
            <span class="niftyButton" id="successButton" onclick = "checkAndStoreVar()" >Apply</span>
            <span class="niftyButton" id="failureButton" onclick = "document.getElementById('varChangeDiv').style.display='none';" >Cancel</span>

          </div>
          </div>


          <div id="dryrunDiv"   style="display: none; position: fixed; top: 30%; left: 30%; right: 30%; border: solid thick; background-color: lightgrey; color:black; padding: 3.5vh; overflow: auto; z-index: 999;">
            <div id="dryrunInfoDiv">

              <p>
                  This should not show up.
              </p>
            </div>
  <div style="text-align: center;">
            <span class="niftyButton" id="successButton" onclick = "successGo();" >Success</span>
            <span class="niftyButton" id="failureButton" onclick = "failureGo();" >Fail</span>

          </div>
        </div>

        <div id="combatDiv"   style="display: none; position: fixed; top: 30%; left: 30%; right: 30%; border: solid thick; background-color: lightgrey; color:darkred; padding: 3.5vh; overflow: auto; z-index: 999;">
          <div id="combatInfoDiv">

            <p>
                This should not show up.
            </p>
          </div>
<div style="text-align: center;">
          <span class="niftyButton" id="successButton" onclick = "successGo();" >Win</span>
          <span class="niftyButton" id="failureButton" onclick = "failureGo();" >Lose</span>

        </div>
      </div>



        </div>


        <div id="page5" class="page" style="display: none; ">

          <span class="watermark">Beta</span>

          <p>
            Here is your adventure, prepared to paste into TFT Helper and scrambled to prevent spoilers. Be sure and copy the <span class="emphasized">entire</span> contents of this text field, including all the "<><>..." lines.
          </p>


          <div id="testModeWarningDiv" style="display: none;">

            <span style="font: large; color: red;">
              Test Mode active
            </span>

            <span class="nodeEditorButton" onclick="event.stopPropagation();showTestModeAdvice()">What?</span><br><br>

          </div>

          <textarea id="exportableTextArea" readonly rows=15 style="margin: auto; width: 60%; background-color: var(--textAreaBGColor);">Nothing is ready to export yet!</textarea>
          <br>
          <br>

          <span class='niftyButton' onclick='exportableToClipboard()'>Copy to Clipboard</span>

          <span class='niftyButton' onclick='exportableToFile()'>Save to File</span>
          <br>
          <br>
          <br>

          <div id='jsonSection'>

                    For advanced users: If you're a JSON fan, here are the current adventure's nodes in JSON format. It is not scrambled, so don't share it thoughtlessly. The title and other metadata are included. You can manipulate it as you see fit, and then reimport it if this workflow is better for you. Of course, the Adventure Creator's error checking won't work until you reimport it, so reimport often to prevent creating a lot of work for yourself.
                    <br>
                    <br>

                    <textarea id="JSONTextArea" rows=15 style="margin: auto; width: 60%; background-color: var(--textAreaBGColor); ">Nothing is ready to export yet!</textarea>

                    <br>
                    <br>

                    <span class='niftyButton' onclick='jsonToClipboard()'>Copy JSON to Clipboard</span>

                    <span class="niftyButton" onclick="overwrite='JSON';overwriteFunction()">Import JSON</span>

                    <br>
                    <br>

                   Reimporting will overwrite the current adventure!
                   <br>
                   <br>

                  Fans of XML can use any of the online JSON to XML convertors, edit the XML, and then bring the result back via the same route. If XML is you preferred way to work, there you go!
              </div>
        </div>

        <div id="page6" class="page" style="display: none;">



          <span class="watermark">
            Beta
          </span>

          <p>
          These sample adventures are short, but demonstrate how to set up particular situations. Loading any of these will overwrite the adventure currently in progress.
          </p>
<BR><BR>

          <div style="overflow-y: scroll; overflow-x: hidden; height: 90vh; display: flex; flex-wrap: wrap;">


<style>
  .exColumn {
      border: solid thin;
      border-color: grey;
      box-sizing: border-box;
  }
  .exColumnLeft {
    width: 20%;
    padding-top: 2vh;
    text-align: right;
  }
  .exColumnRight {
    padding:3vw;
    width: 75%;
  }
</style>


<br>
<br>



<div class="exColumn exColumnLeft">
  <div class="niftyButton" onclick="confirmOverwrite('towerGoblin')">The Goblin in the Tower</div>
</div>
<div class="exColumn exColumnRight">
A basic, one scene adventure with a couple of paths to the end, each with their own risks, a climbing roll,and a goblin with a bad attitude. Features used: branches, @damage & ^lastaction, a complicated climb check with a conditional paragraph.
</div>



<div class="exColumn exColumnLeft"><div class="niftyButton" onclick="confirmOverwrite('toadGodTemple')">
  Load Temple of the Toad God</div>
</div>
<div class="exColumn exColumnRight">
  Explore an old hut, collect rope to get to the basement safely or just risk the climb. Demonstrates collecting items, making a descent with some, none, or enough rope, and removing a foe by taking a particular action before meeting it. Uses @damage, @removefoe, @grantxp.
</div>

<!-- <div class="exColumn exColumnLeft">
  <div class="niftyButton" onclick="confirmOverwrite('ordinaryDungeon')">Load Fairly Ordinary Dungeon</div>
</div>
<div class="exColumn exColumnRight">A collection of classic dungeon cliches.
</div> -->

<div class="exColumn exColumnLeft">
  <div class="niftyButton" onclick="confirmOverwrite('wilfurd')">Load Invisible Amulet</div>
</div>
<div class="exColumn exColumnRight">Wilfurd the Wise has hidden an invisible amulet in an old cavern. Luckily the cavern is rumored to hold a fountain that gives the ability to see the invisble. Unfortunately, the ability lasts only a few moments. And the fountain is behind a secret door. This shows off a predetermined random location for the treasure, as well as conditional buttons and paragraphs. Best of all, it demonstrates a temporary ability with a countdown, and shows different versions of rooms depending on this fading ability using both conditional paragraphs and buttons as well as branches.
</div>

<div class="exColumn exColumnLeft">
  <div class="niftyButton" onclick="confirmOverwrite('tomb')">Tomb of Neferkaure</div>
</div>
<div class="exColumn exColumnRight">
  This small dungeon shows off conditional buttons and branches with three increasingly involved ways of handling searching for secrets in the successive rooms. In the first room you can search all you want. In the second room you can only search once, then the buttons disappear. In the third room you can search twice. There are four treasures to find, and the win location reports based on which you found. Uses many variables to track what the character has done, several conditional buttons and paragraphs, and the LASTLOCATION destination.
</div>

<!-- <div class="exColumn exColumnLeft">
  <div class="niftyButton" onclick="confirmOverwrite('memory')">Memory Test</div>
</div>
<div class="exColumn exColumnRight">
  Testing @remember/return.
</div> -->


<div class="exColumn exColumnLeft" >
  <div class="niftyButton" onclick="confirmOverwrite('newtPool')">
  Sacred Pool of the Newt God
</div>
</div>
<div class="exColumn exColumnRight">

  The adherents of the newt god have stolen a valuable necklace and tossed it into their sacred pool as an offering to their god. Valuable means there's a reward. Your friends have a plan to distract the acolytes while <span class="emphasized">you</span> sneak around, dive into the pool, grab the necklace, and escape to share the loot with them. Great adventure for non-swimmers in heavy armor. This one-scene adventure showcases <span class="emphasized">two</span> timers, since you have a limited number of dives and each dive allows a limited time of searching. It uses @remember & return so a complicated swim check sequence can be used in several places. If it helps, the way surfacecheck works like this: first part, swimmers in light armor succeed; second part, swimmers in heavier armor need to roll 2d against ST minus armor; third part non-swimmers in light armor need roll 3d against ST - 2 times armor; fourth part non-swimmers in heavy armor need to roll 4d against ST - 2 times armor. This adventure is going to be tough for characters without swimming, and, spoiler, there are no foes. But there are useful techniques here for producing game efects.

</div>



<!--
          <P class="howto">
            The character is about to exit the forest and cross an open patch of ground to the entrance of the abandoned watch tower. The character doesn't know it yet, but there's a goblin at a window on the second story with a horse bow. If the character makes a 3d vs IQ roll they will see the goblin in time to make this a Dodge move. Alertness gives a bonus of 2. And of course, if the character ever returns to this spot they will definitely know about the goblin. How do we write this?
          </P>


          <P class="howto">
            First, at the top of the adventure you'll set a variable to keep track of whether the character knows about the goblin. This is a simple flag: 0 means ignorance, 1 means the character knows.
          </P>

          <P class="example">
              ^knowsAboutGoblinArcher=0
          </P>

          <P class="howto">
            Next, we have the location in the trees:
          </P>

          <P class="example">
              @location edgeOfForest<br>
              You are at the edge of the forest. You can see a clearing to the north where the old watchtower stands. <br>
              @button deepInTheForest<br>
              Go Deeper Into The Forest<br>
              @button checkIfGoblinKnown<br>
              Enter the clearing<br>
              <br>
            </P>

            <P class="howto">
              The first branch checks to see if the character already knows about the goblin. The next makes the roll if they don't know about the goblin.
            </P>

            <P class="example">

              @branch checkIfGoblinKnown<br>
              ^knowsAboutGoblinArcher > 0<br>
              @destinationTrue dodgeThroughClearing<br>
              @destinationFalse rollToNoticeGoblin<br>
              <br>

              @branch rollToNoticeGoblin<br>
              3d <= IQ<br>
              @destinationTrue spottedGoblin<br>
              @destinationFalse goblinSneakAttack<br>
              <br>

              @location spottedGoblin<br>
              As you enter the clearing you notice a goblin with a bow just inside a window on the second story. You immediately start zig-zagging to spoil his aim.<br>
              @button dodgeThroughClearing<br>
              Continue<br>
              <br>

              @branch goblinSneakAttack<br>
              3d <= 10  [the goblin's adjDX for the shot is 10]<br>
              @destinationTrue hitByGoblinSneakArrow<br>
              @damage 1d
              @destinationFalse missedByGoblinSneakArrow<br>
              <br>

              @branch dodgeThroughClearing<br>
              4d <= 10  [the goblin's adjDX for the shot is 10]<br>
              @destinationTrue hitByGoblinArrow<br>
              @damage 1d<br>
              @destinationFalse missedByGoblinArrow<br>
              <br>

              @location hitByGoblinSneakArrow<br>
              @button keepDoorway<br>
              Continue<br>
              <br>

              @location missedByGoblinSneakArrow<br>
              @button keepDoorway<br>
              Continue<br>
              <br>

              @location hitByGoblinArrow<br>
              @button keepDoorway<br>
              Continue<br>
              <br>

              @location missedByGoblinArrow<br>
              @button keepDoorway<br>
              Continue<br>
              <br>


              @location keepDoorway<br>
              Etc
              @button checkIfGoblinKnown
              Head Out of the keep
              @button lowerStairs
              Head Up The Stairs

              <P class="howto">
                The redundancy of these last four paragraphs allows you to make sure the text flows smoothly through all variation
              </P>



          </P>
-->

        </div>

        </div>

        <div id="page10" class="page" style="display: none; overflow: hidden">

          <span class="watermark">Beta</span>

          <div style='overflow-y: scroll; overflow-x: hidden; height: 85vh;'>

            <div>
              Here is a non-interactive, graphic view of the adventure as it stands. This beta feature was too good to leave out, but it has not been carefully reviewed. Hopefully it's helpful when things get tangled. Foes are orange circles, branches are purple diamonds, and locations are green rectangles. The paths between nodes are labelled, though perhaps not in the most convenient place. This chart was generated with a javascript tool called Mermaid. See notes below for more info.
            </div>

          <div id="flowchartDiv">
          <pre class = 'mermaid' id='mermaidFlowChart'>
          graph TD
          A[Client] --> B[Load Balancer]
          B --> C[Server1]
          B --> D[Server2]
          </pre>
          </div>

          <div>
            This flowchart was produced by the Mermaid library, an extraordinary little bundle. It has many uses and you can play with it at mermaid.live
          </div>
<br>

        <div style='display: none;'>
          Mermaid Code (for troubleshooting):
          <div id='flowChartCode' style='border:solid thin;'></div>
          </div>
        </div>

        </div>


        <div id="page7" class="page" style="display: none; height: 100%;">

          <span class="watermark">Beta</span>

          <div style="overflow-y: auto; height: 88vh">

          <br><br>

          <div style='display: flex'>
            <div style='flex: 0 1 auto; padding: 1vw'>
              <!-- <input type="checkbox" id="darkMode" style='' onchange='switchDarkMode()'>
              <label for="darkMode" style=''>Dark Mode</label> -->
              <form>
                <input type="radio" id="light" name="colorMode" value="light" onchange="switchColorMode()">
                <label for="light">Light</label><br>

                <input type="radio" id="melee" name="colorMode" value="melee" onchange="switchColorMode()">
                <label for="melee">Melee</label><br>

                <input type="radio" id="wizard" name="colorMode" value="wizard" onchange="switchColorMode()">
                <label for="wizard">Wizard</label><br>


                <input type="radio" id="elvish" name="colorMode" value="elvish" onchange="switchColorMode()">
                <label for="elvish">Elvish</label><br>

                <input type="radio" id="blue" name="colorMode" value="blue" onchange="switchColorMode()">
                <label for="blue">Navy</label><br>

                <input type="radio" id="dark" name="colorMode" value="dark" onchange="switchColorMode()">
                <label for="dark">Dark</label>
              </form>
              <br>
            </div>
            <div style='flex:1; padding 3vw;'>
              Color scheme for the Adventure Creator.
            </div>
          </div>


          <hr>
          <br><br>
          <input type="checkbox" id="showWarnings" style='' onchange='changeShowWarnings()'>
          <label for="showWarnings" style=''>Show Warnings: normally the report section of the Visual Editor or Text Editor only show problems, that is things which actually prevent the adventure from working and which must be fixed. If you check Show Warnings you will also see reminders of things that might be problems, but might not and which won't prevent you from using the Simulator or creating an exportable.</label>

          <br><br>
          <hr>
          <br><br>
          <input type="checkbox" id="showJSON" style='' onchange='changeShowJSON()'>
          <label for="showJSON" style=''>Show JSON: some folks will want to use their favorite JSON editor or other tool to edit their adventure. When this box is checked the Exportable tab will show your adventure as a JSON string. You can copy and paste this to take your adventure to some other tool, and then bring it back to the same place to reimport it.</label>

          <br><br>
          <hr>
          <br><br>

          The dialog box lied. If you accidentally overwrote your adventure despite the warning you may be able to recover it. This button will restore you adventure the way it was at the last point you overwrote it with a Clear Nodes button, by loading a file from disk, or by loading an example adventure. You will not get a warning. This is only possibly when localStorage is enabled.

          <br><br>

          <span class="niftyButton" onclick="restoreLastOverwrite();">Back In Time</span>

          <br><br>
          <hr>
          <br><br>


          <span style='font-weight: bold'>
            Cookies
          </span>
          <br>

          <P>
            The TFT Helper Adventure Creator does not use cookies. It does use a feature of HTML 5 called localStorage to retain the adventure you are working on between sessions. The difference between Cookies and localStorage is that a web server leaves cookies on your computer and then requests your browser to send the cookie back to the server later. This allows the server to keep track of who you are and what you have been up to, giving a better user experience at the cost of some degree of privacy. In contrast, as you use TFT Helper your browser will store your work on your computer and it will not be sent anywhere by the web app. Unless and until you purposefully copy the Exportable and share it with the world, no one else has access to it. Thus there is no privacy issue associated with the TFT Helper Adventure Creator's use of localStorage.

          </P>
          <P>
            Unfortunately, much of the legislation in various places around the world does not distinguish between cookies and localStorage. It's impossible for the small developer to keep track of laws and regulations in various jurisdictions, so we just have to avoid any possible trouble. Thus if you disable localStorage your work on your adventure will not be saved between sessions; you will need to save your adventure to disk (always a good idea) or copy the text of your project and paste it somewhere it will be saved.
          </P>

          <p id='cookieStatus'>
            localStorage is  currently enabled.
          </p>

          <br>


          <p style='line-height: 1vh'>

            <span class='adventureButton' style='padding: 0.9vh' onclick='cookies(1)'>
              Use localStorage for my convenience!
            </span>
            <span class='adventureButton' style='padding: 0.9vh' onclick='cookies(0)'>
              Disable localStorage
            </span>

          </p>

          </div> <!-- end of page7 scroller -->
      </div> <!-- end of page7 -->

        <style>

        div {
          border-radius:0.6vw;

        }

          #editorBasicInfoDiv {
            border: solid thin;
            /* margin: 0.5vh; */
            margin: 1vh;
            padding: 0.5vh;
            box-shadow: rgba(0, 0, 0, 0.5) 0.2vh 0.4vh 1vh;
          }

          #editorVariableBox {
            border: solid thin;
            margin: 1vh;
            padding: 0.5vh;
            background-color: lightblue;
            box-shadow: rgba(0, 0, 0, 0.5) 0.2vh 0.4vh 1vh;
          }

          .locationNode {
            border: solid thin;
            margin: 1vh;
            padding: 0.5vh;
            background-color: #cec;
            box-shadow: rgba(0, 0, 0, 0.5) 0.2vh 0.4vh 1vh;
          }

          .branchNode {
            border: solid thin;
            /* background-color: darkseagreen; */
            margin: 1vh;
            padding: 0.5vh;

            background-color: #e5e5f7;
            opacity: 0.8;
            background-image:  linear-gradient(135deg, #dbddff 25%, transparent 25%), linear-gradient(225deg, #dbddff 25%, transparent 25%), linear-gradient(45deg, #dbddff 25%, transparent 25%), linear-gradient(315deg, #dbddff 25%, #e5e5f7 25%);
            background-position:  10px 0, 10px 0, 0 0, 0 0;
            background-size: 10px 10px;
            background-repeat: repeat;
            box-shadow: rgba(0, 0, 0, 0.5) 0.2vh 0.4vh 1vh;
          }

          .foeNode {
            border: solid thin;
            /* background-color: lightsalmon; */
            margin: 1vh;
            padding: 0.5vh;

            background-color: #fdeddc;
            opacity: 0.8;
            background-image:  linear-gradient(135deg, #fed7bc 25%, transparent 25%), linear-gradient(225deg, #fed7bc 25%, transparent 25%), linear-gradient(45deg, #fed7bc 25%, transparent 25%), linear-gradient(315deg, #fed7bc 25%, #fdeddc 25%);
            background-position:  10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-repeat: repeat;
            box-shadow: rgba(0, 0, 0, 0.5) 0.2vh 0.4vh 1vh;
           }



        </style>

        <div id="page9" class="page" style="display: none;">

          This is "Page 9" - you should never be able to see this.

        </div>

        <style>
          .visBox {
              <!-- border: solid thin ; -->
              box-sizing: border-box;
          }

          .visLeft {
            width: 80%;
            padding: 1vh;
          }

          .visRight {
            padding:1vw;
            width: 15%;
          }

          .visTop {
            height:73%;
          }

          .visBottom {
            height:25%;
          }

        </style>

        <div id="page8" class="page" style="display: none; height: 90vh; overflow: hidden">
          <div style="overflow-y: hidden; overflow-x: hidden; width: 100%; height: 100%; display: flex; flex-wrap: wrap;">

            <datalist id="destinationList">
            </datalist>


            <div class='visBox visLeft visTop'>  <!--  top left box -->



                                      <span id='editorTitleSpan' style='font-size: large; font-weight: bold;'>
                                        title
                                      </span>
                                      &nbsp;by&nbsp;
                                      <span id='editorCreatorSpan'>
                                        creator
                                      </span>

                              <div id='nodeContainerDiv' style='color: black; height: 97%; scroll-behavior: smooth; border: solid thin; overflow-y: scroll; overflow-x: hidden; background-color: lightgrey; line-height: 1.6; float: left' onclick='hideDestinationSuggestionBox()' onkeydown="tabHideSuggestions(event)">


                                        <div id='editorBasicInfoDiv' style='padding: 0.5vh; background-color: white; line-height: 1.5'>
                                          <span style='vertical-align: middle;'>Title: &nbsp;</span>
                                          <textarea id='editorTitle' rows="1" cols="30" style='vertical-align: middle;'>
                                            title
                                          </textArea>
                                          </span>
                                          <br>
                                          <span style='vertical-align: middle;'>Creator: &nbsp;</span>
                                          <textarea id='editorCreator' rows="1" cols="30" style='vertical-align: middle;'>
                                            creator
                                          </textArea>
                                          <br>
                                          <div style='height: 0.6em'>
                                          </div>
                                          <span style='vertical-align: middle;'>Max Attributes: &nbsp;</span>
                                          <textarea id='editorMaxAttr' rows="1" cols="3" style='vertical-align: middle;'>
                                            max attributes
                                          </textArea>
                                          <br>

                                          <div style='height: 0.6em'>
                                          </div>

                                          <span style='vertical-align: middle; '>Test Mode: &nbsp;</span>
                                          <!-- <textarea id='editorTestMode' rows="1" cols="3" style='vertical-align: middle;'>
                                            testMode
                                          </textArea> -->

                            <select onchange="" id='testModeSelector'><option value="0" >Off</option><option value="1"selected="">On</option></select>

                                          <span class="nodeEditorButton" onclick="event.stopPropagation();showTestModeAdvice()">What?</span>

                                          <div style='height: 0.6em'>
                                          </div>

                                          <span style='vertical-align: middle;'>Description: &nbsp;</span>
                                          <textarea id='editorDescription' rows="1" cols="55" style='vertical-align: middle;'>
                                            description
                                          </textArea>
                                        </div>

                                        <div id='editorVariableBox' >
                                          variables
                                        </div>

                                        <div id='nodeContainer'>
                                          <div class='locationNode'>
                                            location
                                          </div>

                                          <div class='branchNode'>
                                            branch
                                          </div>

                                          <div class='foeNode'>
                                            foe
                                          </div>
                                        </div>


                                      </div>
                                      <!--   end of nodeContainerDiv -->


                                      <div id='nodeNameSuggestions' style='position: absolute; right: 20%; width:15%; color: blue; background-color: lightgrey; z-index:99; border: solid thin black; padding:1vw; display: none;'>
                                        hi!
                                      </div>



            </div>     <!-- end of top left box -->


            <div class='visBox visRight visTop'> <!--  top right box -->

                &nbsp;&nbsp; Node Shortcuts
                <div style='overflow: hidden; border: solid thin; height: 93%;'>
                  <div id='editorNodeListDiv' style='padding: 0.5vh; height: 100%; overflow-y: scroll; overflow-x: hidden;'>

                  </div>
                </div>
                <br>
                <span class='minorButton' onclick='nodeShortcutsNormal()'>Chrono</span>
                &nbsp;
                <span class='minorButton' onclick='nodeShortcutsAlpha()'>Alpha</span>

            </div> <!-- end of top right box -->


            <div class='visBox visLeft visBottom' style = 'padding-top: 0;'>   <!--  bottom left box -->

                <div style='padding: 0vh 1.5vh 1.5vh 1.5vh; line-height: 2.5'>
                  <span class='niftyButton' onclick="closeDialogBoxes();visAddLocation()">
                  Add&nbsp;Location
                  </span>
                  &nbsp;
                  <span class='niftyButton' onclick="closeDialogBoxes();visAddFirstLaterLocation()">
                    Add&nbsp;First/Later&nbsp;Location
                  </span>
                  &nbsp;
                  <span class='niftyButton' onclick="closeDialogBoxes();visAddVariable()">
                    Add&nbsp;Variable
                  </span>
                  &nbsp;
                  <span class='niftyButton' onclick="closeDialogBoxes();visAddBranch()">
                    Add&nbsp;Branch
                  </span>
                  &nbsp;
                  <span class='niftyButton' onclick="showVisAddFoeDialog();">
                    Add&nbsp;Foe
                  </span>
                  &nbsp;
                  <span class='niftyButton' onclick="closeDialogBoxes();visUndelete()">
                    Undelete
                  </span>
                    &nbsp;
                  <span class='niftyButton' onclick="closeDialogBoxes();visCreateMissingNodes()">
                    Create&nbsp;Missing&nbsp;Nodes
                  </span>
                </div>

                <div style='font-size: large; font-weight: bold;'>
                  Report
                </div>

                <!-- <div style='overflow: scroll; border: solid thin; height: 60%; width:98%'> -->

                <div style='overflow: hidden; border: solid thin;  height: 60%; width:98%'>

                  <div id='editorReport' style='padding: 0.5vh; border: solid thin; height: 100%; overflow: scroll;'>
                    sample
                  </div>
                </div>


            </div>   <!-- end of  bottom left box -->


            <div class='visBox visRight visBottom'><!--  bottom right box -->

              <div style='float:right'>
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; File Operations

                <br>
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="niftyButton" onclick="closeDialogBoxes();saveAdventure()">Save</span>

                <br>
                <br>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="niftyButton" onclick="closeDialogBoxes();confirmOverwrite('file')">Load</span>
                <br>
                <br>
                <span class='niftyButton' onclick="closeDialogBoxes();confirmOverwrite('blank')">
                  Clear&nbsp;All&nbsp;Nodes
                </span>

              </div>


            </div>  <!--  bottom right box -->


          </div>

    </div>
        </div>

        <div id="helpDiv" class="hideMe"  style="display: none; position: fixed; top: 20%;  left: 20%; right: 20%; border: solid thick; background-color: BlanchedAlmond; color:SaddleBrown; padding: 3.5vh; overflow: auto; z-index: 999;">

            <p>
                Thanks for trying out Exciting Web App. Have fun!
            </p>
        </div>

        <div id="overwriteDiv" class="hideMe"  style="display: none; position: fixed; top: 20%;  left: 20%; right: 20%; border: solid thick; background-color: BlanchedAlmond; color:SaddleBrown; padding: 3.5vh; overflow: auto; z-index: 999;">

            <p>
                What you're about to do will overwrite the contents of the field in this browswer window with your text in it, and Undo will not fix it. Are you sure you want to proceed?
            </p>

<span class="niftyButton" onclick = "overwriteFunction()" >Yes, Overwrite</span>
<span class="niftyButton" onclick="document.getElementById('overwriteDiv').style.display='none'">No, Wait, Cancel, Stop</span>

        </div>

        <div id="saveAdviceDiv" class="hideMe"  style="display: none; position: fixed; top: 20%; left: 20%; right: 20%; border: solid thick; background-color: BlanchedAlmond; color:SaddleBrown; padding: 3.5vh; overflow: auto; z-index: 999;">

          <p>
              You should periodically save the text you are  working on to a file on your computer or somewhere in the cloud.
          </p>
          <p>
              For your convenince the TFT Helper Adventure Creator will try to save your work in your browser whenever you press the button with that name, whenever you switch tabs, and when you leave the page. Different browswers handle this differently, however, and the storage used is the kind the browser may clear if space is tight. Therefore you should save your work to your Downloads folder with the button, or copy your text and paste it somewhere else convenient as you like.
          </p>


        </div>

        <div id="testModeAdviceDiv" class="hideMe"  style="display: none; position: fixed; top: 20%; left: 20%; right: 20%; border: solid thick; background-color: BlanchedAlmond; color:SaddleBrown; padding: 3.5vh; overflow: auto; z-index: 999;">

          <p>
              When you set Test Mode On in the Editor or add the line "@testmode" in the Text Editor, the exportable created tells the TFT Helper mobile app that you are testing. This means your character will start with 23 hit points, and buttons will appear while playing the adventure that will let you heal and decrease hit points. While very useful for testing, you want to be sure and remove this line before you share this adventure with anyone but collaborators.
          </p>


        </div>

        <div id="specialsHelpDiv" class="hideMe"  style="display: none; position: fixed; top: 20%; left: 20%; right: 20%; border: solid thick; background-color: BlanchedAlmond; color:SaddleBrown; padding: 3.5vh; overflow: auto; z-index: 999;">

          A location or button can also trigger a special effect. Just put the appropriate line underneath the location or button, and that action will occur on arriving at that location or when that button is pressed. Effects are:<br>
          <br>
          @damage 1d diedFromFall (@damage is followed by a value, either a fixed number or a die roll; this is the damage the character will take from whatever just happened. After this is a location to go to if that damage kills the character.)<br>
          <br>
          @removefoe (remove a foe, whether they were scared off, killed by subterfuge, washed away in a stream, persuaded to go somewhere else, etc.)<br>
          <br>
          @heal (increases character hit points, not above initial ST)
          <br>
          @rest (decreases character fatigue)
          <br>
          @xp (grants XP points)
          <br>


          </div>

          <div id="comparisonsHelpDiv" class="hideMe"  style="display: none; position: fixed; top: 20%;  left: 20%; right: 20%; border: solid thick; background-color: BlanchedAlmond; color:SaddleBrown; padding: 3.5vh; overflow: auto; z-index: 999;">

            <p>
                A @branch can compare:<br>
                an integer, eg 12, 100<br>
                a character attribute: ST, DX, IQ, adjDX, MA, Armor<br>
                a modified attribute, eg DX-2
                a character Talent (they don't have it = 0, if they do = 1)<br>
                character Race or Type, eg "Wizard > 1"<br>
                a die roll, eg 1d, 2d+2
                <br>
                Comparisons can be:<br>
                vs (equivelent to <=)<br>
                <=<br>
                ><br>
                >=<br>
                = (you can also use == or === if you have those good habits)<br>
                <br>
                Bonuses can also be applied for talents. The bonus value given will be added to the second value in the comparison. The bonus can be negative. Examples:<br>
            </p>


          </div>


          <div id="typesHelpDiv" class="hideMe"  style="display: none; position: fixed; top: 20%; left: 20%; right: 20%; border: solid thick; background-color: BlanchedAlmond; color:SaddleBrown; padding: 3.5vh; overflow: auto; z-index: 999;">

            Here are the foe types:<br>
        <br>
            -1 = creature, charges and melees, dropped/broken weapon means damage<br>
            0 = melee fighter, charges and melees, drops or breaks weapons as normal<br>
            1 = melee fighter with pole weapon<br>
            2 = archer, shoots immediately, then switches to their melee weapon and charges<br>
            3 = mage that casts Dazzle, then Magic Fist, has Staff<br>
            4 = mage that casts Illusions of bears<br>
            5 = mage that casts Sleep<br>
            6 = mage that casts Fireball<br>


            </div>

            <div id="signalDiv" class = "hideMe blinking" style="display: none;position: fixed; top: 20%; left: 30%;  background-color: black; color: lime; padding: 3.5vh;  z-index: 999;">

              You can't stop the signal.

            </div>

            <div id="locatorDiv" class = "hideMe" style="display: none;position: fixed; top: 20%; left: 30%;  background-color: black; color: white; padding: 3.5vh;  z-index: 999;">

              The Illuminati thanks you for carrying your tracking device everywhere - and for paying for it.

            </div>

            <div id="illuminatiDiv" class = "hideMe" style="display: none;position: fixed; top: 20%; left: 30%;  background-color: black; color: orange; font-size: large; font-family:  arial; padding: 3.5vh;  z-index: 999;">
            </div>



        <div id="basicTemplate" style="display: none;">
@title Not Much of an Adventure
@creator Jane the GM
@description Two safe, unoccupied rooms
@maxattributes 32

@location startLocation
You're in a small room, there is one door.

@button endLocation
Go Through the Door

@location endLocation
You're in a slightly larger room.

@button startLocation
Go Back To The First Room

</div>

<div id="ordinaryDungeon" style="display: none;">

@title Sample Dungeon!
@creator The Masked Game Master
@maxattributes 32
@description A collection of ttrpg tropes!

^thisvariablehasareallyreallylongnamebutthatshouldbeokay = 99
^secretdoorroomVisited = 0
^fountainroomVisited = 0
^firstroomVisited = 0
^silvercollected = 10

@location startlocation
The entrance to the dungeon is exactly where the map said it should be, for once. It's a stone doorway in the cliff face.

@button firstroomfirst
Head East into the Dungeon!

@button thisisareallyreallylonglocationnamethatexceedsanyreasonablelimit
Go To Location


@location firstroomfirst
^silvercollected = 10
^thisvariablehasareallyreallylongnamebutthatshouldbeokay = 330
This is a standard ten-by-ten room, with ten silver pieces laying on the floor! Buying that map has paid for itself already.

To the west you can see daylight, the dungeon entrance. Passageways lead north, east, and south as well.

^THISVARIABLEHASAREALLYREALLYLONGNAMEBUTTHATSHOULDBEOKAY

@button fountainroomfirst
Head North

@button goblin
Head East

@button traproom
Head South

@button survived
Head West


@location firstroomlater
This is the ten-by-ten room right inside the entrance.

To the west you can see daylight, the dungeon entrance. Passageways lead north, east, and south as well.


@branch firstroom
firstroomVisited > 0
@destinationTrue firstroomlater
@destinationFalse firstroomfirst

@location death
You have died.

That's too bad because you found ^SILVERCOLLECTED silver pieces and earned ^xpearned XPs.

Maybe next time.


@foe goblin
As you enter the passageway you sense motion and freeze, luckily your eyes adjust quickly to the low light and you see the goblin before it strikes...
@type -1
goblin
ST 6, DX 11, IQ 5, MA 10
Armor: 0
Weapons: primary (1d), secondary ()
@range 2
@xp 20
@winDestination goblindefeated
@loseDestination death
@noFoe goblinmissing

@location goblinmissing
This large, long room looks like a great hall, complete with a gallery up on the north wall where presumably musicians once played during the feasts. In the middle of the room the quite substantial chandelier lays on the floor


@location goblindefeated
^silvercollected = silverCollected + 20
@xp 0
You have defeated the goblin!

There are twenty silver pieces in his purse.


@location survived
You made it out. You found ^SILVERCOLLECTED silver pieces and earned ^xpearned XPs. Not too bad.


@branch traproom
3d < adjdx
@destinationTrue setofftrap
@destinationFalse traproomlater

@location fountainroomfirst
This plain room has passageways to the south and east.

In the middle of the room is an elaborate fountain. On a pedestal in the middle of a pool of clear water is an elegant castle. Water is flowing out of all the doors, windows, embrasures, murder holes, crenellations, and arrow slits. It makes you wonder what's going on inside that castle.

@button drink
Drink from the Fountain

@button secretdoorroomfirst
Go East

@button firstroomlater
Go South


@location fountainroomlater
description for later vists to fountainroom


@branch fountainroom
fountainroomVisited > 0
@destinationTrue fountainroomlater
@destinationFalse fountainroomfirst

@location secretdoorroomfirst
description for the first visit to secretdoorroom


@location secretdoorroomlater
description for later vists to secretdoorroom


@branch secretdoorroom
secretdoorroomVisited > 0
@destinationTrue secretdoorroomlater
@destinationFalse secretdoorroomfirst

@location thisisareallyreallylonglocationnamethatexceedsanyreasonablelimit
more text


@location setofftrap
This location has not been described yet. It can be reached from the nodes: traproom


@location traproomlater
This location has not been described yet. It can be reached from the nodes: traproom


@location drink
This location has not been described yet. It can be reached from the nodes: fountainroomfirst





</div>

<textArea id="toadGodTemple" style="display: none;">
@title Temple of the Toad God
@creator Jane the GM
@description Not much of a temple, really.
@maxattributes 32

^pathRope    = 20
^pondRope = 10
^ropeCarried = 0
^liftedHatch = 0
^treasure = 0
^fallHurt = 0

@location startLoc
According to rumor, the hermit who lived in this hut worshipped some kind of toad god. But no one has seen him in weeks. It might be worth looking around.

@button origin
Head Out There

@branch origin
^treasure > 0
@destinationTrue win
@destinationFalse originLoc

@location Win
You survived and found something valuable, congratulations!

@location originLoc

From the road you can see the hut in the distance to the right. To the left a path leads to a pond near the trees.

@button doorway
Head to the Doorway

@button pathBranch
Follow the Path

@branch pathBranch
^pathRope > 0
@destinationTrue getPathRope
@destinationFalse emptyPath

@location getPathRope
^ropeCarried   = ropeCarried + pathRope
^pathRope = 0
Along the path you find a length of rope, maybe 20'. Never know when that might come in handy.

@button pondApproach
Head to the Pond

@button origin
Back Toward Road

@location emptyPath
This is the spot where you found the rope. Nothing here now.

@button pondApproach
Head to the Pond

@button origin
Back Toward Road

@branch pondApproach
^naturalist > 0
@destinationTrue throwRocks
@destinationFalse toadBite

@location throwRocks
You recognize this as a possible habitat of venomous toads. You decide to throw  a few rocks ahead of you as you go to scare off any ambushers.

@button pond
Proceed to Pond

@button emptypath
Back to the Path

@location died
You seem to have died.

@location toadBite
@damage 3 died

A venomous toad leaps from the underbrush and bites you for three points of damage.

@button pond
Proceed to Pond

@button emptyPath
Back to the Path

@branch pond
^pondrope>0
@destinationTrue pondFirst

@destinationFalse pondLater

@location pondFirst
^ropeCarried = ropeCarried + pondRope
^pondRope = 0
There is a small, still patch of stagnant water. It smells and there are unpleasant insects in it, next to it, and above it. There is also 10' of rope, which you grab, just in case. You can't wait to leave.

@button backOfHut
Head Around the Back of the Hut

@button emptyPath
Back along the path

@location pondLater
There is a small, still patch of stagnant water. It smells and there are unpleasant insects in it, next to it, and above it.

@button backOfHut
Head Around the Back of the Hut

@button emptyPath
Back along the path

@branch backOfHut
^liftedHatch = 0
@destinationTrue backOfHutFirst
@destinationFalse backOfHutLater

@location backOfHutFIRST
Behind the hut there is a woodpile and some trash... and what looks like a trapdoor on the ground...

@button pondLater
Head Back to the Pond

@button doorway
Head Around to the Front

@button liftHatch
Lift the Trapdoor

@location backOfHutLater
Behind the hut there is a woodpile, some trash, and an open trapdoor.

@button pondLater
Head Back to the Pond

@button doorway
Head Around to the Front

@location liftHatch
^liftedHatch = 1
@xp 10
@removeFoe giantRat

You lift the hatch to reveal a dark tunnel a couple feet across, leading steeply down under the hut. As you stare into the darkness a hideous rat-like creature appears! It's too big to be a normal rat, and it's either hairless or someone shaved it. Either way, it's been tattooed with arcane symbols. Before you can get a good look it darts off into the trees.

@button pondLater
Head Back to the Pond

@button doorway
Head Around to the Front


@location doorway

What passes for a door hangs open over the entrance. Sunlight comes in a million gaps in the walls and roof. You can see there's a large hole in the center of the floor.

@button inside
Head inside

@button origin
Back To The Road

@branch inside
^ropeCarried>0
@destinationTrue insideSomeRope
@destinationFalse insideNoRope

@branch insideSomeRope
^ropeCarried > 29
@destinationTrue insideEnoughRope
@destinationFalse insidenotEnoughRope

@location insideNoRope
The hole in the floor is six feet across, thirty feet deep, and you have no rope. It's a rough hewn pit, you might be able to climb down...

@button doorway
Back to the Doorway

@button climbDown
Climb Down

@branch climbDown
3d<DX
@destinationTrue climbdownsuccess
@destinationFalse fallen

@location fallen
^fallHurt = 2d
@damage fallHurt died
You fall and take ^fallHurt damage.

@button bottomNoRope
Continue

@location insidenotenoughrope
The hole in the floor is six feet across and about forty feet deep. You have enough rope to lower yourself most of the way down, but you'll have to drop the last bit.

@button doorway
Back to the Doorway

@button partropedown
Rope Down and Drop

@location insideEnoughrope
The hole in the floor is six feet across and about forty feet deep. You have enough rope to lower yourself down.

@button doorway
Back to the Doorway

@button bottomRope
Rope Down

@location bottomRope

In the dim light you see a small chamber with broken barrels and empty sacks. There is a single passage way leading out.

@button insideEnoughRope
Climb Back Up

@button giantRat
Head Into the Passageway

@foe giantRat
As you enter the passageway you sense motion and freeze, luckily your eyes adjust quickly to the low light and you see the giant rat before he strikes...
@type -1
Giant Rat
Giant Rat, age unknown
ST 6, DX 11, IQ 5, MA 10
Talents:
Spells:
Weapons: Bite (1d)
Attacks and Damage:
Armor:0
Equipment:
Special Note:
@range 2
@xp20
@winDestination emptyPassage
@loseDestination died
@noFoe emptyPassage

@location emptyPassage
You are in an underground passageway lit by a small tunnel leading up. One way is the room with the tunnel up and a little light. The other way leads to a larger, darker chamber.

@button bottomBranch
Back to the Tunnel

@button temple
Into the Larger Chamber

@location temple
^treasure = 1
As your eyes adjust to the faint light you see it's coming from lichen on the walls that form wall-sized images of toads. In the center of the room is an altar of mud, with a silver toad sitting on top. There is nothing else in the room other than whittled sticks  and small animal bones. But a silver toad has to be worth something, right?

@button emptyPassage
Back to the Passage

@location climbdownsuccess

You get to the bottom safely.

@button bottomNoRope
Continue

@location bottomNoRope

In the dim light you see a small chamber with broken barrels and empty sacks. There is a single passage way leading out. You can't reach your rope, so it will be difficult to climb back up...

@button attemptClimbUp
Climb Back Up

@button giantRat
Head Into the Passageway


@branch attemptClimbUp
3d<dx
@destinationTrue successfulClimbUp
@destinationFalse fallen

@location successfulClimbUp
You make it to the top safely.

@button inside
Continue

@location partRopeDown
You go down as far as you can by rope, but then drop the last ten feet.



@button bottomNoRope
Continue

@branch bottomBranch
^ropeCarried > 29
@destinationTrue bottomRope
@destinationFalse bottomNoRope




</textarea>

<div style='display: none;' id='tomb'>

  @title The Ancient Tomb of Neferkaure
  @creator Neferkaure Himself
  @maxattributes 32
  @description It's already been searched, but...

  ^search2treasure = 0
  ^search2door = 0
  ^search3door = 0
  ^found3trap = 0
  ^founddoor3 = 0
  ^canopicjar = 0
  ^shabti = 0
  ^amulet = 0
  ^mask = 0

  @location startlocation
  Someone found and searched the Tomb of Neferkaure, but as much as they bragged about it they didn't find much treasure. You decide to take a look, maybe they overlooked something.

  Luckily, thinking they had looted it they didn't see any reason not to let slip the location.

  Soon you are standing in front of the uncovered door the tomb.

  @button firstroom
  Go Through the Door

  @branch endoftheline
  shabti+canopicjar+amulet+mask > 0
  @destinationTrue: win
  @destinationFalse: lose

  @location lose
  You thought those other adventurers had overlooked some treasure, and that you could find what they did not. But after shuffling around in the dark you found nothing. So you step back into the sunlight with some humility, and isn't that the greatest treasure of all?

  No, it's not. You did not come all the way up here looking for humility. You came up here looking for loot. And you did not find it.

  @location win
  Your dilligence paid off!

  @if shabti
  The shabti will be worth 40 or 50 sp to a collector.
  @if canopicjar
  You don't want to think about what might be in the canopic jar, but some alchemist is likely to pay quite a bit.
  @if amulet
  The amulet is very likely magical. You might want to keep that underwraps until you can find a wizard you trust to cast Analyze Magic on it.
  @if mask
  The golden funeral mask is very valuable and undoubtedly magical. You'll need help to sell this, or figure out how to use it yourself.

  Good work!

  @location emptysearch
  You search hard but find nothing but dust, sandstone crumbs, and bits of pottery.

  @button lastlocation
  Continue

  @location firstroom
  As your eyes adjust to the dark you see a long, low antechamber. The sandstone walls to either side are covered with murals that have faded into illegibility. The door at the far end has been smashed through.

  @button endoftheline
  Return to the Land of the Living

  @if shabti=0
  @button room1treasure
  Search Hard for Treasure

  @button emptysearch
  Search for Secret Doors

  @button secondroom
  Head Deeper into the Tomb

  @location secondroom
  Your eyes adjust to an even darker space, revealing the 20x20' vestibule. There are many niches that presumably once held statues, and in between these there are bas-reliefs worn to indistinguishability by the centuries.

  @if search2door = 0
  @button search2door
  Search for Secret Door

  @if search2treasure = 0
  @button search2treasure
  Search for Treasure

  @button firstroom
  Back to the Antechamber

  @button thirdroom
  Head Deeper into the Tomb

  @location thirdroom
  This third room appears to have been an offering chapel. Everything has been looted but the stone altar and some crumbled rocks in the corner.

  @button secondroom
  Back to Vestibule

  @button fourthroom
  Head Deeper into the Tomb

  @if search3door < 2 && founddoor3 = 0
  @button search3door
  Search for Secret Doors

  @if founddoor3 = 1
  @button secretdoor
  Go Through the Secret Door

  @if found3trap = 0
  @button search3treasure
  Search for Treasure

  @location fourthroom
  This is the darkest room. It has obviously been searched thoroughly by the precious adventurers. You spend some time looking among the rubbish, but find nothing. No doors, either.

  @button thirdroom
  Back to Offering Chapel

  @location search2door
  ^search2door = 1
  You search hard, but find nothing

  @button secondroom
  Continue

  @branch search3door
  3d < = iq + (alertness * 3)
  @destinationTrue: founddoor3
  @destinationFalse: lostdoor3

  @location founddoor3
  ^founddoor3 = 1
  You detect the tiniest air currents around some stones in one wall. There is a secret door here, and the undisturbed dust tells you the previous explorers did not find it. Or chose not to open it...

  @button thirdroom
  Continue

  @branch lostdoor3
  search3door < 1
  @destinationTrue: failedfirstsearch
  @destinationFalse: failedsecondsearch

  @location failedfirstsearch
  ^search3door = search3door + 1
  You could not find a secret door, but you could try again.

  @button thirdroom
  Continue

  @location failedsecondsearch
  ^search3door = search3door +1
  You have exhausted all possibilities, you cannot find a secret door in this room.

  @button thirdroom
  Continued

  @branch room1treasure
  3d < iq
  @destinationTrue: foundshabti
  @destinationFalse: room1foundnothing

  @location foundshabti
  ^shabti = 1
  You found a shabti, a carved and painted wooden funeral figurine. Some collector will be be happy to purchase this!

  @button firstroom
  Continue

  @location room1foundnothing
  You find nothing but dust, bits of ancient cloth and leather, broken pottery fragments, and more dust.

  @button firstroom
  Continue

  @branch search2treasure
  3d < iq
  @destinationTrue: foundcanopicjar
  @destinationFalse: found2nothing

  @location found2nothing
  ^search2treasure = 1
  You search and search but find nothing but bits of wood and broken dishes.

  @button secondroom
  Continue

  @location foundcanopicjar
  ^canopicjar = 1
  ^search2treasure = 1
  You find a canopic jar, a shaped and carefully painted ceramic vessel which, if legends are true, contains some internal organs of the interred. You wisely decide not to open it. Maybe an alchemist will buy it. Maybe they'll even buy it and not tell you what they're going to do with it.

  @button secondroom
  Continue

  @branch search3treasure
  3d < dx
  @destinationTrue: escapedtrap
  @destinationFalse: trap

  @location trap
  @damage 2d loselocation
  ^found3trap = 00
  You realize a moment too late that one of the tile on the floor is slowly giving way under your weight... a trap!

  Rocks fall from the ceiling and you take ^LASTACTION points of damage.

  @button thirdroom
  Continue

  @location escapedtrap
  ^found3trap = 1
  You feel one of the floor tiles giving way beneath your foot and leap backward, narrowly avoiding a bunch of rocks falling from above. You choke on the dust that fills the room and become disoriented for a few minutes until it settles. You count yourself very lucky to be alive.

  @button thirdroom
  Phew!

  @location loselocation
  The last thing you remember is a stepping on a tile that moved, presumably triggering a trap.

  Rocks fell from the ceiling for ^LASTACTION points of damage, which was enough to end the adventure, to say the least.

  @foe secretdoor
  As you enter the burial chamber you sense motion and freeze. Before you stands a figure, wrapped head to foot in mouldering strips of cloth except for a golden mask over its face. It soundlessly advances on you...
  @type 0
  Wrapped Revanant
  ST 12, DX 10, IQ 5, MA 10
  Armor: 1
  Weapons: primary (1d), secondary ()
  @range 2
  @xp 20
  @winDestination secretdoordefeated
  @loseDestination secretdoorvictorious
  @noFoe sideroom

  @location secretdoorvictorious
  Whatever that thing was it was more than you could handle.

  The end.

  @location secretdoormissing
  The burial chamber is eerily empty, the wooden casket long ago having crumbled to dust in a big heap in the center of the room. The walls are covered in paintings and what may be magical symbols. Other than this there is nothing here.

  @button thirdroom
  Back To Offering Chapel

  @location secretdoordefeated
  ^mask = 1
  With your final blow the strips of cloth and whatever was inside them collapses in a disturbing heap. On top is the gold mask, clean and shiny. Fearing its magic you are reluctant to touch it, but it's too good to leave behind.

  @button sideroom
  Continue

  @location sideroom
  There is nothing in this room but dust and the remnants of whatever that wrapped thing was.

  @button thirdroom
  Back to Offering Chapel










</div>

<div style='display: none;' id='memoryDiv'>
  Memory Test
</div>


<div style='display: none;' id='newtPool'>

  @title Diving In The Sacred Pool
  @creator Pearl Seacrest
  @maxattributes 32
  @description you have mere minutes...

  ^holeknown = 0
  ^necklace = 0
  ^armoroff = 0
  ^breath = 3 -> surfacecheck
  ^dives = 3 -> sadending

  @location startlocation
  The followers of the newt god have always been sticky-fingered. This time they've robbed a popular noblewoman of a valuable necklace and made it an offering to the slimy sage by tossing it into their sacred pool. The duchess has offered a substantial reward, so and your friends followed the footprints and here you are at a wet clearing in the woods.

  You have only a few minutes while your friends are distracting the acolytes.

  @button armorswitch
  Continue

  @branch armorswitch
  armor > 0
  @destinationTrue: armorchoice
  @destinationFalse: poolside

  @location poolside
  From the west side of the pool you see an eight foot idol of the newt god facing the pool on the north side. The far side of the pool seems to have a lot of underwater plant growth.

  @button wadenear
  Wade In Here

  @button wadeidol
  Wade in near the Idol

  @button wadefar
  Wade in at the Far End

  @if holeknown
  @button divehole
  Wade to the Deep Hole

  @location sadending
  You surface to find angry acolytes, several of them with drawn bows. They order you out of the pool and send you and your friends packing. So much for the reward.

  @if armoroff
  They don't give you your armor back, either.
  @branch goodending
  armoroff > 0
  @destinationTrue: goodendinggrabarmor
  @destinationFalse: goodendingsneakoff

  @location goodendinggrabarmor
  You quietly climb out of the pool and admire the necklace in the sunlight! You grab your gear. Sneaking off to the way you came in, you wonder if the trail of water you are leaving behind will tip them off. You should be long gone in any case, spending that reward!

  @location goodendingsneakoff
  As you climb out of the water you can hear your friends still arguing with the acolytes some distance away. This gives you plenty of time to sneak off to the rendezvous point, and then on to claim the reward.

  @location armorchoice
  Swimming in armor isn't a great idea. Time is short, but it might be worth the delay to take it off before diving into the pool.

  @button removearmor
  Remove Armor

  @button poolside
  Keep Armor

  @location removearmor
  ^dives = dives - 1
  ^armoroff = 1
  You remove your gear and tie it up in a bundle so you can grab it quick.

  @button poolside
  Continue

  @location divenear
  ^breath = breath - 1
  The bottom here near the west edge of the pool is heavily trodden. Perhaps the devotees enter the pool here during rituals. There is nothing but mud and murk here, though.

  @button northwest
  Swim Northeast

  @button center
  Swim East

  @button southbottom
  Swim Southeast

  @location diveidol
  ^breath = breath - 1
  The water here is clear and the bottom covered with plants. Among them you can see many, many newts swimming about. No sign of the necklace, though.

  @button northwest
  Swim Southwest

  @button center
  Swim South

  @button northeast
  Swim Southeast

  @location divehole
  ^necklace = breath - 1
  You swim over to where you saw the deep hole and dive, struggling to get as far down into the darkness as possible. Sure enough, you see the glint of bright metal through the murk. You grab it and toward the surface, lungs burning...

  @button surfacecheck
  Continue

  @location wadenear
  @remember wadenear
  ^breath = 3 -> surfacecheck
  Here are the west end of the pool there are stepping stones under the water.

  @button wadeidol
  Wade around to the Idol

  @button wadefar
  Wade around near the Weeds

  @if holeknown
  @button wadehole
  Wade around to the Deep Hole

  @button divenear
  Dive Here

  @location wadeidol
  @remember wadeidol
  ^breath = 3 -> surfacecheck
  Standing in the water at the north edge of the pool you get a good look at the Newt God Idol. It's carved from wood and is mostly naturalistic, though it is standing upright and holding a spear.

  @button wadenear
  Wade around to the West

  @button wadefar
  Wade around near the Weeds

  @if holeknown
  @button wadehole
  Wade around to the Deep Hole

  @button diveidol
  Dive Here

  @location wadefar
  @remember wadefar
  ^breath = 3 -> surfacecheck
  You are wading near the east end of the pool where the water weeds grow. They are thick and slimy. It might be tough to find a necklace in all that.

  @button wadenear
  Wade around to the West

  @button wadeidol
  Wade around to the Idol

  @button divefar
  Dive Here

  @if holeknown
  @button wadehole
  Wade around to the Deep Hole

  @location wadehole
  @remember wadehole
  ^breath = 3 -> surfacecheck
  You are near the spot where you think the deep hole is.

  @button wadenear
  Wade around to the West

  @button wadeidol
  Wade around to the Idol

  @button wadefar
  Wade around near the Weeds

  @button divehole
  Dive Here

  @branch surfacecheck
  ( swimming && armor < 3 ) || ( swimming > 2 && 3d < st - armor ) || ( !swimming && 3d < ST - ( 2 * armor ) ) || ( !swimming && 4d < ST - ( 2 * armor ) )
  @destinationTrue: surfacing
  @destinationFalse: drowned

  @location surfaced
  ^dives = dives - 1
  You make it back to the surface, gasping. You catch your breath and think about your next move.

  @button return
  Continue

  @location drowned
  The water was too much for you. You struggle, but cannot get back to the surface. You become another offering to the newt god.

  @location divefar
  ^breath = breath - 1
  The bottom here is covered in weeds, but despite your misapprehension you can tell the necklace is not here.

  @button northeast
  Swim Northwest

  @button center
  Swim West

  @button southbottom
  Swim Southwest

  @location northwest
  ^breath = breath - 1
  The bottom here is relatively clear. While there are a few random oddments that were probably thrown in as offerings the necklace is not among them.

  @button divenear
  Swim Southwest

  @button center
  Swim Southeast

  @button diveidol
  Swim Northeast

  @location center
  ^breath = breath - 1
  You're probably near the center of the pool. You can see the decaying remnants of previous offerings: a wagon wheel, a broken jar, what is probably a plow. But no necklace.

  @button divenear
  Swim West

  @button northwest
  Swim Northwest

  @button diveidol
  Swim North

  @button northeast
  Swim Northeast

  @button divefar
  Swim East

  @button southbottom
  Swim South

  @location southbottom
  ^breath = breath - 1
  ^holeknown = 1
  As you survey the bottom you notice a deep, deep hole at the south end of the pool.

  @button divenear
  Swim Northwest

  @button center
  Swim North

  @button divefar
  Swim Northeast

  @button trydeephole
  Swim into the Deep Hole

  @branch surfacing
  necklace > 0
  @destinationTrue: goodending
  @destinationFalse: surfaced

  @location northeast
  ^breath = breath - 1
  The bottom here is relatively clear. It's easy to determine that the necklace is not here.

  @button divefar
  Swim Southeast

  @button diveidol
  Northwest

  @button center
  Swim Southwest

  @location trydeephole
  You try to get to the bottom of the hole, but you run out of breath...

  @button surfacecheck
  Continue






</div>



<div style='display: none;' id='wilfurd'>

  @title The Invisible Amulet
  @creator Wilford the Wise
  @maxattributes 32
  @description You can't loot what you can't see.

  ^treasurelocation = 1d
  ^seeinvisible = -1
  ^seenmessage = 0
  ^amulet = 0

  @location startlocation
  Wilfurd the Wise can be a little anti-social. He stole the duchess's amulet, made it invisible, and hid it in an old cavern, used long ago by strange wizards. This was an odd move, since this cavern is reputed to hold a fountain which supposedly gives the very temporary ability to see the invisible. So far, however, no one can find the fountain, much less the amulet, though many have gone through the cavern to find it unguarded. Wilfurd is up to something, but what?

  You decide to see if you can get to the bottom of this and win some favor with the duchess.

  @button firstroom
  Enter

  @location firstroom
  ^seeinvisible = seeinvisible - 1
  This first room is octagonal with a strangely smooth floor. There is a large unfinished passageway leading west to the outside, and a finely finished passage way heading east, further into the cavern. There is a low, narrow passage heading north.

  @if seeinvisible>0
  You see the floor is actually covered in intertwining glyphs and symbols etched in crimson, emerald, violet, and gold form a large circular pattern, pulsing faintly with residual arcane energy from past ritual magic.
  @if seenmessage
  Now that you know what to look for, the secret door on the south wall is plain as day.
  @button backtostart
  Leave

  @button junctionroom
  Go East

  @button messageroom
  Go North

  @if seenmessage
  @button fountainroom
  Go South

  @location messageroom
  ^seeinvisible = seeinvisible - 1
  ^seenmessage = 1
  The walls of this small plain chamber have bas reliefs of people in strange attire performing bizarre actions. This must be a record of the ancient wizards, but their magic is so old none of the the vignettes make any sense.

  One panel is not so mysterious: a robed figure is opening a secret door in the south side of a eight-sided room by pressing a certain decoration...

  @if seeinvisible > 0
  You ability to see the invisible allows you to see a fresco that depicts a radiant figure placing their hand on a glowing mark, surrounded by faint, shimmering outlines of unseen beings, suggesting that touching the illuminated spot grants an extended ability to see the invisible.
  @button firstroom
  South the Entry Room

  @if seeinvisible>0 && seeinvisible < 7
  @button longerduration
  Touch the Artwork

  @location fountainroom
  This round room has no other doors than the one you entered from the north, and as far as you can tell no ceiling - it seems to go upward forever.

  In the center of the room is a fountain of crystal-clear water quietly bubbling beneath a worn, rune-etched pedestal, its soft glow hinting at the lingering magic of wizards long past, granting those who drink from it the fleeting ability to see the invisible.

  Well, it's *a* fountain. Perhaps it is *the* fountain that gives the ability to see the invisible, which would be a great help in finding the amulet. Or it could be fountain of poison. Or just a fountain.

  Only one way to find out.

  @button firstroom
  North to Octogon

  @button drink
  Take a Drink

  @location drink
  ^seeinvisible = 3 -> loseability
  The water tastes pretty good, and you feel pretty good. And you can see some bas relief on the wall that you could not see before. It seems like this is the legendary fountain. It may not last forever, but for now it seems like you can see the unseeable.

  @button fountainroom
  Continue

  @location junctionroom
  ^seeinvisible = seeinvisible - 1
  This large, featureless room has doors in the four cardinal directions. West is the vestibule...

  @if seeinvisible > 0
  Between the doors the walls are covered in geometric carvings.
  @if seeinvisible < 1
  The walls between the doors are plain.
  @button northroom
  Go North

  @button eastroom
  Go East

  @button guardianappears
  Go West

  @button southroom
  Go South

  @branch northroom
  treasurelocation < 3 && seeinvisible > 0
  @destinationTrue: northroomtreasure
  @destinationFalse: northroomempty

  @branch southroom
  treasurelocation > 2 && treasurelocation <  5 && seeinvisible > 0
  @destinationTrue: southroomtreasure
  @destinationFalse: southroomempty

  @branch eastroom
  treasurelocation > 4 && seeinvisible > 0
  @destinationTrue: eastroomtreasure
  @destinationFalse: eastroomempty

  @location northroomtreasure
  ^seeinvisible = seeinvisible - 1
  ^amulet = 1
  This is a big, clean, empty room. You barely spot the amulet as your ability to see the invisible fades. It's hanging on the wall, next to the door, then it's in your hand.

  @button junctionroom
  Head South to Junction Room

  @location northroomempty
  ^seeinvisible = seeinvisible - 1
  This is a big, clean, empty room. You feel around on the floor everywhere, but don't find anything invisible.

  @button junctionroom
  Back South

  @location southroomtreasure
  ^seeinvisible = seeinvisible - 1
  ^amulet = 1
  This room is full of the crumbling remains of barrels. Searching takes some time, but you find the amulet in a corner just as your ability to see the invisible fades.

  @button junctionroom
  Head North To Junction Room

  @location southroomempty
  ^seeinvisible = seeinvisible - 1
  This room is full of the crumbling remains of barrels. Searching this rubbish for something you can't see takes some time, but you can't find anything.

  @button junctionroom
  Head North To Junction Room

  @location eastroomtreasure
  ^seeinvisible = seeinvisible - 1
  ^amulet = 1
  This must have been some kind of storeroom, since it is full if empty shelves. Just as your ability to see the invisible fades you spot the amulet hanging from the end of a shelf! You grab it.

  @button junctionroom
  Head West To Junction Room

  @location eastroomempty
  ^seeinvisible = seeinvisible - 1
  This seems to have been some kind of storeroom - it is filled with empty shelves. You search and even feel around on the shelves, but you find nothing.

  @button junctionroom
  Head West To Junction Room

  @location loseability
  You sense that your ability to see the invisible has faded away.

  @button lastlocation
  Continue

  @branch backtostart
  amulet > 0
  @destinationTrue: win
  @destinationFalse: tryagain

  @location win
  You found the amulet and escaped with your life. The duchess will be most pleased, you will probably get a nice thank you note!

  @location tryagain
  You step out into the daylight and realize that you have not given this your best shot.

  @button firstroom
  Head Back In

  @branch guardianappears
  amulet > 0
  @destinationTrue: sightlessswordsman
  @destinationFalse: firstroom

  @foe sightlessswordsman
  As you enter the vestibule you see a swordsman standing before you, shouting that as the guardian of the amulet he will not let you remove it from the cavern. On the one hand, he has a broadsword and shield and he is between you and the door. On the other hand, he's wearing a blindfold...
  @type -1
  Sightless Swordsman
  ST 12, DX 5, IQ 5, MA 10
  Armor: 2
  Weapons: primary (2d), secondary ()
  @range 2
  @xp 20
  @winDestination sightlessswordsmandefeated
  @loseDestination sightlessswordsmanvictorious
  @noFoe sightlessswordsmanmissing

  @location sightlessswordsmanvictorious
  The Sightless Swordsman is victorious, the game is at an end.

  @location sightlessswordsmanmissing
  The Sightless Swordsman is not present...

  @button firstroom
  Continue

  @location sightlessswordsmandefeated
  You have defeated the Sightless Swordsman!

  @button firstroom
  Continue

  @location longerduration
  ^seeinvisible = 9999 ->
  You place your hand on the artwork in the suggested way and feel the same thing you felt when you drank from the fountain. - nothing. At least it's not a trap.

  @button messageroom
  Continue




</div>


<div style='display: none;' id='tomb'>
</div>

<div style='display: none;' id='towerGoblin'>



  @title The Goblin In The Tower
  @creator Grimble Thornspire
  @maxattributes 32
  @description You must fight Grimnash, but he has the high ground.


  @location startlocation
  Grimnash Snarefang has always been a malicious troublemaker, but now he's gone to far. He's in the second story window of a broken-down watchtower along the road outside of town shooting arrows at passers by. A couple of people have been hurt, the road is effectively closed, and folks are looking to you to do something about him.

  He's had this coming for some time!

  @button behindthetree
  Continue


  @location behindthetree
  You head off the road as you approach the tower, keeping a particular tree between you and the miscreant. When you reach the tree you can hear him shouting at you. There's some distance between your cover and the tower, he will probably be able to get off more than one shot.

  @if bow || crossbow
  Grimnash is using the loopholes on the second floor, you won't be able to shoot him.

  You see you have three ways to approach him. You can run straight at the front door and hope he misses. You can zig-zag to the door and see if you can make him miss, though he might get off an extra shot, or you can sneak around through the trees and get closer to the tower from the other side.

  @button runcheck1
  Run For The Door

  @button dodgecheck1
  Dodge To The Door

  @button throughthetrees
  Sneak Through The Trees


  @branch runcheck1
  3d < 9
  @destinationTrue: runhit1
  @destinationFalse: runmiss1

  @location runhit1
  @damage 1d deathbyarrow
  His first arrow hits you for ^LASTACTION points of damage, and he's already knocking another...

  @button runcheck2
  Continue


  @location runmiss1
  His first arrow misses you, this just might work...

  @button runcheck2
  Continue


  @branch runcheck2
  3d < 11
  @destinationTrue: runhit2
  @destinationFalse: runmiss2

  @location runhit2
  @damage 1d deathbyarrow
  His second arrow hits you for ^LASTACTION points of damage, maybe dodging would have been smarter, but you made it to the doorway.

  @button doorway
  Continue


  @location runmiss2
  His second arrow misses you, you made it to the door.

  @button doorway
  Continue


  @branch dodgecheck1
  4d < 9
  @destinationTrue: dodgehit1
  @destinationFalse: dodgemiss1

  @location dodgehit1
  @damage 1d deathbyarrow
  His first arrow hits you for ^LASTACTION points of damage, and he's already knocking another...

  @button dodgecheck2
  Continue


  @location dodgemiss1
  His first arrow misses you, this just might work...

  @button dodgecheck2
  Continue


  @branch dodgecheck2
  4d < 11
  @destinationTrue: dodgehit2
  @destinationFalse: dodgemiss2

  @location dodgehit2
  @damage 1d deathbyarrow
  His second arrow hits you for ^LASTACTION points of damage, maybe running would have been smarter...

  @button dodgecheck3
  Continue


  @location dodgemiss2
  His second arrow misses you, there's one more to come.

  @button dodgecheck3
  Continue


  @location doorway
  Standing in the doorway you are safe from above, from whence you can hear Grimnash swearing in Goblin.

  @button firstfloor
  Head Inside

  @button backoftower
  Slip Around Back


  @location deathbyarrow
  You died from arrow wounds. The town will have to find someone else to rid themselves of the little scourge.


  @location throughthetrees
  As you sneak through the trees you see that Grimnash is looking all around, he has lost track of you. Once you are out of his line of sight you sneak up to the base of the tower. There are some vines on the back side, possibly you could climb up to the third floor and surprise him by coming down the stairs. Or you could keep close to the tower so he can't shoot at you and slip around to the front door.

  @if armor > 1
  Your armor would make the climb quite difficult.
  @button climbcheck
  Climb Up Vines

  @button rockcheck
  Sneak Around Front


  @branch rockcheck
  3d < adjdx
  @destinationTrue: rockmissed
  @destinationFalse: rockhit

  @branch climbcheck
  3d <= adjdx - armor + ( climbing * 4 )
  @destinationTrue: topoftower
  @destinationFalse: fell

  @location rockmissed
  As you proceed a sizable block of stone plummets from above, barely missing you. It looks like Grimnash has found you.

  You hurry forward to the safety of the door.

  @button doorway
  continue


  @location rockhit
  @damage 2d diedfromrock
  A sizable chunk of the tower falls from above and hits you pretty hard for ^LASTACTION points of damage. You hear goblin laughter.

  You hurry on to the safety of the doorway before Grimnash can drop another block on you.

  @button doorway
  Continue


  @location topoftower
  You haul yourself over the parapet just as the vines start to pull away from the ancient blocks. Catching your breath, you draw your weapon before heading for the rickety stairs.

  @button secondfloor
  Proceed Downstairs


  @location fell
  @damage 2d diedfromfall
  You fell and took ^LASTACTION points of damage.

  @button backoftower
  Continue


  @location diedfromfall
  Twenty five feet up the vines rip the timeworn stone blocks apart, and you fall to your death.


  @location diedfromrock
  You hear Grimnash shout something in Goblin and look up to see a giant rock falling straight at you. It does ^LASTACTION points of damage, which is enough to end this adventure and you.


  @location backoftower
  You are behind the tower.

  @button climbcheck
  Climb Up Vines

  @button rockcheck
  Sneak Around Front


  @location firstfloor
  The ground floor room of the tower is littered with fallen beams, the remains of old fires, and general rubbish. The stairs look solid enough, if you proceed carefully.

  @button secondfloor
  Proceed Upstairs


  @location secondfloor
  As you step onto the second floor you see that Grimnash has put down his bow and quiver and draw his small sword.

  @button grimnash
  Fight Grimnash

  @button firstfloor
  Run Back Downstairs


  @foe grimnash
  A you step off the stairs you see that Grimnash has set aside his bow and drawn his small sword.
  @type 0
  Grimnash
  ST 9, DX 12, IQ 11, MA 10
  Armor: 0
  Weapons: primary (1d), secondary ()
  @range 4
  @xp 30
  @winDestination grimnashdefeated
  @loseDestination grimnashvictorious
  @noFoe grimnashmissing

  @location grimnashvictorious
  Grimnash is victorious, the game is at an end.


  @location grimnashmissing
  Grimnash is not present. Since there's no way to remove him, we should never arrive at this location.


  @location grimnashdefeated
  You have defeated Grimnash!

  You tie his hands together and prepare to haul his unconscious form back to town for trial when he has healed up a bit.


  @branch dodgecheck3
  4d < 13
  @destinationTrue: dodgehit3
  @destinationFalse: dodgemiss3

  @location dodgehit3
  @damage 1d deathbyarrow
  His third arrow hits you for ^LASTACTION points of damage, but you made it to the door.

  @button doorway
  Continue


  @location dodgemiss3
  His third arrow misses you and you make it to the doorway!

  @button doorway
  Continue






</div>


<div id="generalFaultDiv" style="display: none; position: fixed; top: 30%; left: 30%; right: 30%; border: solid thick; background-color: lightgrey; color:black; padding: 3.5vh; overflow: auto; z-index: 999;">
  <div id="generalFaultMessage">
  </div>

  <span class="niftyButton" onclick = "document.getElementById('generalFaultDiv').style.display='none';" >Argh, Okay</span>

</div>

<div id="createFirstLaterDiv" style="display: none; position: fixed; top: 30%; left: 30%; right: 30%; border: solid thick; background-color: lightgrey; color:black; padding: 3.5vh; overflow: auto; z-index: 999;">
  <div id="a">
    Enter a name for the new location. A branch will be created with that name, along with a location called placeFirst, a location called placeLater, and a variable called placeVisited. The variable will be initialized at 0, and set to 1 the first time the place is visited.
  </div>

  <textArea rows=1 cols=20 id='newFirstLaterName' onkeyup='flKeyup(event);'></textArea>

  <span class="niftyButton" onclick = "actuallyAddFirstLater()" >Create It!</span>

  <span class="niftyButton" onclick = "document.getElementById('createFirstLaterDiv').style.display='none';" >Never Mind</span>

</div>

<div id="alreadyGotOne" style="display: none; position: fixed; top: 30%; left: 30%; right: 30%; border: solid thick; background-color: lightgrey; color:black; padding: 3.5vh; overflow: auto; z-index: 1001;">
  <div id="a">
    There is already a location with that name. Create a new name or Never mind.<br><br><br><br><br>
  </div>

  <div style='text-align: center;'>
    <span class="niftyButton" onclick = "document.getElementById('alreadyGotOne').style.display='none';">Okay</span>
  </div>
</div>

<div id="confirmClear" style="display: none; position: fixed; top: 30%; left: 30%; right: 30%; border: solid thick; background-color: red; color:black; padding: 3.5vh; overflow: auto; z-index: 1001;">
  <div id="a">
    Are you sure? This will delete everything and cannot be undone.<br><br><br><br>
  </div>

  <div style='text-align: center;'>
    <span class="niftyButton" onclick = "document.getElementById('alreadyGotOne').style.display='none';">
      Clear It All
    </span>
    <span class="niftyButton" onclick = "document.getElementById('confirmClear').style.display='none';">
      Never Mind
    </span>
  </div>
</div>


<div id="addNewFoeDiv" style="display: none; position: fixed; top: 30%; left: 30%; right: 30%; border: solid thick; background-color: bisque; color:black; padding: 3.5vh; overflow: auto; z-index: 999;">
  <div id="a">
    Enter a name for the new foe. There will also be locations created for player victory, player defeat (the end of the game, presumably), and a location to go if the foe is missing, having been removed by a Remove Foe action.
  </div>

  <textArea rows=1 cols=20 id='newFoeNameTextArea' onkeyup='addFoeKeyup(event);'></textArea>

  <span class="niftyButton" onclick = "visAddFoe()" >Create It!</span>

  <span class="niftyButton" onclick = "document.getElementById('addNewFoeDiv').style.display='none';" >Never Mind</span>

</div>

<script src="fnorder.js">
</script>

</body>

</html>
